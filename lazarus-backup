#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
VERSION="4.6.1-clean-notify"
SCRIPT_NAME="lazarus"
INSTALL_DIR="/opt/lazarus-backup"
BACKUP_DIR="$INSTALL_DIR/backup"
CONFIG_FILE="$INSTALL_DIR/config.env"
SYMLINK_PATH="/usr/local/bin/$SCRIPT_NAME"
RETAIN_BACKUPS_DAYS=7

# --- –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê –î–õ–Ø –ü–û–ò–°–ö–ê ---
KEYWORDS=("remnawave" "telegram-shop" "shop-bot" "shopbot")

# --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
BOT_PATH=""
BOT_TOKEN=""
CHAT_ID=""
TG_MESSAGE_THREAD_ID=""
DB_USER="postgres"
IGNORE_MISMATCH="false"
EXCLUDE_DIRS=""
MAX_FILE_SIZE_MB="1"

# –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
BOT_CONTAINER_NAME="" 
DB_CONTAINER_NAME=""
DEFAULT_BOT_PATH="/opt/private-remnawave-telegram-shop-bot"
DEFAULT_DB_NAME="remnawave-telegram-shop-db"
DB_VOLUME_NAME="remnawave-telegram-shop-db-data"
DB_SERVICE_NAME="db" 

# –°—Ç–∞—Ç—É—Å—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
SCHEDULE_FULL="–í—ã–∫–ª"
SCHEDULE_DB="–í—ã–∫–ª"
SCHEDULE_FILES="–í—ã–∫–ª"

# –¶–≤–µ—Ç–∞
if [[ -t 0 ]]; then
    RED=$'\e[31m'; GREEN=$'\e[32m'; YELLOW=$'\e[33m'; GRAY=$'\e[90m'; CYAN=$'\e[36m'; MAGENTA=$'\e[35m'; RESET=$'\e[0m'; BOLD=$'\e[1m'
else
    RED=""; GREEN=""; YELLOW=""; GRAY=""; CYAN=""; MAGENTA=""; RESET=""; BOLD=""
fi

# --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

print_message() {
    local type="$1"; local message="$2"; local color_code="$RESET"
    case "$type" in
        "INFO") color_code="$GRAY" ;;
        "SUCCESS") color_code="$GREEN" ;;
        "WARN") color_code="$YELLOW" ;;
        "ERROR") color_code="$RED" ;;
        "ACTION") color_code="$CYAN" ;;
    esac
    echo -e "${color_code}[$type]${RESET} $message"
}

escape_markdown_v2() {
    echo "$1" | sed -e 's/\\/\\\\/g' -e 's/_/\\_/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' \
        -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\~/g' -e 's/`/\\`/g' -e 's/>/\\>/g' \
        -e 's/#/\\#/g' -e 's/+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/|/\\|/g' \
        -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\./\\./g' -e 's/!/\!/g'
}

# --- –°–ò–°–¢–ï–ú–ê –£–°–¢–ê–ù–û–í–ö–ò ---

install_script() {
    if [[ "$EUID" -ne 0 ]]; then
        echo -e "${RED}–û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)!${RESET}"
        exit 1
    fi

    local CURRENT_SCRIPT_PATH=$(realpath "$0")
    local INSTALLED_SCRIPT_PATH="$INSTALL_DIR/$SCRIPT_NAME"

    if [[ "$CURRENT_SCRIPT_PATH" != "$INSTALLED_SCRIPT_PATH" ]]; then
        echo -e "${CYAN}--- –£–°–¢–ê–ù–û–í–ö–ê LAZARUS BACKUP ---${RESET}"
        if [[ ! -d "$INSTALL_DIR" ]]; then
            mkdir -p "$INSTALL_DIR"
            print_message "SUCCESS" "–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: $INSTALL_DIR"
        fi
        cp "$CURRENT_SCRIPT_PATH" "$INSTALLED_SCRIPT_PATH"
        chmod +x "$INSTALLED_SCRIPT_PATH"
        
        if [[ -L "$SYMLINK_PATH" || -f "$SYMLINK_PATH" ]]; then rm -f "$SYMLINK_PATH"; fi
        ln -s "$INSTALLED_SCRIPT_PATH" "$SYMLINK_PATH"
        
        print_message "SUCCESS" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞–ø—É—Å–∫..."
        echo ""
        exec "$INSTALLED_SCRIPT_PATH"
        exit 0
    fi
}

# --- –£–î–ê–õ–ï–ù–ò–ï –°–ö–†–ò–ü–¢–ê ---

uninstall_script() {
    clear
    echo -e "${RED}${BOLD}–£–î–ê–õ–ï–ù–ò–ï –°–ö–†–ò–ü–¢–ê${RESET}"
    echo "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å LAZARUS Backup Manager."
    echo ""
    
    read -erp "–ù–∞–ø–∏—à–∏—Ç–µ 'yes' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (Enter - –û—Ç–º–µ–Ω–∞): " confirm
    
    if [[ "$confirm" != "yes" ]]; then
        print_message "INFO" "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
        read -erp "Enter..." dummy
        return
    fi

    echo ""
    read -erp "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –±—ç–∫–∞–ø—ã —Å –¥–∏—Å–∫–∞? (y/N): " del_backups

    (crontab -l 2>/dev/null | grep -v "$SCRIPT_NAME") | crontab -
    print_message "SUCCESS" "–ó–∞–¥–∞—á–∏ Cron —É–¥–∞–ª–µ–Ω—ã."

    rm -f "$SYMLINK_PATH"
    print_message "SUCCESS" "–°–∏–º–ª–∏–Ω–∫ —É–¥–∞–ª–µ–Ω."

    if [[ "$del_backups" =~ ^[Yy]$ ]]; then
        rm -rf "$INSTALL_DIR"
        print_message "SUCCESS" "–°–∫—Ä–∏–ø—Ç, –∫–æ–Ω—Ñ–∏–≥ –∏ –ë–≠–ö–ê–ü–´ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã."
    else
        rm -f "$INSTALL_DIR/$SCRIPT_NAME" "$CONFIG_FILE"
        rmdir "$BACKUP_DIR" 2>/dev/null
        rmdir "$INSTALL_DIR" 2>/dev/null
        print_message "SUCCESS" "–°–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω."
        if [[ -d "$BACKUP_DIR" ]]; then
            print_message "WARN" "–í–∞—à–∏ –±—ç–∫–∞–ø—ã –æ—Å—Ç–∞–ª–∏—Å—å –≤ –ø–∞–ø–∫–µ: $BACKUP_DIR"
        fi
    fi
    echo ""
    exit 0
}

# --- –Ø–î–†–û –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê ---

scan_system_for_bot() {
    FOUND_PATH=""
    FOUND_BOT=""
    FOUND_DB=""

    local running_containers=$(docker ps --format '{{.Names}}|{{.Image}}')
    
    for container in $running_containers; do
        local c_name=$(echo "$container" | cut -d'|' -f1)
        local c_image=$(echo "$container" | cut -d'|' -f2)
        
        for key in "${KEYWORDS[@]}"; do
            if [[ "$c_image" == *"$key"* ]]; then
                FOUND_BOT="$c_name"
                local work_dir=$(docker inspect --format '{{ index .Config.Labels "com.docker.compose.project.working_dir" }}' "$c_name")
                if [[ -n "$work_dir" && -d "$work_dir" ]]; then
                    FOUND_PATH="$work_dir"
                fi
                break 2
            fi
        done
    done

    if [[ -z "$FOUND_PATH" ]]; then
        local search_dirs=("/opt" "/home" "/root")
        local compose_files=$(find "${search_dirs[@]}" -maxdepth 4 -name "docker-compose.yml" -o -name "compose.yaml" 2>/dev/null)
        
        for file in $compose_files; do
            if grep -qE "image:.*($(IFS="|"; echo "${KEYWORDS[*]}"))" "$file" || grep -qE "container_name:.*($(IFS="|"; echo "${KEYWORDS[*]}"))" "$file"; then
                FOUND_PATH=$(dirname "$file")
                FOUND_BOT=$(grep "container_name:" "$file" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
                break
            fi
        done
    fi

    if [[ -n "$FOUND_PATH" ]]; then
        if cd "$FOUND_PATH" 2>/dev/null; then
            local db_services=("db" "postgres" "database" "postgresql")
            for svc in "${db_services[@]}"; do
                local db_c=$(docker compose ps -a --format '{{.Name}}' "$svc" 2>/dev/null)
                if [[ -n "$db_c" ]]; then
                    FOUND_DB="$db_c"
                    break
                fi
            done
            cd - >/dev/null
        fi
    fi
}

# --- –§–£–ù–ö–¶–ò–ò –í–ï–†–°–ò–ò –ò –ü–û–ò–°–ö–ê ---

get_raw_bot_version() {
    if [[ -n "$BOT_CONTAINER_NAME" ]] && docker container inspect -f '{{.State.Running}}' "$BOT_CONTAINER_NAME" &>/dev/null; then
        local full_image=$(docker inspect -f '{{.Config.Image}}' "$BOT_CONTAINER_NAME")
        local ver="${full_image##*:}"
        echo "${ver:-Unknown}"
    else
        echo ""
    fi
}

get_bot_version_display() {
    local ver=$(get_raw_bot_version)
    if [[ -n "$ver" ]]; then echo "$ver"; else echo "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ / –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; fi
}

detect_bot_installation() {
    print_message "INFO" "–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞..."
    scan_system_for_bot 
    if [[ -n "$FOUND_PATH" ]]; then
        echo ""; print_message "SUCCESS" "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞!"
        echo -e "   –ü—É—Ç—å:      ${BOLD}$FOUND_PATH${RESET}"
        [[ -n "$FOUND_BOT" ]] && echo -e "   –ë–æ—Ç:       ${BOLD}$FOUND_BOT${RESET}"
        [[ -n "$FOUND_DB" ]]  && echo -e "   –ë–î:        ${BOLD}$FOUND_DB${RESET}"
        echo ""
        read -erp "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? (Y/n): " confirm
        if [[ -z "$confirm" || "$confirm" =~ ^[Yy]$ ]]; then
            BOT_PATH="$FOUND_PATH"
            if [[ -n "$FOUND_BOT" ]]; then BOT_CONTAINER_NAME="$FOUND_BOT"; fi
            if [[ -n "$FOUND_DB" ]]; then DB_CONTAINER_NAME="$FOUND_DB"; fi
            save_config; print_message "SUCCESS" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."; return 0
        fi
    fi
    print_message "WARN" "–ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
    return 1
}

# --- –ü–†–û–í–ï–†–ö–ê –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ô ---

check_config_mismatch() {
    if [[ -n "$BOT_CONTAINER_NAME" && "$IGNORE_MISMATCH" != "true" ]]; then
        if ! docker inspect "$BOT_CONTAINER_NAME" &>/dev/null; then
            scan_system_for_bot
            if [[ -n "$FOUND_BOT" && "$FOUND_BOT" != "$BOT_CONTAINER_NAME" ]]; then
                echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$BOT_CONTAINER_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–∞–π–¥–µ–Ω '$FOUND_BOT'."
                echo -e " ${GREEN}–ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.${RESET}"
                read -erp "–û–±–Ω–æ–≤–∏—Ç—å? (Y/n): " upd
                if [[ -z "$upd" || "$upd" =~ ^[Yy]$ ]]; then
                    BOT_CONTAINER_NAME="$FOUND_BOT"
                    [[ -n "$FOUND_DB" ]] && DB_CONTAINER_NAME="$FOUND_DB"
                    [[ -n "$FOUND_PATH" ]] && BOT_PATH="$FOUND_PATH"
                    save_config; print_message "SUCCESS" "–û–±–Ω–æ–≤–ª–µ–Ω–æ."; sleep 1
                else
                    IGNORE_MISMATCH="true"; save_config
                fi
            fi
        fi
    fi
}

ensure_bot_path() {
    if [[ -z "$BOT_CONTAINER_NAME" || -z "$DB_CONTAINER_NAME" ]]; then
        echo ""; print_message "WARN" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—É—Å—Ç—ã."
        detect_bot_installation; load_or_create_config 
    fi

    local path_valid=false
    if [[ -n "$BOT_PATH" && -d "$BOT_PATH" && ( -f "$BOT_PATH/docker-compose.yml" || -f "$BOT_PATH/compose.yaml" ) ]]; then path_valid=true; fi
    local container_valid=false
    if [[ -n "$BOT_CONTAINER_NAME" ]] && docker inspect "$BOT_CONTAINER_NAME" &>/dev/null; then container_valid=true; fi
    local db_valid=false
    if [[ -n "$DB_CONTAINER_NAME" ]] && docker inspect "$DB_CONTAINER_NAME" &>/dev/null; then db_valid=true; fi

    if [[ "$path_valid" == "false" || "$container_valid" == "false" || "$db_valid" == "false" ]]; then
        if [[ "$path_valid" == "false" ]]; then
            detect_bot_installation; load_or_create_config
            if [[ -n "$BOT_PATH" ]]; then path_valid=true; fi
            if [[ -n "$BOT_CONTAINER_NAME" ]]; then container_valid=true; fi
            if [[ -n "$DB_CONTAINER_NAME" ]]; then db_valid=true; fi
        fi

        if [[ -z "$BOT_PATH" || ! -d "$BOT_PATH" ]]; then
            echo ""; print_message "ACTION" "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –±–æ—Ç–∞ –≤—Ä—É—á–Ω—É—é."
            read -erp "–ü—É—Ç—å (Enter –¥–ª—è '$DEFAULT_BOT_PATH'): " input_path
            BOT_PATH="${input_path:-$DEFAULT_BOT_PATH}"
            if [[ ! -d "$BOT_PATH" ]]; then print_message "ERROR" "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; return 1; fi
            save_config
        fi

        if [[ -z "$BOT_CONTAINER_NAME" ]] || ! docker inspect "$BOT_CONTAINER_NAME" &>/dev/null; then
            echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω."
            print_message "ACTION" "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞ (–∫–∞–∫ –≤ 'docker ps')."
            read -erp "–ò–º—è: " input_name
            if [[ -n "$input_name" ]]; then BOT_CONTAINER_NAME="$input_name"; else BOT_CONTAINER_NAME="shopbot"; fi
            save_config
        fi

        if [[ -z "$DB_CONTAINER_NAME" ]] || ! docker inspect "$DB_CONTAINER_NAME" &>/dev/null; then
            echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω."
            print_message "ACTION" "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î (–∏–ª–∏ Enter –¥–ª—è '$DEFAULT_DB_NAME')."
            read -erp "–ò–º—è –ë–î: " input_db
            if [[ -n "$input_db" ]]; then DB_CONTAINER_NAME="$input_db"; else DB_CONTAINER_NAME="$DEFAULT_DB_NAME"; fi
            save_config
        fi
    fi
    return 0
}

save_config() {
    mkdir -p "$INSTALL_DIR"
    cat > "$CONFIG_FILE" <<EOF
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
TG_MESSAGE_THREAD_ID="$TG_MESSAGE_THREAD_ID"
BOT_PATH="$BOT_PATH"
DB_USER="$DB_USER"
SCHEDULE_FULL="$SCHEDULE_FULL"
SCHEDULE_DB="$SCHEDULE_DB"
SCHEDULE_FILES="$SCHEDULE_FILES"
RETAIN_BACKUPS_DAYS="$RETAIN_BACKUPS_DAYS"
BOT_CONTAINER_NAME="$BOT_CONTAINER_NAME"
DB_CONTAINER_NAME="$DB_CONTAINER_NAME"
IGNORE_MISMATCH="$IGNORE_MISMATCH"
EXCLUDE_DIRS="$EXCLUDE_DIRS"
MAX_FILE_SIZE_MB="$MAX_FILE_SIZE_MB"
EOF
    chmod 600 "$CONFIG_FILE"
}

load_or_create_config() {
    if [[ -f "$CONFIG_FILE" ]]; then source "$CONFIG_FILE"; fi
    if [[ -z "$RETAIN_BACKUPS_DAYS" ]]; then RETAIN_BACKUPS_DAYS=7; fi
    if [[ -z "$IGNORE_MISMATCH" ]]; then IGNORE_MISMATCH="false"; fi
    if [[ -z "$MAX_FILE_SIZE_MB" ]]; then MAX_FILE_SIZE_MB="1"; fi
    mkdir -p "$BACKUP_DIR"

    local updated=false
    if [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]]; then
        echo ""; print_message "WARN" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
        [[ -z "$BOT_TOKEN" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ Bot Token: " BOT_TOKEN
        [[ -z "$CHAT_ID" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ Chat ID: " CHAT_ID
        [[ -z "$TG_MESSAGE_THREAD_ID" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ ID —Ç–æ–ø–∏–∫–∞ (–∏–ª–∏ Enter): " TG_MESSAGE_THREAD_ID
        updated=true
    fi
    
    if [[ -z "$BOT_PATH" || -z "$BOT_CONTAINER_NAME" || -z "$DB_CONTAINER_NAME" ]]; then 
        detect_bot_installation
    fi
    
    if $updated; then save_config; fi
}

send_telegram_document() {
    local file_path="$1"; local caption="$2"
    [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]] && return 1
    
    print_message "INFO" "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram..."
    
    local form_params=(-F chat_id="$CHAT_ID" -F document=@"$file_path" -F parse_mode="MarkdownV2" -F caption="$(escape_markdown_v2 "$caption")")
    [[ -n "$TG_MESSAGE_THREAD_ID" ]] && form_params+=(-F message_thread_id="$TG_MESSAGE_THREAD_ID")
    
    local http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" "${form_params[@]}")
    
    if [[ "$http_code" == "200" ]]; then
        print_message "SUCCESS" "–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram."
    else
        local file_size=$(stat -c%s "$file_path" 2>/dev/null || echo 0)
        
        if [[ $file_size -ge 52428800 ]]; then
            print_message "ERROR" "–§–∞–π–ª >50MB. Telegram API –æ—Ç–∫–ª–æ–Ω–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É."
            local error_msg="‚ö†Ô∏è *–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ç–∫–∞–ø–∞*

–§–∞–π–ª –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ 50 –ú–ë\. Telegram Bot API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–∞–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é\.

üìÇ *–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ:*
\`$(basename "$file_path")\`"
            
            local thread_param=""
            [[ -n "$TG_MESSAGE_THREAD_ID" ]] && thread_param="-d message_thread_id=$TG_MESSAGE_THREAD_ID"

            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                -d text="$error_msg" \
                -d parse_mode="MarkdownV2" \
                $thread_param >/dev/null
        else
            print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram (HTTP –∫–æ–¥: $http_code)."
        fi
    fi
}

# --- –ë–≠–ö–ê–ü ---

create_backup() {
    local TYPE="$1"
    local TIMESTAMP=$(date +%Y-%m-%d"_"%H_%M_%S)
    local FILE_DB="db_${TIMESTAMP}.sql.gz"
    local FILE_DIR="dir_${TIMESTAMP}.tar.gz"
    local FILE_VERSION="bot_version.txt"
    local FILE_FINAL=""
    local BACKUP_TAG=""
    local HAS_ERROR=0
    local SKIP_INFO=""
    local SKIP_FILE="$BACKUP_DIR/skipped_files.txt"

    if [[ "$TYPE" != "db_only" ]]; then if ! ensure_bot_path; then return; fi; fi
    if [[ "$TYPE" == "db_only" || "$TYPE" == "full" ]]; then
        if [[ -z "$DB_CONTAINER_NAME" ]]; then ensure_bot_path; fi
    fi

    local CURRENT_VER=$(get_raw_bot_version)
    echo "${CURRENT_VER:-Unknown}" > "$BACKUP_DIR/$FILE_VERSION"

    # –î–∞–º–ø –ë–î
    if [[ "$TYPE" == "full" || "$TYPE" == "db_only" ]]; then
        print_message "INFO" "–î–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ($DB_CONTAINER_NAME)..."
        if ! docker container inspect -f '{{.State.Running}}' "$DB_CONTAINER_NAME" &>/dev/null; then
             print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä DB ($DB_CONTAINER_NAME) –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
             HAS_ERROR=1
        else
            if ! docker exec "$DB_CONTAINER_NAME" pg_dumpall -c -U "$DB_USER" 2>/dev/null | gzip -9 > "$BACKUP_DIR/$FILE_DB"; then
                print_message "ERROR" "–û—à–∏–±–∫–∞ –¥–∞–º–ø–∞ –ë–î."
                HAS_ERROR=1
            fi
        fi
    fi

    if [[ $HAS_ERROR -eq 1 ]]; then rm -f "$BACKUP_DIR/$FILE_DB" "$BACKUP_DIR/$FILE_VERSION"; return; fi

    # --- –õ–û–ì–ò–ö–ê –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô ---
    IFS=' ' read -r -a EXCLUDE_ARRAY <<< "$EXCLUDE_DIRS"
    EXCLUDE_FLAGS=()
    for ex in "${EXCLUDE_ARRAY[@]}"; do
        if [[ -n "$ex" ]]; then EXCLUDE_FLAGS+=(--exclude="$ex"); fi
    done
    EXCLUDE_FLAGS+=(--exclude="*.log" --exclude=".git" --exclude="private-remnawave-*.tar")

    # --- –õ–û–ì–ò–ö–ê –ë–û–õ–¨–®–ò–• –§–ê–ô–õ–û–í ---
    if [[ "$TYPE" != "db_only" ]]; then
        : > "$SKIP_FILE"
        
        local FIND_CMD="find ."
        for ex in "${EXCLUDE_ARRAY[@]}"; do
            if [[ -n "$ex" ]]; then FIND_CMD+=" -path './$ex' -prune -o"; fi
        done
        FIND_CMD+=" -type f -size +${MAX_FILE_SIZE_MB}M -print"
        
        cd "$BOT_PATH"
        eval "$FIND_CMD" > "$SKIP_FILE"
        
        local SKIP_COUNT=$(wc -l < "$SKIP_FILE")
        if [[ "$SKIP_COUNT" -gt 0 ]]; then
            local SKIP_SIZE=$(du -ch --files0-from=<(tr '\n' '\0' < "$SKIP_FILE") | tail -1 | cut -f1)
            print_message "WARN" "–ü—Ä–æ–ø—É—â–µ–Ω–æ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>${MAX_FILE_SIZE_MB}MB): $SKIP_COUNT (–æ–±—â–∏–π –≤–µ—Å: $SKIP_SIZE)"
            EXCLUDE_FLAGS+=(--exclude-from="$SKIP_FILE")
            SKIP_INFO=$'\n‚ö†Ô∏è Skip: '"$SKIP_COUNT"$' (>'"$MAX_FILE_SIZE_MB"$'MB)'
        fi
    fi

    # –£–ø–∞–∫–æ–≤–∫–∞
    if [[ "$TYPE" == "db_only" ]]; then
        FILE_FINAL="lazarus_db_${TIMESTAMP}.tar.gz"
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "$FILE_DB"
        rm -f "$BACKUP_DIR/$FILE_DB"
    elif [[ "$TYPE" == "files_only" ]]; then
        FILE_FINAL="lazarus_files_${TIMESTAMP}.tar.gz"
        print_message "INFO" "–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤..."
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "${EXCLUDE_FLAGS[@]}" -C "$(dirname "$BOT_PATH")" "$(basename "$BOT_PATH")"
    else # FULL
        FILE_FINAL="lazarus_full_${TIMESTAMP}.tar.gz"
        print_message "INFO" "–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤..."
        tar -czf "$BACKUP_DIR/$FILE_DIR" "${EXCLUDE_FLAGS[@]}" -C "$(dirname "$BOT_PATH")" "$(basename "$BOT_PATH")"
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "$FILE_DB" "$FILE_DIR"
        rm -f "$BACKUP_DIR/$FILE_DB" "$BACKUP_DIR/$FILE_DIR"
    fi

    # --- –ß–ò–°–¢–ö–ê –ü–û–°–õ–ï –ë–≠–ö–ê–ü–ê ---
    rm -f "$SKIP_FILE"

    cp "$BACKUP_DIR/$FILE_VERSION" "$BACKUP_DIR/$FILE_FINAL.version"
    rm -f "$BACKUP_DIR/$FILE_VERSION"
    
    local SIZE=$(du -h "$BACKUP_DIR/$FILE_FINAL" | awk '{print $1}')
    print_message "SUCCESS" "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $FILE_FINAL ($SIZE)"
    
    # --- –ù–û–í–´–ô –§–û–†–ú–ê–¢ –°–û–û–ë–©–ï–ù–ò–Ø –í TELEGRAM ---
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ("–≤–µ—Ä–Ω–µ–º –Ω–∞–∑–∞–¥")
    local DISPLAY_DATE=$(date "+%d.%m.%Y %H:%M:%S")
    local HASHTAG=""
    local TYPE_NAME=""
    
    case "$TYPE" in
        "full")
            HASHTAG="üíæ #full_backup"
            TYPE_NAME="üì¶ –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø"
            ;;
        "db_only")
            HASHTAG="üíæ #db_only"
            TYPE_NAME="üóÑ –î–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
            ;;
        "files_only")
            HASHTAG="üíæ #files_only"
            TYPE_NAME="üìÇ –§–∞–π–ª—ã –±–æ—Ç–∞"
            ;;
    esac

    local VER_MSG=""; [[ -n "$CURRENT_VER" ]] && VER_MSG=" | üè∑ v${CURRENT_VER}"
    
    local CAPTION="${HASHTAG}
üìÖ ${DISPLAY_DATE}
${TYPE_NAME}
üìè ${SIZE}${VER_MSG}${SKIP_INFO}"
    
    send_telegram_document "$BACKUP_DIR/$FILE_FINAL" "$CAPTION"

    find "$BACKUP_DIR" -name "lazarus_*.tar.gz" -mtime +$RETAIN_BACKUPS_DAYS -delete
    find "$BACKUP_DIR" -name "lazarus*.tar.gz.version" -mtime +$RETAIN_BACKUPS_DAYS -delete
}

# --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï ---

select_backup_file() {
    local FILTER_PREFIX="$1"; local TITLE="$2"
    local show_limit=5; local show_filenames=false

    while true; do
        if ! compgen -G "$BACKUP_DIR/${FILTER_PREFIX}_*.tar.gz" > /dev/null; then
            print_message "WARN" "–§–∞–π–ª–æ–≤ —Ç–∏–ø–∞ '${TITLE}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."; read -erp "Enter..." dummy; return 1
        fi
        
        local files_unsorted=("$BACKUP_DIR/${FILTER_PREFIX}_"*.tar.gz)
        IFS=$'\n' sorted_backups=($(sort -r <<<"${files_unsorted[*]}"))
        unset IFS
        
        local total_count=${#sorted_backups[@]}
        local CURRENT_VER=$(get_raw_bot_version)

        clear; echo -e "${GREEN}–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: ${BOLD}${TITLE}${RESET}"
        echo -e "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${CYAN}${total_count}${RESET}"; echo ""

        local loop_limit=$show_limit
        local show_all=false 
        
        if [[ "$loop_limit" -lt "$total_count" ]]; then show_all=false; else show_all=true; fi
        
        if [[ $loop_limit -gt $total_count ]]; then loop_limit=$total_count; fi

        for (( i=0; i<loop_limit; i++ )); do
            local file="${sorted_backups[$i]}"
            local filename=$(basename "$file")
            
            local CACHE_FILE="${file}.version"
            local B_VER=""
            if [[ -f "$CACHE_FILE" ]]; then B_VER=$(cat "$CACHE_FILE")
            else
                B_VER=$(tar -xzf "$file" -O bot_version.txt 2>/dev/null)
                if [[ -n "$B_VER" ]]; then echo "$B_VER" > "$CACHE_FILE"; else echo "?" > "$CACHE_FILE"; B_VER="?"; fi
            fi
            local VER_STR=""
            if [[ "$B_VER" == "Unknown" || "$B_VER" == "" ]]; then VER_STR="${GRAY}[–ù/–î]${RESET}"
            elif [[ "$B_VER" == "?" ]]; then VER_STR="${GRAY}[Legacy]${RESET}"
            elif [[ -z "$CURRENT_VER" ]]; then VER_STR="${GRAY}[v$B_VER]${RESET}"
            elif [[ "$B_VER" == "$CURRENT_VER" ]]; then VER_STR="${GREEN}[v$B_VER]${RESET}"
            else VER_STR="${RED}[v$B_VER]${RESET}"; fi

            if [[ "$show_filenames" == "true" ]]; then
                printf " %2d. %s %s\n" "$((i+1))" "$filename" "$VER_STR"
            else
                if [[ $filename =~ _([0-9]{4}-[0-9]{2}-[0-9]{2})_([0-9]{2})_([0-9]{2}) ]]; then
                    local date_part="${BASH_REMATCH[1]}"
                    local time_part="${BASH_REMATCH[2]}:${BASH_REMATCH[3]}"
                    local d_d=${date_part:8:2}; local d_m=${date_part:5:2}
                    local pretty_date="$d_d.$d_m $time_part"
                    local fsize=$(du -h "$file" | awk '{print $1}')
                    printf " %2d. %s | %5s | %s\n" "$((i+1))" "${BOLD}$pretty_date${RESET}" "$fsize" "$VER_STR"
                else
                    printf " %2d. %s %s\n" "$((i+1))" "$filename" "$VER_STR"
                fi
            fi
        done

        echo ""
        if [[ $total_count -gt 5 ]]; then
            if [[ $loop_limit -lt $total_count ]]; then
                 echo -e " ${MAGENTA}6. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ ($((total_count - 5)) —à—Ç)...${RESET}"
            else
                 echo -e " ${MAGENTA}6. –°–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ (–ø–æ–∫–∞–∑–∞—Ç—å 5)${RESET}"
            fi
        fi

        if [[ "$show_filenames" == "false" ]]; then
            echo -e " 7. –ü–æ–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤"; 
        else
            echo -e " 7. –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –∏ —Ä–∞–∑–º–µ—Ä"; 
        fi
        echo " 0. –ù–∞–∑–∞–¥"; echo ""
        read -erp "–ù–æ–º–µ—Ä (Enter - –ù–∞–∑–∞–¥): " choice
        
        if [[ -z "$choice" || "$choice" == "0" ]]; then return 1
        elif [[ "$choice" == "6" ]]; then 
            if [[ $loop_limit -lt $total_count ]]; then loop_limit=$total_count; else loop_limit=5; fi
            show_limit=$loop_limit
            continue
        elif [[ "$choice" == "7" ]]; then 
            if [[ "$show_filenames" == "false" ]]; then show_filenames=true; else show_filenames=false; fi
            continue
        elif [[ "$choice" =~ ^[0-9]+$ && "$choice" -le "$total_count" ]]; then SELECTED_FILE="${sorted_backups[$((choice-1))]}"; return 0
        else print_message "ERROR" "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä."; sleep 1; fi
    done
}

execute_restore() {
    local MODE="$1"; local FILE="$2"
    echo ""; print_message "WARN" "–í–ù–ò–ú–ê–ù–ò–ï: –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã!"
    read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " confirm; [[ "$confirm" != "y" ]] && return

    local TMP_DIR="$BACKUP_DIR/restore_tmp_$$"
    mkdir -p "$TMP_DIR"
    print_message "INFO" "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞..."
    tar -xzf "$FILE" -C "$TMP_DIR"

    local DB_DUMP=$(find "$TMP_DIR" -name "db_*.sql.gz" | head -1)
    local DIR_ARC=$(find "$TMP_DIR" -name "dir_*.tar.gz" | head -1)

    if [[ "$MODE" == "full" && -n "$DIR_ARC" ]]; then
        if ! ensure_bot_path; then rm -rf "$TMP_DIR"; return; fi
        print_message "INFO" "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        cd "$BOT_PATH" && docker compose down 2>/dev/null
        print_message "INFO" "–û—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏..."
        rm -rf "$BOT_PATH"/*
        print_message "INFO" "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
        tar -xzf "$DIR_ARC" -C "$(dirname "$BOT_PATH")"
        docker volume rm "$DB_VOLUME_NAME" 2>/dev/null || true
        print_message "INFO" "–ó–∞–ø—É—Å–∫ –ë–î..."
        docker compose up -d "$DB_SERVICE_NAME"
        sleep 5
    fi

    if [[ -n "$DB_DUMP" ]]; then
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        if ! ensure_bot_path; then rm -rf "$TMP_DIR"; return; fi 
        zcat "$DB_DUMP" | docker exec -i "$DB_CONTAINER_NAME" psql -U "$DB_USER" -d postgres >/dev/null 2>&1
    fi

    if [[ "$MODE" == "full" ]]; then
        print_message "INFO" "–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        cd "$BOT_PATH" && docker compose up -d
    fi

    rm -rf "$TMP_DIR"
    print_message "SUCCESS" "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
    read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
}

# --- –ú–ï–ù–Æ–®–ö–ò ---

menu_manual_backup() {
    while true; do
        clear; echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞${RESET}"
        echo " 1. –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø (–ë–î + –§–∞–π–ª—ã)"
        echo " 2. –¢–æ–ª—å–∫–æ –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö"
        echo " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í–∞—à –≤—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " m_choice
        [[ -z "$m_choice" ]] && return
        
        case $m_choice in
            1) create_backup "full"; read -erp "Enter..." dummy; return ;;
            2) create_backup "db_only"; read -erp "Enter..." dummy; return ;;
            3) create_backup "files_only"; read -erp "Enter..." dummy; return ;;
            0) return ;;
        esac
    done
}

menu_restore() {
    while true; do
        local n_full=$(find "$BACKUP_DIR" -maxdepth 1 -name "lazarus_full_*.tar.gz" 2>/dev/null | wc -l)
        local n_db=$(find "$BACKUP_DIR" -maxdepth 1 -name "lazarus_db_*.tar.gz" 2>/dev/null | wc -l)
        local n_files=$(find "$BACKUP_DIR" -maxdepth 1 -name "lazarus_files_*.tar.gz" 2>/dev/null | wc -l)

        local c_f="$CYAN"; [[ "$n_full" == "0" ]] && c_f="$GRAY"
        local c_d="$CYAN"; [[ "$n_db" == "0" ]] && c_d="$GRAY"
        local c_fl="$CYAN"; [[ "$n_files" == "0" ]] && c_fl="$GRAY"

        clear; echo -e "${GREEN}–ú–µ–Ω—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è${RESET}"
        echo -e " 1. –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø      ${c_f}[${n_full} —à—Ç]${RESET}"
        echo -e " 2. –¢–æ–ª—å–∫–æ –ë–∞–∑–∞       ${c_d}[${n_db} —à—Ç]${RESET}"
        echo -e " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã      ${c_fl}[${n_files} —à—Ç]${RESET}"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " r_choice
        [[ -z "$r_choice" ]] && return

        local SELECTED_FILE=""
        case $r_choice in
            1) if select_backup_file "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã"; then execute_restore "full" "$SELECTED_FILE"; fi ;;
            2) if select_backup_file "lazarus_db" "–ë—ç–∫–∞–ø—ã –ë–î"; then execute_restore "db_only" "$SELECTED_FILE"; fi ;;
            3) if select_backup_file "lazarus_files" "–ë—ç–∫–∞–ø—ã –§–∞–π–ª–æ–≤"; then 
                   echo ""; print_message "WARN" "–ë—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ –±–æ—Ç–∞!"
                   read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " cf
                   if [[ "$cf" == "y" ]]; then 
                       if ensure_bot_path; then tar -xzf "$SELECTED_FILE" -C "$(dirname "$BOT_PATH")"; print_message "SUCCESS" "–§–∞–π–ª—ã —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã."; read -erp "Enter..." dummy; fi
                   fi
               fi ;;
            0) return ;;
        esac
    done
}

setup_cron_task() {
    local TASK_TYPE="$1"; local JOB_CMD=""; local JOB_ID=""
    if [[ "$TASK_TYPE" == "db" ]]; then JOB_CMD="$SYMLINK_PATH backup_db"; JOB_ID="# LAZARUS-JOB-DB"
    elif [[ "$TASK_TYPE" == "files" ]]; then if ! ensure_bot_path; then return; fi; JOB_CMD="$SYMLINK_PATH backup_files"; JOB_ID="# LAZARUS-JOB-FILES"
    elif [[ "$TASK_TYPE" == "full" ]]; then if ! ensure_bot_path; then return; fi; JOB_CMD="$SYMLINK_PATH backup_full"; JOB_ID="# LAZARUS-JOB-FULL"; fi

    clear; echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–∏–æ–¥–∞: ${BOLD}${TASK_TYPE^^}${RESET}"
    echo " 1. –ï–∂–µ—á–∞—Å–Ω–æ"
    echo " 2. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ (04:00)"
    echo " 3. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ"
    echo " 4. –°–≤–æ–µ –≤—Ä–µ–º—è"
    echo " 5. –ö–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç"
    echo " 6. –û—Ç–∫–ª—é—á–∏—Ç—å"
    echo ""
    read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " c
    [[ -z "$c" ]] && return
    
    local NEW_CRON_LINES=""; local DISPLAY_TIME=""

    case $c in
        1) NEW_CRON_LINES="0 * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ—á–∞—Å–Ω–æ" ;;
        2) NEW_CRON_LINES="0 4 * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 04:00" ;;
        3) NEW_CRON_LINES="0 4 * * 1 $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ" ;;
        4) echo "–í—Ä–µ–º—è (–ß–ß:–ú–ú) —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª:"; read -erp "> " times_input
           if [[ -z "$times_input" ]]; then print_message "ERROR" "–í—Ä–µ–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ!"; sleep 1; return; fi
           for t in $times_input; do if [[ "$t" =~ ^([0-9]{1,2}):([0-9]{1,2})$ ]]; then h=$((10#${BASH_REMATCH[1]})); m=$((10#${BASH_REMATCH[2]})); NEW_CRON_LINES+="$m $h * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"$'\n'; fi; done; DISPLAY_TIME="–°–≤–æ–µ: $times_input" ;;
        5) read -erp "–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω—É—Ç): " interval
           if [[ "$interval" =~ ^[0-9]+$ ]] && [ "$interval" -gt 0 ] && [ "$interval" -lt 60 ]; then
               NEW_CRON_LINES="*/$interval * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
               DISPLAY_TIME="–ö–∞–∂–¥—ã–µ $interval –º–∏–Ω"
           else print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 59."; sleep 1; return; fi ;;
        6) DISPLAY_TIME="–í—ã–∫–ª" ;;
        *) return ;;
    esac

    local CURRENT_CRON=$(crontab -l 2>/dev/null | grep -v "$JOB_ID")
    if [[ "$DISPLAY_TIME" != "–í—ã–∫–ª" && -n "$NEW_CRON_LINES" ]]; then echo -e "$CURRENT_CRON\n$NEW_CRON_LINES" | crontab -
    else echo "$CURRENT_CRON" | crontab -; fi

    if [[ "$TASK_TYPE" == "full" ]]; then SCHEDULE_FULL="$DISPLAY_TIME"; fi
    if [[ "$TASK_TYPE" == "db" ]];   then SCHEDULE_DB="$DISPLAY_TIME"; fi
    if [[ "$TASK_TYPE" == "files" ]]; then SCHEDULE_FILES="$DISPLAY_TIME"; fi
    save_config; print_message "SUCCESS" "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"; sleep 1
}

menu_automation() {
    while true; do
        clear; echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ë–µ–∫–∞–ø–∞${RESET}"
        echo -e " 1. –ü–æ–ª–Ω—ã–π –±–µ–∫–∞–ø [${YELLOW}${SCHEDULE_FULL}${RESET}]"
        echo -e " 2. –¢–æ–ª—å–∫–æ –ë–∞–∑–∞  [${YELLOW}${SCHEDULE_DB}${RESET}]"
        echo -e " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã [${YELLOW}${SCHEDULE_FILES}${RESET}]"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " ac
        [[ -z "$ac" ]] && return
        case $ac in 1) setup_cron_task "full" ;; 2) setup_cron_task "db" ;; 3) setup_cron_task "files" ;; 0) return ;; esac
    done
}

menu_settings() {
    while true; do
        clear; echo -e "${GREEN}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞${RESET}"
        local MASKED_TOKEN="${BOT_TOKEN:0:5}.......${BOT_TOKEN: -5}"; [[ ${#BOT_TOKEN} -lt 10 ]] && MASKED_TOKEN="*******"
        echo -e " 1. –ü—É—Ç—å –∫ –±–æ—Ç—É:      ${CYAN}${BOT_PATH}${RESET}"
        echo -e " 2. Telegram Token:   ${CYAN}${MASKED_TOKEN}${RESET}"
        echo -e " 3. Chat ID:          ${CYAN}${CHAT_ID}${RESET}"
        echo -e " 4. Thread ID:        ${CYAN}${TG_MESSAGE_THREAD_ID:-–ù–µ—Ç}${RESET}"
        echo -e " 5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î:  ${CYAN}${DB_USER}${RESET}"
        echo -e " 6. –•—Ä–∞–Ω–∏—Ç—å –±—ç–∫–∞–ø—ã:   ${CYAN}${RETAIN_BACKUPS_DAYS} –¥–Ω–µ–π${RESET}"
        echo -e " 7. –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:   ${CYAN}${BOT_CONTAINER_NAME}${RESET}"
        echo -e " 8. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î:     ${CYAN}${DB_CONTAINER_NAME}${RESET}"
        echo -e " 9. –ò—Å–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫–∏:  ${CYAN}${EXCLUDE_DIRS:-–ù–µ—Ç}${RESET}"
        echo -e " 10. –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${CYAN}${MAX_FILE_SIZE_MB} MB${RESET}"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å (Enter - –ù–∞–∑–∞–¥): " s
        [[ -z "$s" ]] && return
        
        case $s in
            1) read -erp "–ù–æ–≤—ã–π –ø—É—Ç—å: " np; if [[ -n "$np" ]]; then if [[ -d "$np" ]]; then BOT_PATH="$np"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; else print_message "ERROR" "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; fi; fi ;;
            2) read -erp "–ù–æ–≤—ã–π Token: " nt; if [[ -n "$nt" ]]; then BOT_TOKEN="$nt"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            3) read -erp "–ù–æ–≤—ã–π Chat ID: " nid; if [[ -n "$nid" ]]; then CHAT_ID="$nid"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            4) read -erp "–ù–æ–≤—ã–π Thread ID: " ntid; TG_MESSAGE_THREAD_ID="$ntid"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" ;;
            5) read -erp "–ù–æ–≤—ã–π DB User: " ndb; if [[ -n "$ndb" ]]; then DB_USER="$ndb"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            6) read -erp "–î–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è: " nd; if [[ "$nd" =~ ^[0-9]+$ ]]; then RETAIN_BACKUPS_DAYS="$nd"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            7) read -erp "–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞: " nc; if [[ -n "$nc" ]]; then BOT_CONTAINER_NAME="$nc"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            8) read -erp "–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î: " nc; if [[ -n "$nc" ]]; then DB_CONTAINER_NAME="$nc"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
            9) read -erp "–ò—Å–∫–ª—é—á–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: uploads/cache node_modules): " ed; 
               if [[ -n "$ed" ]]; then 
                   EXCLUDE_DIRS="$ed"
                   save_config
                   print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
               else
                   if [[ -n "$EXCLUDE_DIRS" ]]; then
                        read -erp "–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π? (y/N): " clr
                        if [[ "$clr" =~ ^[Yy]$ ]]; then EXCLUDE_DIRS=""; save_config; print_message "SUCCESS" "–û—á–∏—â–µ–Ω–æ"; fi
                   fi
               fi ;;
            10) read -erp "–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ MB (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ): " msize
                if [[ "$msize" =~ ^[0-9]+$ ]] && [ "$msize" -gt 0 ]; then
                    MAX_FILE_SIZE_MB="$msize"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
                else print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0"; fi ;;
            0) return ;;
        esac; if [[ -n "$s" ]]; then sleep 1; fi
    done
}

cleanup_old_backups() {
    clear; echo -e "${RED}–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤${RESET}"; echo "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ $RETAIN_BACKUPS_DAYS –¥–Ω–µ–π..."
    local COUNT=$(find "$BACKUP_DIR" -name "lazarus_*.tar.gz" -mtime +$RETAIN_BACKUPS_DAYS | wc -l)
    if [[ "$COUNT" -eq 0 ]]; then print_message "INFO" "–§–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."; read -erp "Enter..." dummy; return; fi
    find "$BACKUP_DIR" -name "lazarus_*.tar.gz" -mtime +$RETAIN_BACKUPS_DAYS -print
    echo ""; print_message "WARN" "–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $COUNT"; read -erp "–£–¥–∞–ª–∏—Ç—å? (y/n): " c
    if [[ "$c" == "y" ]]; then
        find "$BACKUP_DIR" -name "lazarus_*.tar.gz" -mtime +$RETAIN_BACKUPS_DAYS -delete
        find "$BACKUP_DIR" -name "lazarus_*.tar.gz.version" -mtime +$RETAIN_BACKUPS_DAYS -delete
        print_message "SUCCESS" "–û—á–∏—â–µ–Ω–æ."; else print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ."; fi
    read -erp "Enter..." dummy
}

# --- MAIN LOOP ---
install_script
load_or_create_config
check_config_mismatch # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

case "$1" in
    backup_full) create_backup "full" ;;
    backup_db)   create_backup "db_only" ;;
    backup_files) create_backup "files_only" ;;
    restore) menu_restore ;;
    *)
        while true; do
            BOT_VERSION=$(get_bot_version_display)
            clear
            echo -e "${GREEN}${BOLD}LAZARUS Backup Manager v${VERSION}${RESET}"
            echo -e "–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: ${CYAN}${BOT_VERSION}${RESET}"
            echo ""
            echo -e "–°—Ç–∞—Ç—É—Å—ã –∞–≤—Ç–æ-–±–µ–∫–∞–ø–∞:"
            echo -e " ‚Ä¢ Full:  ${YELLOW}${SCHEDULE_FULL}${RESET}"
            echo -e " ‚Ä¢ DB:    ${YELLOW}${SCHEDULE_DB}${RESET}"
            echo -e " ‚Ä¢ Files: ${YELLOW}${SCHEDULE_FILES}${RESET}"
            echo ""
            echo " --- –î–ï–ô–°–¢–í–ò–Ø ---"
            echo " 1. –†—É—á–Ω–æ–π –±–µ–∫–∞–ø (Full / DB / Files)"
            echo " 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ-–±–µ–∫–∞–ø"
            echo " 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±–µ–∫–∞–ø–∞"
            echo " 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ü—É—Ç–∏ / –¢–æ–∫–µ–Ω—ã / –†–æ—Ç–∞—Ü–∏—è)"
            echo " 5. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (>${RETAIN_BACKUPS_DAYS} –¥–Ω–µ–π)"
            echo ""
            echo -e "${RED} 666. –£–¥–∞–ª–∏—Ç—å —Å–∫—Ä–∏–ø—Ç (Uninstall)${RESET}"
            echo " 0. –í—ã—Ö–æ–¥"
            echo ""
            read -erp "–í—ã–±–æ—Ä (Enter - –≤—ã—Ö–æ–¥): " opt; [[ -z "$opt" ]] && exit 0
            case $opt in
                1) menu_manual_backup ;; 2) menu_automation ;; 3) menu_restore ;; 
                4) menu_settings ;; 5) cleanup_old_backups ;; 666) uninstall_script ;; 0) exit 0 ;;
            esac
        done
        ;;
esac
