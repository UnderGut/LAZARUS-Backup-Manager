#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
VERSION="4.24.0"
SCRIPT_NAME="lazarus"
INSTALL_DIR="/opt/lazarus-backup"
BACKUP_DIR="$INSTALL_DIR/backup"
CONFIG_FILE="$INSTALL_DIR/config.env"
SYMLINK_PATH="/usr/local/bin/$SCRIPT_NAME"
REMOTE_URL="https://raw.githubusercontent.com/UnderGut/LAZARUS-Backup-Manager/main/lazarus-backup"

# --- –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê –î–õ–Ø –ü–û–ò–°–ö–ê –ë–û–¢–ê (–ù–ï –ü–ê–ù–ï–õ–ò!) ---
# –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: rwp_shop, rwp_shop_db
# –¢–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ legacy: telegram-shop, shop-bot, shopbot
# –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω: —Å–Ω–∞—á–∞–ª–∞ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
KEYWORDS=("rwp_shop" "telegram-shop" "shop-bot" "shopbot")

# --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
BOT_PATH=""
BOT_TOKEN=""
CHAT_ID=""
TG_MESSAGE_THREAD_ID=""
DB_USER="postgres"
IGNORE_MISMATCH="false"
EXCLUDE_DIRS=""
MAX_FILE_SIZE_MB="1"

# –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
SEND_TO_TELEGRAM="true"      # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
TG_SEND_FILE="true"          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞ –≤ Telegram
SEND_TO_REMOTE="true"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ—Ç–∞—Ü–∏–∏ (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É)
MAX_BACKUPS_COUNT="100"

# –£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã: "time" –∏–ª–∏ "count" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é time)
DELETE_MODE="time"
# –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –¥–Ω—è—Ö –ø—Ä–∏ —Ä–µ–∂–∏–º–µ time (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 –¥–Ω–µ–π)
RETENTION_DAYS="7"

# –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤ (–≤ MB). 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞
MAX_BACKUP_SIZE_MB="0"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
REMOTE_STORAGE_TYPE="off" # off, ftp, webdav
REMOTE_STORAGE_URL=""
REMOTE_STORAGE_USER=""
REMOTE_STORAGE_PASS=""
REMOTE_UPLOAD_STATUS_TEXT=""

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
BACKUP_PASSWORD=""

# –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
BOT_CONTAINER_NAME="" 
DB_CONTAINER_NAME=""
# –ü—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
DEFAULT_BOT_PATH="/opt/private-remnawave-telegram-shop-bot"
# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: rwp_shop, rwp_shop_db
DEFAULT_BOT_CONTAINER="rwp_shop"
DEFAULT_DB_CONTAINER="rwp_shop_db"
# Volume –∏–º–µ–Ω–∞ (–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
DB_VOLUME_NAME=""  # –ë—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä rwp_shop_db_data)
DB_SERVICE_NAME="db"  # –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤ compose.yaml 

# –°—Ç–∞—Ç—É—Å—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
SCHEDULE_FULL="–í—ã–∫–ª"
SCHEDULE_DB="–í—ã–∫–ª"
SCHEDULE_FILES="–í—ã–∫–ª"

# –§–ª–∞–≥ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
IS_INTERACTIVE=true
if [[ ! -t 0 ]]; then IS_INTERACTIVE=false; fi

# –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (--debug)
DEBUG_MODE=false
SILENT_LOG="/dev/null"
CURL_SILENT="-s"
WGET_SILENT="-q"

# –ê–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, cron --yes)
AUTO_CONFIRM="false"

# –õ–æ–≥-—Ñ–∞–π–ª –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤
LOG_FILE="/var/log/lazarus_backup.log"

# Lock-—Ñ–∞–π–ª –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
LOCK_FILE="/var/run/lazarus_backup.lock"
LOCK_FD=200  # File descriptor –¥–ª—è flock

# Trap –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
cleanup_on_exit() {
    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –µ—Å–ª–∏ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞
    # NOTE: debug_log –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∑–¥–µ—Å—å –µ—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è stdout
    if [[ -n "$LOCK_FD" ]]; then
        flock -u "$LOCK_FD" 2>/dev/null || true
        eval "exec $LOCK_FD>&-" 2>/dev/null || true
    fi
    rm -f "$LOCK_FILE" 2>/dev/null || true
}
trap cleanup_on_exit EXIT INT TERM

# –¶–≤–µ—Ç–∞
if [[ -t 0 ]]; then
    RED=$'\e[31m'; GREEN=$'\e[32m'; YELLOW=$'\e[33m'; GRAY=$'\e[90m'; CYAN=$'\e[36m'; MAGENTA=$'\e[35m'; RESET=$'\e[0m'; BOLD=$'\e[1m'
else
    RED=""; GREEN=""; YELLOW=""; GRAY=""; CYAN=""; MAGENTA=""; RESET=""; BOLD=""
fi

# --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

# –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞ (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ debug —Ä–µ–∂–∏–º–µ)
clear_screen() {
    if [[ "$DEBUG_MODE" == true ]]; then
        echo ""
        echo -e "${MAGENTA}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê [DEBUG: clear skipped] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
        echo ""
    else
        clear
    fi
}

# –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: debug_log "message" –∏–ª–∏ debug_log "CATEGORY" "message"
debug_log() {
    if [[ "$DEBUG_MODE" == true ]]; then
        local ts=$(date '+%H:%M:%S.%3N')
        if [[ $# -eq 1 ]]; then
            echo -e "${MAGENTA}[$ts DEBUG]${RESET} $1"
        else
            local category="$1"
            shift
            echo -e "${MAGENTA}[$ts DEBUG]${RESET} ${CYAN}[$category]${RESET} $*"
        fi
    fi
}

escape_markdown_v2() {
    echo "$1" | sed -e 's/\\/\\\\/g' -e 's/_/\\_/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' \
        -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\~/g' -e 's/`/\\`/g' -e 's/>/\\>/g' \
        -e 's/#/\\#/g' -e 's/+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/|/\\|/g' \
        -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\./\\./g' -e 's/!/\\!/g'
}

send_telegram_notification() {
    local msg="$1"
    debug_log "TG" "=== send_telegram_notification ==="
    debug_log "TG" "SEND_TO_TELEGRAM=$SEND_TO_TELEGRAM"
    if [[ "$SEND_TO_TELEGRAM" == "true" && -n "$BOT_TOKEN" && -n "$CHAT_ID" ]]; then
        if command -v curl > "$SILENT_LOG" 2>&1; then
            local escaped_msg
            escaped_msg=$(escape_markdown_v2 "$msg")
            local thread_param=""
            [[ -n "$TG_MESSAGE_THREAD_ID" ]] && thread_param="-d message_thread_id=$TG_MESSAGE_THREAD_ID"
            local full_text="üö® *Lazarus Error* üö®

${escaped_msg}"
            debug_log "TG" "Sending error notification to chat_id=$CHAT_ID"
            curl $CURL_SILENT -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                -d parse_mode="MarkdownV2" \
                --data-urlencode text="$full_text" \
                $thread_param > "$SILENT_LOG" 2>&1 || true
            debug_log "TG" "Notification sent"
        else
            debug_log "TG" "curl not available, skipping notification"
        fi
    else
        debug_log "TG" "Notifications disabled or credentials missing"
    fi
}

print_message() {
    local type="$1"; local message="$2"; local color_code="$RESET"
    case "$type" in
        "INFO") color_code="$GRAY" ;;
        "SUCCESS") color_code="$GREEN" ;;
        "WARN") color_code="$YELLOW" ;;
        "ERROR") color_code="$RED" ;;
        "ACTION") color_code="$CYAN" ;;
    esac
    echo -e "${color_code}[$type]${RESET} $message"

    if [[ "$type" == "ERROR" ]]; then
        send_telegram_notification "$message"
    fi
}

log_message() {
    # Level, Message
    local level="$1"; local message="$2"
    # Ensure log dir exists and file is writable
    local logdir
    logdir=$(dirname "$LOG_FILE")
    if [[ ! -d "$logdir" ]]; then mkdir -p "$logdir" 2> "$SILENT_LOG" || true; fi
    if [[ ! -f "$LOG_FILE" ]]; then touch "$LOG_FILE" 2> "$SILENT_LOG" || true; fi
    local ts
    ts=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$ts] [$level] $message" >> "$LOG_FILE" 2> "$SILENT_LOG" || true
}

rotate_internal_log() {
    # Rotate log if > 10MB
    local MAX_LOG_SIZE=$((10 * 1024 * 1024))
    if [[ -f "$LOG_FILE" ]]; then
        local size
        size=$(stat -c%s "$LOG_FILE" 2> "$SILENT_LOG" || echo 0)
        if [[ "$size" -gt "$MAX_LOG_SIZE" ]]; then
            mv "$LOG_FILE" "${LOG_FILE}.old"
            echo "Log rotated on $(date)" > "$LOG_FILE"
        fi
    fi
}

# --- –ë–õ–û–ö–ò–†–û–í–ö–ê –û–¢ –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û–ì–û –ó–ê–ü–£–°–ö–ê ---

acquire_lock() {
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–∑ cron
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞, 1 –µ—Å–ª–∏ –∑–∞–Ω—è—Ç–æ
    debug_log "LOCK" "=== acquire_lock ==="
    debug_log "LOCK" "Lock file: $LOCK_FILE"
    
    # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è lock-—Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    local lock_dir=$(dirname "$LOCK_FILE")
    if [[ ! -d "$lock_dir" ]]; then
        debug_log "LOCK" "Creating lock directory: $lock_dir"
        mkdir -p "$lock_dir" 2> "$SILENT_LOG" || true
    fi
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –Ω–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä LOCK_FD
    debug_log "LOCK" "Opening lock file on FD $LOCK_FD"
    eval "exec $LOCK_FD>\"$LOCK_FILE\""
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â—É—é —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    debug_log "LOCK" "Attempting flock..."
    if ! flock -n "$LOCK_FD" 2> "$SILENT_LOG"; then
        debug_log "LOCK" "FAILED - lock already held by another process"
        return 1  # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
    fi
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º PID –≤ lock-—Ñ–∞–π–ª –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    echo "$$" >&$LOCK_FD
    debug_log "LOCK" "Lock acquired, PID=$$ written to lock file"
    
    return 0
}

release_lock() {
    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    debug_log "LOCK" "=== release_lock ==="
    debug_log "LOCK" "Releasing FD $LOCK_FD"
    flock -u "$LOCK_FD" 2> "$SILENT_LOG" || true
    eval "exec $LOCK_FD>&-" 2> "$SILENT_LOG" || true
    rm -f "$LOCK_FILE" 2> "$SILENT_LOG" || true
    debug_log "LOCK" "Lock released and file removed"
}

check_lock_owner() {
    # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç PID –ø—Ä–æ—Ü–µ—Å—Å–∞, –≤–ª–∞–¥–µ—é—â–µ–≥–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
    debug_log "LOCK" "Checking lock owner..."
    if [[ -f "$LOCK_FILE" ]]; then
        local owner
        owner=$(cat "$LOCK_FILE" 2> "$SILENT_LOG" || echo "unknown")
        debug_log "LOCK" "Lock owner PID: $owner"
        echo "$owner"
    else
        debug_log "LOCK" "No lock file found"
        echo "none"
    fi
}

check_dependencies() {
    local deps=("tar" "gzip" "openssl" "docker" "find" "du" "date")
    local missing=()
    
    # Check for curl OR wget
    if ! command -v curl > "$SILENT_LOG" 2>&1 && ! command -v wget > "$SILENT_LOG" 2>&1; then
        missing+=("curl (or wget)")
    fi

    for cmd in "${deps[@]}"; do
        if ! command -v "$cmd" > "$SILENT_LOG" 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    # Check for docker compose (v2)
    if command -v docker > "$SILENT_LOG" 2>&1; then
        if ! docker compose version > "$SILENT_LOG" 2>&1; then
             echo -e "${RED}[ERROR]${RESET} 'docker compose' plugin is required but not found."
             echo -e "${CYAN}[ACTION]${RESET} Please install docker-compose-plugin (v2)."
             exit 1
        fi
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${RED}[ERROR]${RESET} Missing dependencies: ${missing[*]}"
        echo -e "${CYAN}[ACTION]${RESET} Please install them (e.g., apt install ${missing[*]})"
        exit 1
    fi
}

# --- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–≠–ö–ê–ü–û–í ---

get_backup_stats() {
    # –ü–æ–¥—Å—á—ë—Ç —Ñ–∞–π–ª–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    local n_full=$(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_full_*.tar.gz" -o -name "lazarus_full_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)
    local n_db=$(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_db_*.tar.gz" -o -name "lazarus_db_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)
    local n_files=$(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_files_*.tar.gz" -o -name "lazarus_files_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)
    
    # –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ –±—ç–∫–∞–ø–æ–≤
    local total_size="0B"
    if [[ -d "$BACKUP_DIR" ]]; then
        total_size=$(du -sh "$BACKUP_DIR" 2> "$SILENT_LOG" | awk '{print $1}')
    fi
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø (–ª—é–±–æ–π —Ç–∏–ø)
    local last_backup=""
    local last_backup_ago=""
    local latest_file=$(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_*.tar.gz" -o -name "lazarus_*.tar.gz.enc" \) -printf '%T@ %p\n' 2> "$SILENT_LOG" | sort -rn | head -1 | awk '{print $2}')
    
    if [[ -n "$latest_file" && -f "$latest_file" ]]; then
        local filename=$(basename "$latest_file")
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: lazarus_type_YYYY-MM-DD_HH_MM_SS.tar.gz
        if [[ $filename =~ _([0-9]{4})-([0-9]{2})-([0-9]{2})_([0-9]{2})_([0-9]{2}) ]]; then
            local file_date="${BASH_REMATCH[3]}.${BASH_REMATCH[2]} ${BASH_REMATCH[4]}:${BASH_REMATCH[5]}"
            last_backup="$file_date"
            
            # –í—ã—á–∏—Å–ª—è–µ–º "—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–∑–∞–¥"
            local file_ts=$(stat -c %Y "$latest_file" 2> "$SILENT_LOG")
            local now_ts=$(date +%s)
            if [[ -n "$file_ts" ]]; then
                local diff_sec=$((now_ts - file_ts))
                if [[ $diff_sec -lt 60 ]]; then
                    last_backup_ago="—Ç–æ–ª—å–∫–æ —á—Ç–æ"
                elif [[ $diff_sec -lt 3600 ]]; then
                    local mins=$((diff_sec / 60))
                    last_backup_ago="${mins} –º–∏–Ω –Ω–∞–∑–∞–¥"
                elif [[ $diff_sec -lt 86400 ]]; then
                    local hours=$((diff_sec / 3600))
                    last_backup_ago="${hours} —á –Ω–∞–∑–∞–¥"
                else
                    local days=$((diff_sec / 86400))
                    last_backup_ago="${days} –¥–Ω –Ω–∞–∑–∞–¥"
                fi
            fi
        fi
    fi
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (bash –Ω–µ —É–º–µ–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π)
    STATS_FULL="$n_full"
    STATS_DB="$n_db"
    STATS_FILES="$n_files"
    STATS_SIZE="$total_size"
    STATS_LAST="$last_backup"
    STATS_LAST_AGO="$last_backup_ago"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
check_disk_space() {
    local min_space_mb="${1:-1024}"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1GB
    local backup_path="$BACKUP_DIR"
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ MB
    local free_space_kb=$(df -P "$backup_path" 2> "$SILENT_LOG" | tail -1 | awk '{print $4}')
    local free_space_mb=$((free_space_kb / 1024))
    
    if [[ $free_space_mb -lt $min_space_mb ]]; then
        local free_human=$(df -h "$backup_path" 2> "$SILENT_LOG" | tail -1 | awk '{print $4}')
        return 1  # –ú–∞–ª–æ –º–µ—Å—Ç–∞
    fi
    return 0  # –ú–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
}

# –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
get_free_space() {
    df -h "$BACKUP_DIR" 2> "$SILENT_LOG" | tail -1 | awk '{print $4}'
}

# --- –°–ò–°–¢–ï–ú–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø ---

check_for_updates() {
    clear_screen
    echo -e "${CYAN}–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...${RESET}"
    
    local REMOTE_CONTENT=""
    local DOWNLOAD_OK=false
    local MAX_RETRIES=3
    local TIMEOUT=15
    
    for attempt in $(seq 1 $MAX_RETRIES); do
        if command -v curl > "$SILENT_LOG" 2>&1; then
            REMOTE_CONTENT=$(curl $CURL_SILENT -L --connect-timeout $TIMEOUT --max-time 30 "$REMOTE_URL" 2> "$SILENT_LOG")
        elif command -v wget > "$SILENT_LOG" 2>&1; then
            REMOTE_CONTENT=$(wget $WGET_SILENT -O- --timeout=$TIMEOUT "$REMOTE_URL" 2> "$SILENT_LOG")
        else
            print_message "ERROR" "–ù–µ—Ç curl –∏–ª–∏ wget –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π."
            read -erp "Enter..." dummy; return
        fi
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –≤–∞–ª–∏–¥–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
        if [[ -n "$REMOTE_CONTENT" ]] && echo "$REMOTE_CONTENT" | head -1 | grep -q "^#!/bin/bash"; then
            DOWNLOAD_OK=true
            break
        fi
        
        [[ $attempt -lt $MAX_RETRIES ]] && echo -e "${YELLOW}–ü–æ–ø—ã—Ç–∫–∞ $attempt/$MAX_RETRIES –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä...${RESET}" && sleep 2
    done
    
    if [[ "$DOWNLOAD_OK" != "true" ]]; then
        print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π."
        echo -e "${GRAY}URL: $REMOTE_URL${RESET}"
        read -erp "Enter..." dummy; return
    fi

    local REMOTE_VERSION=$(echo "$REMOTE_CONTENT" | grep '^VERSION=' | head -1 | cut -d'"' -f2)

    if [[ -z "$REMOTE_VERSION" ]]; then
        print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ—Ä—Å–∏–∏."
        echo -e "${GRAY}–§–∞–π–ª –ø–æ–ª—É—á–µ–Ω, –Ω–æ VERSION= –Ω–µ –Ω–∞–π–¥–µ–Ω${RESET}"
        read -erp "Enter..." dummy; return
    fi

    local V_LOCAL=$(echo "$VERSION" | cut -d'-' -f1)
    local V_REMOTE=$(echo "$REMOTE_VERSION" | cut -d'-' -f1)
    local SUFFIX_LOCAL=$(echo "$VERSION" | grep -oE '\-.*$' || echo "")
    local SUFFIX_REMOTE=$(echo "$REMOTE_VERSION" | grep -oE '\-.*$' || echo "")

    echo -e "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${BOLD}$VERSION${RESET}"
    echo -e "–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: ${BOLD}$REMOTE_VERSION${RESET}"
    echo ""

    if [[ "$VERSION" == "$REMOTE_VERSION" ]]; then
        print_message "SUCCESS" "–£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
        read -erp "Enter..." dummy
        return
    fi

    local IS_UPGRADE=false
    # –°–Ω–∞—á–∞–ª–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ä—Å–∏—é (X.Y.Z)
    if [[ "$(printf '%s\n' "$V_LOCAL" "$V_REMOTE" | sort -V | head -n1)" == "$V_LOCAL" && "$V_LOCAL" != "$V_REMOTE" ]]; then
        IS_UPGRADE=true
    # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ä–∞–≤–Ω—ã, –Ω–æ –µ—Å—Ç—å —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å—É—Ñ—Ñ–∏–∫—Å–∞—Ö ‚Äî —ç—Ç–æ —Ç–æ–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    elif [[ "$V_LOCAL" == "$V_REMOTE" && "$SUFFIX_LOCAL" != "$SUFFIX_REMOTE" ]]; then
        IS_UPGRADE=true
    fi

    if [[ "$IS_UPGRADE" == "true" ]]; then
        print_message "WARN" "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!"
        read -erp "–û–±–Ω–æ–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–µ–π—á–∞—Å? (y/N): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            perform_update "$REMOTE_CONTENT"
        else
            print_message "INFO" "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
            read -erp "Enter..." dummy
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –í–µ—Ä—Å–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å—Ç–∞—Ä–µ–µ –∏–ª–∏ —Ç–∞–∫–∞—è –∂–µ.${RESET}"
        read -erp "–í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏—é —Å —Å–µ—Ä–≤–µ—Ä–∞? (y/N): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            perform_update "$REMOTE_CONTENT"
        else
            print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ."
            read -erp "Enter..." dummy
        fi
    fi
}

perform_update() {
    local CONTENT="$1"
    local SCRIPT_PATH="$INSTALL_DIR/$SCRIPT_NAME"
    local BACKUP_PATH="$INSTALL_DIR/${SCRIPT_NAME}.backup"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    if ! echo "$CONTENT" | head -n 1 | grep -q "^#!/bin/bash"; then
        print_message "ERROR" "–û—à–∏–±–∫–∞: –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è bash-—Å–∫—Ä–∏–ø—Ç–æ–º."
        read -erp "Enter..." dummy
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–∑–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
    local CONTENT_SIZE=${#CONTENT}
    if [[ $CONTENT_SIZE -lt 10000 ]]; then
        print_message "ERROR" "–û—à–∏–±–∫–∞: –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª ($CONTENT_SIZE –±–∞–π—Ç)."
        print_message "ERROR" "–í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –±—ã–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ."
        read -erp "Enter..." dummy
        return 1
    fi
    
    # –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
    if [[ -f "$SCRIPT_PATH" ]]; then
        cp "$SCRIPT_PATH" "$BACKUP_PATH"
        print_message "INFO" "–°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: ${SCRIPT_NAME}.backup"
    fi
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
    if echo "$CONTENT" > "$SCRIPT_PATH"; then
        chmod +x "$SCRIPT_PATH"
        print_message "SUCCESS" "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        log_message "SUCCESS" "Script updated to new version"
        echo ""
        echo -e "${CYAN}–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞...${RESET}"
        sleep 1
        exec "$SCRIPT_PATH"
    else
        print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!"
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –±—ç–∫–∞–ø–∞
        if [[ -f "$BACKUP_PATH" ]]; then
            mv "$BACKUP_PATH" "$SCRIPT_PATH"
            print_message "WARN" "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ –±—ç–∫–∞–ø–∞."
        fi
        read -erp "Enter..." dummy
        return 1
    fi
}

# --- –°–ò–°–¢–ï–ú–ê –£–°–¢–ê–ù–û–í–ö–ò ---

install_script() {
    if [[ "$EUID" -ne 0 ]]; then
        echo -e "${RED}–û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)!${RESET}"
        exit 1
    fi

    local CURRENT_SCRIPT_PATH=$(realpath "$0" 2> "$SILENT_LOG")
    local INSTALLED_SCRIPT_PATH="$INSTALL_DIR/$SCRIPT_NAME"

    if [[ "$CURRENT_SCRIPT_PATH" == "$INSTALLED_SCRIPT_PATH" ]]; then
        return
    fi

    echo -e "${CYAN}--- –£–°–¢–ê–ù–û–í–ö–ê LAZARUS BACKUP ---${RESET}"
    if [[ ! -d "$INSTALL_DIR" ]]; then
        mkdir -p "$INSTALL_DIR"
        print_message "SUCCESS" "–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: $INSTALL_DIR"
    fi

    local DOWNLOAD_SUCCESS=false
    local TEMP_FILE="/tmp/lazarus_install_tmp"

    if [[ -f "$0" && "$0" != "bash" && "$0" != "/dev/fd/"* ]]; then
        cp "$(realpath "$0")" "$INSTALLED_SCRIPT_PATH"
        DOWNLOAD_SUCCESS=true
    else
        print_message "INFO" "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏..."
        if command -v curl > "$SILENT_LOG" 2>&1; then
            curl $CURL_SILENT -L --connect-timeout 15 --max-time 60 "$REMOTE_URL" -o "$TEMP_FILE"
        elif command -v wget > "$SILENT_LOG" 2>&1; then
            wget $WGET_SILENT -O "$TEMP_FILE" --timeout=15 "$REMOTE_URL"
        else
            print_message "ERROR" "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω—É–∂–µ–Ω curl –∏–ª–∏ wget!"
            exit 1
        fi

        if [[ -f "$TEMP_FILE" ]]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ bash-—Å–∫—Ä–∏–ø—Ç
            if head -n 1 "$TEMP_FILE" | grep -q "^#!/bin/bash"; then
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
                local FILE_SIZE=$(stat -c%s "$TEMP_FILE" 2> "$SILENT_LOG" || stat -f%z "$TEMP_FILE" 2> "$SILENT_LOG" || echo "0")
                if [[ $FILE_SIZE -lt 10000 ]]; then
                    print_message "ERROR" "–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª ($FILE_SIZE –±–∞–π—Ç)."
                    rm -f "$TEMP_FILE"
                    exit 1
                fi
                mv "$TEMP_FILE" "$INSTALLED_SCRIPT_PATH"
                DOWNLOAD_SUCCESS=true
            else
                print_message "ERROR" "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏! –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª."
                rm -f "$TEMP_FILE"
                exit 1
            fi
        else
            print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª."
            exit 1
        fi
    fi

    if [[ "$DOWNLOAD_SUCCESS" == "true" ]]; then
        chmod +x "$INSTALLED_SCRIPT_PATH"
        if [[ -L "$SYMLINK_PATH" || -f "$SYMLINK_PATH" ]]; then rm -f "$SYMLINK_PATH"; fi
        ln -s "$INSTALLED_SCRIPT_PATH" "$SYMLINK_PATH"
        
        print_message "SUCCESS" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ó–∞–ø—É—Å–∫..."
        echo ""
        exec "$INSTALLED_SCRIPT_PATH"
        exit 0
    fi
}

# --- –Ø–î–†–û –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê ---

scan_system_for_bot() {
    FOUND_PATH=""; FOUND_BOT=""; FOUND_DB=""
    debug_log "SCAN" "=== scan_system_for_bot ==="
    local running_containers=$(docker ps --format '{{.Names}}|{{.Image}}')
    debug_log "SCAN" "Running containers: $(echo "$running_containers" | wc -l)"
    
    # –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ò–°–ö–õ–Æ–ß–ê–ï–ú –∏–∑ –ø–æ–∏—Å–∫–∞)
    local PANEL_CONTAINERS=(
        "remnawave"              # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞–Ω–µ–ª–∏
        "remnawave-db"           # –ë–î –ø–∞–Ω–µ–ª–∏
        "remnawave-redis"        # Redis –ø–∞–Ω–µ–ª–∏
        "remnawave-nginx"        # Nginx –ø–∞–Ω–µ–ª–∏
        "remnawave-subscription-page"   # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –ø–∞–Ω–µ–ª–∏
        "remnawave-telegram-mini-app"   # Mini App –ø–∞–Ω–µ–ª–∏
        "certwardenclient"       # Cert Warden
    )
    
    for container in $running_containers; do
        local c_name=$(echo "$container" | cut -d'|' -f1)
        local c_image=$(echo "$container" | cut -d'|' -f2)
        debug_log "SCAN" "Checking: $c_name ($c_image)"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞–Ω–µ–ª–∏
        local is_panel=false
        for panel_c in "${PANEL_CONTAINERS[@]}"; do
            if [[ "$c_name" == "$panel_c" ]]; then
                is_panel=true
                debug_log "SCAN" "  -> Skip (panel container: $panel_c)"
                break
            fi
        done
        
        # –ò—Å–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–∞–Ω–µ–ª–∏ –ø–æ image
        if [[ "$c_image" == *"remnawave/backend"* ]]; then is_panel=true; debug_log "SCAN" "  -> Skip (remnawave/backend)"; fi
        if [[ "$c_image" == *"remnawave/subscription-page"* ]]; then is_panel=true; debug_log "SCAN" "  -> Skip (subscription-page)"; fi
        if [[ "$c_image" == *"remnawave-telegram-sub-mini-app"* ]]; then is_panel=true; fi
        if [[ "$c_image" == *"certwarden-client"* ]]; then is_panel=true; fi
        if [[ "$c_image" == "nginx"* || "$c_image" == "postgres"* || "$c_image" == "redis"* ]]; then
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç "remnawave" –ë–ï–ó "shop"/"bot"
            if [[ "$c_name" == *"remnawave"* && "$c_name" != *"shop"* && "$c_name" != *"bot"* ]]; then
                is_panel=true
                debug_log "SCAN" "  -> Skip (panel infra)"
            fi
        fi
        
        if [[ "$is_panel" == true ]]; then continue; fi

        # –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–û–¢–ê –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        for key in "${KEYWORDS[@]}"; do
            if [[ "$c_image" == *"$key"* || "$c_name" == *"$key"* ]]; then
                debug_log "SCAN" "  -> MATCH! keyword=$key"
                FOUND_BOT="$c_name"
                local work_dir=$(docker inspect --format '{{ index .Config.Labels "com.docker.compose.project.working_dir" }}' "$c_name")
                debug_log "SCAN" "  -> working_dir=$work_dir"
                if [[ -n "$work_dir" && -d "$work_dir" ]]; then FOUND_PATH="$work_dir"; fi
                break 2
            fi
        done
    done
    
    debug_log "SCAN" "After container scan: FOUND_BOT=$FOUND_BOT, FOUND_PATH=$FOUND_PATH"

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ‚Äî –∏—â–µ–º –ø–æ —Ñ–∞–π–ª–∞–º docker-compose
    if [[ -z "$FOUND_PATH" ]]; then
        debug_log "SCAN" "No containers found, searching compose files..."
        local search_dirs=("/opt" "/home" "/root")
        local compose_files=$(find "${search_dirs[@]}" -maxdepth 4 -name "docker-compose.yml" -o -name "compose.yaml" 2> "$SILENT_LOG")
        for file in $compose_files; do
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º compose —Ñ–∞–π–ª—ã –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if grep -q "remnawave/backend" "$file"; then continue; fi
            if grep -q "remnawave/subscription-page" "$file"; then continue; fi
            
            # –ò—â–µ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –ë–û–¢–ê
            if grep -qE "image:.*($(IFS="|"; echo "${KEYWORDS[*]}"))" "$file" || grep -qE "container_name:.*($(IFS="|"; echo "${KEYWORDS[*]}"))" "$file"; then
                FOUND_PATH=$(dirname "$file")
                # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ container_name
                FOUND_BOT=$(grep -E "container_name:" "$file" | grep -E "($(IFS="|"; echo "${KEYWORDS[*]}"))" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
                
                # –ï—Å–ª–∏ container_name –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º docker compose –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                if [[ -z "$FOUND_BOT" && -d "$FOUND_PATH" ]]; then
                    cd "$FOUND_PATH" 2> "$SILENT_LOG"
                    # –ò—â–µ–º service –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—à image
                    for key in "${KEYWORDS[@]}"; do
                        local services=$(grep -B 2 "image:.*$key" "$file" | grep "^[a-z]" | head -1 | awk '{print $1}' | tr -d ':')
                        if [[ -n "$services" ]]; then
                            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ docker compose
                            FOUND_BOT=$(docker compose ps -a --format '{{.Name}}' "$services" 2> "$SILENT_LOG" | head -1)
                            [[ -n "$FOUND_BOT" ]] && break
                        fi
                    done
                    cd - > "$SILENT_LOG"
                fi
                break
            fi
        done
    fi

    # –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î
    if [[ -n "$FOUND_PATH" ]]; then
        if cd "$FOUND_PATH" 2> "$SILENT_LOG"; then
            local db_services=("db" "postgres" "database" "postgresql")
            for svc in "${db_services[@]}"; do
                local db_c=$(docker compose ps -a --format '{{.Name}}' "$svc" 2> "$SILENT_LOG")
                # –ò—Å–∫–ª—é—á–∞–µ–º –ë–î –ø–∞–Ω–µ–ª–∏
                if [[ -n "$db_c" && "$db_c" != "remnawave-db" && "$db_c" != *"remnawave_"* ]]; then 
                    FOUND_DB="$db_c"
                    break
                fi
            done
            cd - > "$SILENT_LOG"
        fi
    fi
}

# --- –§–£–ù–ö–¶–ò–ò –í–ï–†–°–ò–ò –ò –ü–û–ò–°–ö–ê ---

get_raw_bot_version() {
    if [[ -n "$BOT_CONTAINER_NAME" ]] && docker container inspect -f '{{.State.Running}}' "$BOT_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then
        local full_image=$(docker inspect -f '{{.Config.Image}}' "$BOT_CONTAINER_NAME")
        local ver="${full_image##*:}"
        echo "${ver:-Unknown}"
    else
        echo ""
    fi
}

get_bot_version_display() {
    local ver=$(get_raw_bot_version)
    if [[ -n "$ver" ]]; then echo "$ver"; else echo "N/A"; fi
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞
get_container_status() {
    if [[ -z "$BOT_CONTAINER_NAME" ]]; then
        echo "N/A"
        return
    fi
    
    local status
    status=$(docker inspect -f '{{.State.Status}}' "$BOT_CONTAINER_NAME" 2> "$SILENT_LOG")
    
    case "$status" in
        "running") echo "Online" ;;
        "exited"|"dead") echo "Offline" ;;
        "paused") echo "Paused" ;;
        "restarting") echo "Restarting" ;;
        *) echo "N/A" ;;
    esac
}

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ DB volume
get_db_volume_name() {
    debug_log "DB" "=== get_db_volume_name ==="
    debug_log "DB" "DB_CONTAINER_NAME=$DB_CONTAINER_NAME"
    
    if [[ -z "$DB_CONTAINER_NAME" ]]; then
        debug_log "DB" "ERROR: DB_CONTAINER_NAME is empty"
        echo ""
        return 1
    fi
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è volume –∏–∑ docker inspect
    debug_log "DB" "Trying docker inspect..."
    local volume=$(docker inspect -f '{{range .Mounts}}{{if eq .Type "volume"}}{{.Name}}{{end}}{{end}}' "$DB_CONTAINER_NAME" 2> "$SILENT_LOG")
    
    if [[ -n "$volume" ]]; then
        debug_log "DB" "Volume found via docker inspect: $volume"
        echo "$volume"
        return 0
    fi
    debug_log "DB" "No volume from docker inspect, trying compose fallback"
    
    # Fallback: –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑ docker-compose.yml
    if [[ -n "$BOT_PATH" && -d "$BOT_PATH" ]]; then
        local compose_file=""
        [[ -f "$BOT_PATH/compose.yaml" ]] && compose_file="$BOT_PATH/compose.yaml"
        [[ -f "$BOT_PATH/docker-compose.yml" ]] && compose_file="$BOT_PATH/docker-compose.yml"
        debug_log "DB" "Compose file: $compose_file"
        
        if [[ -n "$compose_file" ]]; then
            # –ò—â–µ–º volume –≤ —Å–µ–∫—Ü–∏–∏ volumes –ë–î (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö –ø—É—Ç–µ–π)
            # –ù–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: /var/lib/postgresql/data
            # –°—Ç–∞—Ä—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: /var/lib/postgresql
            local vol=$(grep -A 10 "^\s*$DB_SERVICE_NAME:" "$compose_file" | grep -E "volumes:" -A 5 | grep -oE "[a-zA-Z0-9_-]+:/var/lib/postgresql(/data)?" | cut -d':' -f1 | head -1)
            debug_log "DB" "Parsed volume name from compose: '$vol'"
            if [[ -n "$vol" ]]; then
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π volume
                if docker volume inspect "$vol" > /dev/null 2> "$SILENT_LOG"; then
                    debug_log "DB" "Volume exists: $vol"
                    echo "$vol"
                    return 0
                else
                    debug_log "DB" "Volume '$vol' does not exist in docker"
                fi
            fi
        fi
    fi
    
    # –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
    debug_log "DB" "No volume found, returning empty"
    echo ""
    return 1
}

# –ß—Ç–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env —Ñ–∞–π–ª–∞ –±–æ—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: read_bot_env "POSTGRES_USER" ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
read_bot_env() {
    local var_name="$1"
    local env_file=""
    
    if [[ -n "$BOT_PATH" && -d "$BOT_PATH" ]]; then
        [[ -f "$BOT_PATH/.env" ]] && env_file="$BOT_PATH/.env"
    fi
    
    if [[ -z "$env_file" ]]; then
        debug_log "DB" "read_bot_env: no .env file found for '$var_name'"
        echo ""
        return 1
    fi
    
    # –ß–∏—Ç–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑ .env (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ KEY=value –∏ KEY="value")
    local value=$(grep -E "^${var_name}=" "$env_file" 2>/dev/null | head -1 | cut -d'=' -f2- | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//")
    debug_log "DB" "read_bot_env: $var_name='$value' from $env_file"
    echo "$value"
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î –∏–∑ .env –±–æ—Ç–∞ –∏–ª–∏ fallback –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
get_db_user() {
    local env_user=$(read_bot_env "POSTGRES_USER")
    if [[ -n "$env_user" ]]; then
        debug_log "DB" "get_db_user: using env POSTGRES_USER=$env_user"
        echo "$env_user"
    else
        debug_log "DB" "get_db_user: using global DB_USER=$DB_USER"
        echo "$DB_USER"
    fi
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ .env –±–æ—Ç–∞ –∏–ª–∏ fallback –Ω–∞ postgres
get_db_name() {
    local env_db=$(read_bot_env "POSTGRES_DB")
    if [[ -n "$env_db" ]]; then
        debug_log "DB" "get_db_name: using env POSTGRES_DB=$env_db"
        echo "$env_db"
    else
        debug_log "DB" "get_db_name: using default 'postgres'"
        echo "postgres"
    fi
}

# --- –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ë–û–¢–ê ---

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (rwp_shop-3.23.0-amd64.tar ‚Üí 3.23.0)
extract_version_from_filename() {
    local filename="$1"
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:
    # - rwp_shop-3.23.0-amd64.tar (–Ω–æ–≤—ã–π)
    # - rwp_shop-3.23.0.tar
    # - private-remnawave-telegram-shop-bot-3.21.2-amd64.tar (—Å—Ç–∞—Ä—ã–π)
    # - telegram-shop-2.0.0.tar
    echo "$filename" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1
}

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –µ—Å–ª–∏ $1 > $2)
version_gt() {
    local v1="$1" v2="$2"
    # –†–∞–∑–±–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏ –Ω–∞ —á–∞—Å—Ç–∏
    local v1_major v1_minor v1_patch v2_major v2_minor v2_patch
    IFS='.' read -r v1_major v1_minor v1_patch <<< "$v1"
    IFS='.' read -r v2_major v2_minor v2_patch <<< "$v2"
    
    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª–∞–º (—É–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏)
    v1_major=$((10#${v1_major:-0})); v1_minor=$((10#${v1_minor:-0})); v1_patch=$((10#${v1_patch:-0}))
    v2_major=$((10#${v2_major:-0})); v2_minor=$((10#${v2_minor:-0})); v2_patch=$((10#${v2_patch:-0}))
    
    if [[ $v1_major -gt $v2_major ]]; then return 0; fi
    if [[ $v1_major -lt $v2_major ]]; then return 1; fi
    if [[ $v1_minor -gt $v2_minor ]]; then return 0; fi
    if [[ $v1_minor -lt $v2_minor ]]; then return 1; fi
    if [[ $v1_patch -gt $v2_patch ]]; then return 0; fi
    return 1
}

# –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–∑–∞ –±–æ—Ç–∞ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞–ø–∫–µ (–±–µ–∑ —Ä–µ–∫—É—Ä—Å–∏–∏)
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è: –Ω–æ–≤—ã–µ –∏ —Å—Ç–∞—Ä—ã–µ
find_bot_image_files() {
    local search_path="$1"
    # –ò—â–µ–º .tar —Ñ–∞–π–ª—ã —Å–æ –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏:
    # - rwp_shop-*.tar (–Ω–æ–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π)
    # - private-remnawave-telegram-shop-bot-*.tar (—Å—Ç–∞—Ä—ã–π)
    # - telegram-shop-*.tar (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)
    find "$search_path" -maxdepth 1 -type f \( \
        -name "rwp_shop*.tar" -o \
        -name "private-remnawave-telegram-shop-bot*.tar" -o \
        -name "telegram-shop*.tar" \
    \) 2> "$SILENT_LOG"
}

# –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–∑–∞ –≤–æ –≤—Å–µ—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø—É—Ç—è—Ö + BOT_PATH
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –≤–µ—Ä—Å–∏–∏ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
find_all_bot_image_files() {
    debug_log "SCAN" "=== find_all_bot_image_files() start ==="
    local search_paths=()
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—É—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
    # 1. –ü—É—Ç—å –∫ –±–æ—Ç—É (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
    [[ -n "$BOT_PATH" && -d "$BOT_PATH" ]] && search_paths+=("$BOT_PATH")
    
    # 2. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—É—Ç–∏
    [[ -d "/opt" ]] && search_paths+=("/opt")
    [[ -d "/root" ]] && search_paths+=("/root")
    
    # 3. –ü—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç BOT_PATH)
    if [[ -d "$DEFAULT_BOT_PATH" && "$DEFAULT_BOT_PATH" != "$BOT_PATH" ]]; then
        search_paths+=("$DEFAULT_BOT_PATH")
    fi
    
    debug_log "SCAN" "Search paths: ${search_paths[*]}"
    
    local all_files=""
    local seen_files=()
    
    for search_path in "${search_paths[@]}"; do
        debug_log "SCAN" "Searching in: $search_path (maxdepth=3)"
        # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ (maxdepth 3 –¥–ª—è —Ä–∞–∑—É–º–Ω–æ–π –≥–ª—É–±–∏–Ω—ã)
        while IFS= read -r file; do
            [[ -z "$file" ]] && continue
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã (–ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞)
            local fname=$(basename "$file")
            local is_dup=false
            for seen in "${seen_files[@]}"; do
                [[ "$seen" == "$fname" ]] && is_dup=true && break
            done
            
            if [[ "$is_dup" == "false" ]]; then
                debug_log "SCAN" "  Found: $file"
                seen_files+=("$fname")
                all_files+="$file"$'\n'
            else
                debug_log "SCAN" "  Duplicate skipped: $fname"
            fi
        done < <(find "$search_path" -maxdepth 3 -type f \( \
            -name "rwp_shop*.tar" -o \
            -name "private-remnawave-telegram-shop-bot*.tar" -o \
            -name "telegram-shop*.tar" \
        \) 2> "$SILENT_LOG")
    done
    
    # –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
    all_files="${all_files%$'\n'}"
    
    if [[ -z "$all_files" ]]; then
        debug_log "SCAN" "No image files found"
        echo ""
        return 1
    fi
    
    debug_log "SCAN" "Total unique files found: $(echo "$all_files" | wc -l)"
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä—Å–∏–∏ (–∏–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é, —Å–æ—Ä—Ç–∏—Ä—É–µ–º, –≤—ã–≤–æ–¥–∏–º)
    # –ù–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–≤—ã–º–∏ (sort -Vr)
    echo "$all_files" | while IFS= read -r file; do
        local version=$(extract_version_from_filename "$(basename "$file")")
        echo "$version|$file"
    done | sort -t'|' -k1 -Vr | cut -d'|' -f2
}

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (—Å–∞–º–æ–≥–æ –Ω–æ–≤–æ–≥–æ) —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–∑–∞
get_latest_bot_image_file() {
    local search_path="$1"
    local files=$(find_bot_image_files "$search_path")
    
    if [[ -z "$files" ]]; then
        echo ""
        return 1
    fi
    
    local latest_file=""
    local latest_version="0.0.0"
    
    while IFS= read -r file; do
        local version=$(extract_version_from_filename "$(basename "$file")")
        if [[ -n "$version" ]] && version_gt "$version" "$latest_version"; then
            latest_version="$version"
            latest_file="$file"
        fi
    done <<< "$files"
    
    echo "$latest_file"
}

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ image –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ tar —Ñ–∞–π–ª–∞
get_image_name_from_tar() {
    local tar_file="$1"
    # –ü–æ—Å–ª–µ docker load –≤—ã–≤–æ–¥–∏—Ç —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞ "Loaded image: rwp_shop:3.23.5"
    # –ù–æ –º—ã –º–æ–∂–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    local filename=$(basename "$tar_file")
    
    if [[ "$filename" == rwp_shop* ]]; then
        echo "rwp_shop"
    elif [[ "$filename" == private-remnawave-telegram-shop-bot* ]]; then
        echo "private-remnawave-telegram-shop-bot"
    elif [[ "$filename" == telegram-shop* ]]; then
        echo "telegram-shop"
    else
        echo "rwp_shop"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
    fi
}

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ image –≤–µ—Ä—Å–∏–∏ –≤ docker-compose —Ñ–∞–π–ª–µ
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è image
update_compose_image_version() {
    local compose_file="$1"
    local new_version="$2"
    local new_image_name="$3"  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∏–º—è –Ω–æ–≤–æ–≥–æ image
    
    debug_log "COMPOSE" "=== update_compose_image_version() ==="
    debug_log "COMPOSE" "  compose_file=$compose_file"
    debug_log "COMPOSE" "  new_version=$new_version"
    debug_log "COMPOSE" "  new_image_name=$new_image_name"
    
    if [[ ! -f "$compose_file" ]]; then
        debug_log "COMPOSE" "Compose file not found: $compose_file"
        print_message "ERROR" "Compose —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $compose_file"
        return 1
    fi
    
    # –ï—Å–ª–∏ –Ω–æ–≤–æ–µ –∏–º—è image –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º rwp_shop (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ)
    [[ -z "$new_image_name" ]] && new_image_name="rwp_shop"
    debug_log "COMPOSE" "Target image name: $new_image_name"
    
    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∏–º—ë–Ω image –±–æ—Ç–∞
    local image_patterns=(
        "rwp_shop"
        "private-remnawave-telegram-shop-bot"
        "telegram-shop"
        "shopbot"
    )
    
    local found=false
    for pattern in "${image_patterns[@]}"; do
        debug_log "COMPOSE" "Checking for pattern: $pattern"
        if grep -qE "image:\s*['\"]?${pattern}:" "$compose_file"; then
            debug_log "COMPOSE" "Pattern matched: $pattern"
            # –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ –Ω–æ–≤–æ–µ –∏–º—è –∏ –≤–µ—Ä—Å–∏—é
            sed -i -E "s|(image:\s*['\"]?)${pattern}:[0-9]+\.[0-9]+\.[0-9]+|\1${new_image_name}:${new_version}|g" "$compose_file"
            found=true
            debug_log "COMPOSE" "Sed replacement done: ${pattern} -> ${new_image_name}:${new_version}"
            print_message "SUCCESS" "Image –æ–±–Ω–æ–≤–ª—ë–Ω: ${pattern} ‚Üí ${new_image_name}:${new_version}"
            break
        fi
    done
    
    if [[ "$found" == "false" ]]; then
        debug_log "COMPOSE" "No matching image pattern found in compose file"
        print_message "ERROR" "–ù–µ –Ω–∞–π–¥–µ–Ω image –±–æ—Ç–∞ –≤ compose —Ñ–∞–π–ª–µ"
        print_message "INFO" "–ò—Å–∫–∞–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: ${image_patterns[*]}"
        return 1
    fi
    
    debug_log "COMPOSE" "update_compose_image_version() completed successfully"
    return 0
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ë–î
check_db_health() {
    local db_container="$1"
    local max_attempts="${2:-30}"
    local attempt=1
    
    debug_log "HEALTH" "check_db_health($db_container, max=$max_attempts)"
    
    while [[ $attempt -le $max_attempts ]]; do
        local health=$(docker inspect -f '{{.State.Health.Status}}' "$db_container" 2> "$SILENT_LOG")
        debug_log "HEALTH" "  attempt $attempt: health=$health"
        
        if [[ "$health" == "healthy" ]]; then
            debug_log "HEALTH" "DB healthy via docker healthcheck"
            return 0
        fi
        
        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ pg_isready
        if docker exec "$db_container" pg_isready -U "$DB_USER" > "$SILENT_LOG" 2>&1; then
            debug_log "HEALTH" "DB healthy via pg_isready"
            return 0
        fi
        
        echo -ne "\r  –û–∂–∏–¥–∞–Ω–∏–µ –ë–î... ($attempt/$max_attempts)"
        sleep 1
        ((attempt++))
    done
    
    debug_log "HEALTH" "DB health check failed after $max_attempts attempts"
    echo ""
    return 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
check_bot_health() {
    local bot_container="$1"
    local max_attempts="${2:-20}"
    local attempt=1
    
    debug_log "HEALTH" "check_bot_health($bot_container, max=$max_attempts)"
    
    while [[ $attempt -le $max_attempts ]]; do
        local status=$(docker inspect -f '{{.State.Status}}' "$bot_container" 2> "$SILENT_LOG")
        local running=$(docker inspect -f '{{.State.Running}}' "$bot_container" 2> "$SILENT_LOG")
        debug_log "HEALTH" "  attempt $attempt: status=$status, running=$running"
        
        if [[ "$status" == "running" && "$running" == "true" ]]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–µ—Å—Ç–∞—Ä—Ç—É–µ—Ç
            sleep 2
            local status2=$(docker inspect -f '{{.State.Status}}' "$bot_container" 2> "$SILENT_LOG")
            debug_log "HEALTH" "  stability check: status2=$status2"
            if [[ "$status2" == "running" ]]; then
                debug_log "HEALTH" "Bot healthy and stable"
                return 0
            fi
        fi
        
        echo -ne "\r  –û–∂–∏–¥–∞–Ω–∏–µ –±–æ—Ç–∞... ($attempt/$max_attempts)"
        sleep 1
        ((attempt++))
    done
    
    debug_log "HEALTH" "Bot health check failed after $max_attempts attempts"
    echo ""
    return 1
}

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –ë–î –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ rollback
get_latest_db_backup() {
    local latest=$(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_db_*.tar.gz" -o -name "lazarus_db_*.tar.gz.enc" \) -printf '%T@ %p\n' 2> "$SILENT_LOG" | sort -rn | head -1 | awk '{print $2}')
    echo "$latest"
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞
update_bot() {
    debug_log "UPDATE" "=== Starting update_bot() ==="
    clear_screen
    echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${GREEN}${BOLD}  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞${RESET}"
    echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    
    # === –≠–¢–ê–ü 1: –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–£–¢–ò –ö –ë–û–¢–£ ===
    debug_log "UPDATE" "[STAGE 1] Checking bot path..."
    local bot_path_ok=false
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π BOT_PATH
    if [[ -n "$BOT_PATH" && -d "$BOT_PATH" && ( -f "$BOT_PATH/docker-compose.yml" || -f "$BOT_PATH/compose.yaml" ) ]]; then
        bot_path_ok=true
        debug_log "UPDATE" "Bot path OK: $BOT_PATH"
    fi
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏
    if [[ "$bot_path_ok" == "false" ]]; then
        debug_log "UPDATE" "Bot path not configured, starting search..."
        print_message "INFO" "–ü—É—Ç—å –∫ –±–æ—Ç—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        if [[ -d "$DEFAULT_BOT_PATH" && ( -f "$DEFAULT_BOT_PATH/docker-compose.yml" || -f "$DEFAULT_BOT_PATH/compose.yaml" ) ]]; then
            debug_log "UPDATE" "Found bot at default path: $DEFAULT_BOT_PATH"
            print_message "SUCCESS" "–ù–∞–π–¥–µ–Ω –±–æ—Ç –≤ $DEFAULT_BOT_PATH"
            BOT_PATH="$DEFAULT_BOT_PATH"
            save_config
            bot_path_ok=true
        else
            debug_log "UPDATE" "Default path not found, running ensure_bot_path()..."
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–æ–∏—Å–∫
            if ! ensure_bot_path; then
                debug_log "UPDATE" "ensure_bot_path() failed, prompting manual input"
                echo ""
                print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É –±–æ—Ç–∞!"
                echo ""
                echo -e "–û–∂–∏–¥–∞–µ–º—ã–µ –ø—É—Ç–∏ (–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):"
                echo -e "  ${CYAN}/opt/private-remnawave-telegram-shop-bot/${RESET}"
                echo -e "  ${CYAN}/opt/remnawave-telegram-shop/${RESET}"
                echo ""
                echo -e "–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:"
                echo -e "  ‚îú‚îÄ‚îÄ compose.yaml (–∏–ª–∏ docker-compose.yml)"
                echo -e "  ‚îú‚îÄ‚îÄ .env"
                echo -e "  ‚îî‚îÄ‚îÄ rwp_shop-X.Y.Z-amd64.tar"
                echo ""
                read -erp "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤—Ä—É—á–Ω—É—é (Enter - $DEFAULT_BOT_PATH): " manual_path
                manual_path="${manual_path:-$DEFAULT_BOT_PATH}"
                
                if [[ -d "$manual_path" ]]; then
                    debug_log "UPDATE" "Manual path accepted: $manual_path"
                    BOT_PATH="$manual_path"
                    save_config
                    bot_path_ok=true
                else
                    debug_log "UPDATE" "Manual path not found: $manual_path"
                    print_message "ERROR" "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $manual_path"
                    read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
                    return 1
                fi
            else
                debug_log "UPDATE" "ensure_bot_path() success, BOT_PATH=$BOT_PATH"
                bot_path_ok=true
            fi
        fi
    fi
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–∏
    debug_log "UPDATE" "Final path check: bot_path_ok=$bot_path_ok, BOT_PATH=$BOT_PATH"
    if [[ "$bot_path_ok" == "false" || -z "$BOT_PATH" || ! -d "$BOT_PATH" ]]; then
        debug_log "UPDATE" "Path validation failed, aborting"
        print_message "ERROR" "–ü—É—Ç—å –∫ –±–æ—Ç—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    
    # === –≠–¢–ê–ü 2: –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–ï–ö–£–©–ï–ô –£–°–¢–ê–ù–û–í–ö–ï ===
    debug_log "UPDATE" "[STAGE 2] Getting current installation info..."
    local current_version=$(get_raw_bot_version)
    debug_log "UPDATE" "Current version raw: $current_version"
    if [[ -z "$current_version" || "$current_version" == "Unknown" ]]; then
        print_message "WARN" "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –±–æ—Ç–∞"
        current_version="0.0.0"
    fi
    
    local container_status=$(get_container_status)
    debug_log "UPDATE" "Container status: $container_status"
    
    echo -e "–ü—É—Ç—å –∫ –±–æ—Ç—É:     ${CYAN}$BOT_PATH${RESET}"
    echo -e "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:  ${CYAN}$current_version${RESET}"
    echo -e "–°—Ç–∞—Ç—É—Å:          ${CYAN}$container_status${RESET}"
    echo ""
    
    # === –≠–¢–ê–ü 3: –ü–û–ò–°–ö –§–ê–ô–õ–û–í –û–ë–†–ê–ó–û–í ===
    debug_log "UPDATE" "[STAGE 3] Searching for image files..."
    print_message "INFO" "–ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–∑–∞ –≤ /opt/, /root/, $BOT_PATH..."
    local image_files=$(find_all_bot_image_files)
    debug_log "UPDATE" "Image files found: $(echo "$image_files" | wc -l) files"
    
    if [[ -z "$image_files" ]]; then
        debug_log "UPDATE" "No image files found, aborting"
        echo ""
        print_message "WARN" "–§–∞–π–ª—ã –æ–±—Ä–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        echo ""
        echo -e "${BOLD}–ü—É—Ç–∏ –ø–æ–∏—Å–∫–∞:${RESET}"
        echo -e "  ${CYAN}/opt/${RESET} (—Å –ø–æ–¥–ø–∞–ø–∫–∞–º–∏)"
        echo -e "  ${CYAN}/root/${RESET} (—Å –ø–æ–¥–ø–∞–ø–∫–∞–º–∏)"
        [[ -n "$BOT_PATH" ]] && echo -e "  ${CYAN}$BOT_PATH/${RESET}"
        echo ""
        echo -e "${BOLD}–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤:${RESET}"
        echo -e "  ${CYAN}rwp_shop-X.Y.Z-amd64.tar${RESET}  (–Ω–æ–≤—ã–π, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)"
        echo -e "  ${GRAY}private-remnawave-telegram-shop-bot-X.Y.Z-amd64.tar${RESET}  (—Å—Ç–∞—Ä—ã–π)"
        echo ""
        echo -e "–°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª –∏–∑ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ –≤:"
        echo -e "  ${BOLD}$BOT_PATH/${RESET}"
        echo ""
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    
    # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    local files_count=$(echo "$image_files" | wc -l)
    debug_log "UPDATE" "Files count: $files_count"
    print_message "SUCCESS" "–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $files_count"
    
    # === –≠–¢–ê–ü 4: –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ù–ê–ô–î–ï–ù–ù–´–• –§–ê–ô–õ–û–í ===
    debug_log "UPDATE" "[STAGE 4] Displaying found files..."
    echo ""
    echo -e "${BOLD}–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–∑–æ–≤ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏):${RESET}"
    local i=1
    local files_array=()
    while IFS= read -r file; do
        [[ -z "$file" ]] && continue
        local fname=$(basename "$file")
        local fdir=$(dirname "$file")
        local fversion=$(extract_version_from_filename "$fname")
        local fsize=$(du -h "$file" 2>/dev/null | cut -f1)
        local fimage=$(get_image_name_from_tar "$file")
        files_array+=("$file")
        debug_log "UPDATE" "  [$i] $fname (v$fversion, size=$fsize, image=$fimage)"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
        local type_label=""
        if [[ "$fname" == rwp_shop* ]]; then
            type_label="${GREEN}[–Ω–æ–≤—ã–π]${RESET}"
        elif [[ "$fname" == private-remnawave* ]]; then
            type_label="${GRAY}[—Å—Ç–∞—Ä—ã–π]${RESET}"
        fi
        
        # –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–æ–≤–µ–µ
        if version_gt "$fversion" "$current_version"; then
            echo -e " ${GREEN}$i. $fname${RESET}"
            echo -e "    v$fversion | $fsize | $type_label ${GREEN}‚Üê –û–ë–ù–û–í–õ–ï–ù–ò–ï${RESET}"
            echo -e "    ${GRAY}$fdir${RESET}"
        elif [[ "$fversion" == "$current_version" ]]; then
            echo -e " ${YELLOW}$i. $fname${RESET}"
            echo -e "    v$fversion | $fsize | $type_label ${YELLOW}(—Ç–µ–∫—É—â–∞—è)${RESET}"
            echo -e "    ${GRAY}$fdir${RESET}"
        else
            echo -e " ${GRAY}$i. $fname${RESET}"
            echo -e "    v$fversion | $fsize | $type_label"
            echo -e "    ${GRAY}$fdir${RESET}"
        fi
        ((i++))
    done <<< "$image_files"
    
    echo ""
    echo " 0. –ù–∞–∑–∞–¥"
    echo ""
    
    # === –≠–¢–ê–ü 5: –í–´–ë–û–† –§–ê–ô–õ–ê ===
    debug_log "UPDATE" "[STAGE 5] File selection..."
    # –ü–µ—Ä–≤—ã–π —Ñ–∞–π–ª –≤ —Å–ø–∏—Å–∫–µ = —Å–∞–º–∞—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (–ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)
    local latest_file="${files_array[0]}"
    local latest_version=$(extract_version_from_filename "$(basename "$latest_file")")
    debug_log "UPDATE" "Latest file: $(basename "$latest_file"), version: $latest_version"
    
    local choice=""
    if ! version_gt "$latest_version" "$current_version"; then
        debug_log "UPDATE" "Current version is latest ($current_version >= $latest_version)"
        print_message "INFO" "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è ($current_version)"
        echo ""
        read -erp "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∏–ª–∏ Enter - –Ω–∞–∑–∞–¥): " choice
        [[ -z "$choice" || "$choice" == "0" ]] && return 0
    else
        debug_log "UPDATE" "Update available: $current_version -> $latest_version"
        echo -e "${YELLOW}${BOLD}–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: $current_version ‚Üí $latest_version${RESET}"
        echo ""
        read -erp "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª (Enter - –ø–æ—Å–ª–µ–¥–Ω–∏–π v$latest_version): " choice
        [[ -z "$choice" ]] && choice=1
    fi
    
    debug_log "UPDATE" "User choice: $choice"
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞
    if [[ "$choice" == "0" ]]; then return 0; fi
    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [[ "$choice" -lt 1 ]] || [[ "$choice" -gt "${#files_array[@]}" ]]; then
        debug_log "UPDATE" "Invalid choice: $choice (valid: 1-${#files_array[@]})"
        print_message "ERROR" "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        sleep 1
        return 1
    fi
    
    local selected_file="${files_array[$((choice-1))]}"
    local selected_version=$(extract_version_from_filename "$(basename "$selected_file")")
    local selected_image_name=$(get_image_name_from_tar "$selected_file")
    debug_log "UPDATE" "Selected: file=$selected_file, version=$selected_version, image=$selected_image_name"
    
    # === –≠–¢–ê–ü 6: –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï ===
    debug_log "UPDATE" "[STAGE 6] User confirmation..."
    echo ""
    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${BOLD}–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:${RESET} $(basename "$selected_file")"
    echo -e "${BOLD}–í–µ—Ä—Å–∏—è:${RESET}      $selected_version"
    echo -e "${BOLD}Image:${RESET}       $selected_image_name"
    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    
    echo -e "${YELLOW}${BOLD}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ö –ü–†–û–ß–¢–ï–ù–ò–Æ:${RESET}"
    echo ""
    echo -e " ${GREEN}‚úì${RESET} –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø (–ë–î + —Ñ–∞–π–ª—ã)"
    echo -e " ${GREEN}‚úì${RESET} –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –±—ç–∫–∞–ø –ë–î"
    echo -e " ${GREEN}‚úì${RESET} Compose —Ñ–∞–π–ª –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
    echo ""
    echo -e " ${YELLOW}!${RESET} –ë–æ—Ç –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    echo -e " ${YELLOW}!${RESET} –ü—Ä–∏ –æ—à–∏–±–∫–µ –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ç–∫–∞—Ç –∏–∑ –±—ç–∫–∞–ø–∞"
    echo ""
    
    read -erp "–ù–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ? (y/N): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        debug_log "UPDATE" "User cancelled update"
        print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ"
        return 0
    fi
    
    # === –≠–¢–ê–ü 7: –°–û–ó–î–ê–ù–ò–ï –ë–≠–ö–ê–ü–û–í ===
    debug_log "UPDATE" "[STAGE 7] Creating pre-update backups..."
    echo ""
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –°–û–ó–î–ê–ù–ò–ï –ë–≠–ö–ê–ü–û–í ‚ïê‚ïê‚ïê${RESET}"
    log_message "INFO" "Starting bot update: $current_version -> $selected_version"
    
    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤
    local update_start_time=$(date +%s)
    
    debug_log "UPDATE" "Creating full backup..."
    print_message "INFO" "[1/7] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞..."
    create_backup "full"
    local backup_result=$?
    debug_log "UPDATE" "Full backup result: $backup_result"
    
    if [[ $backup_result -ne 0 ]]; then
        debug_log "UPDATE" "Full backup FAILED, aborting update"
        print_message "ERROR" "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞! –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
        log_message "ERROR" "Bot update aborted: full backup failed"
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    print_message "SUCCESS" "–ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω"
    
    debug_log "UPDATE" "Creating DB backup..."
    print_message "INFO" "[2/7] –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î..."
    create_backup "db_only"
    local db_backup_result=$?
    debug_log "UPDATE" "DB backup result: $db_backup_result"
    
    if [[ $db_backup_result -ne 0 ]]; then
        print_message "WARN" "–ë—ç–∫–∞–ø –ë–î –Ω–µ —Å–æ–∑–¥–∞–Ω (–ø–æ–ª–Ω—ã–π –±—ç–∫–∞–ø –µ—Å—Ç—å)"
    else
        print_message "SUCCESS" "–ë—ç–∫–∞–ø –ë–î —Å–æ–∑–¥–∞–Ω"
    fi
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –±—ç–∫–∞–ø—É –ë–î –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ rollback
    local rollback_backup=$(get_latest_db_backup)
    debug_log "UPDATE" "Rollback backup: $rollback_backup"
    
    # === –≠–¢–ê–ü 8: –ó–ê–ì–†–£–ó–ö–ê DOCKER IMAGE ===
    debug_log "UPDATE" "[STAGE 8] Loading Docker image..."
    echo ""
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê IMAGE ‚ïê‚ïê‚ïê${RESET}"
    print_message "INFO" "[3/7] –ó–∞–≥—Ä—É–∑–∫–∞ Docker image..."
    debug_log "DOCKER" "Running: docker load -i $selected_file"
    
    local load_output
    load_output=$(docker load -i "$selected_file" 2>&1)
    local load_result=$?
    debug_log "DOCKER" "docker load result: $load_result"
    debug_log "DOCKER" "docker load output: $load_output"
    
    if [[ $load_result -ne 0 ]]; then
        debug_log "DOCKER" "docker load FAILED"
        print_message "ERROR" "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ image!"
        echo "$load_output"
        log_message "ERROR" "Bot update failed: docker load error"
        echo ""
        print_message "INFO" "–ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞–Ω—ã. –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–Ω—ã."
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ image
    local loaded_image=$(echo "$load_output" | grep -oE "Loaded image: [^ ]+" | cut -d' ' -f3)
    debug_log "DOCKER" "Loaded image from output: $loaded_image"
    if [[ -n "$loaded_image" ]]; then
        print_message "SUCCESS" "Image –∑–∞–≥—Ä—É–∂–µ–Ω: $loaded_image"
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è image –±–µ–∑ –≤–µ—Ä—Å–∏–∏
        selected_image_name="${loaded_image%%:*}"
        debug_log "DOCKER" "Image name extracted: $selected_image_name"
    else
        print_message "SUCCESS" "Image –∑–∞–≥—Ä—É–∂–µ–Ω"
        echo "$load_output" | grep -i "loaded" | head -1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ image –ø–æ—è–≤–∏–ª—Å—è
    debug_log "DOCKER" "Verifying image in docker images..."
    if ! docker images | grep -q "$selected_image_name.*$selected_version"; then
        debug_log "DOCKER" "Image not found in list, showing available:"
        print_message "WARN" "Image –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ"
        docker images | grep -E "(rwp_shop|telegram-shop|private-remnawave)" | head -5
    else
        debug_log "DOCKER" "Image verified in docker images list"
    fi
    
    # === –≠–¢–ê–ü 9: –û–ë–ù–û–í–õ–ï–ù–ò–ï COMPOSE –§–ê–ô–õ–ê ===
    debug_log "UPDATE" "[STAGE 9] Updating compose file..."
    echo ""
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ‚ïê‚ïê‚ïê${RESET}"
    
    local compose_file=""
    [[ -f "$BOT_PATH/compose.yaml" ]] && compose_file="$BOT_PATH/compose.yaml"
    [[ -f "$BOT_PATH/docker-compose.yml" ]] && compose_file="$BOT_PATH/docker-compose.yml"
    debug_log "COMPOSE" "Compose file: $compose_file"
    
    if [[ -z "$compose_file" ]]; then
        debug_log "COMPOSE" "No compose file found in $BOT_PATH"
        print_message "ERROR" "Compose —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        log_message "ERROR" "Bot update failed: compose file not found"
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    
    print_message "INFO" "[4/7] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ compose —Ñ–∞–π–ª–∞..."
    
    # –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø compose —Ñ–∞–π–ª–∞
    debug_log "COMPOSE" "Creating backup: ${compose_file}.pre-update.bak"
    cp "$compose_file" "${compose_file}.pre-update.bak"
    
    debug_log "COMPOSE" "Calling update_compose_image_version($compose_file, $selected_version, $selected_image_name)"
    if ! update_compose_image_version "$compose_file" "$selected_version" "$selected_image_name"; then
        debug_log "COMPOSE" "update_compose_image_version FAILED, restoring backup"
        print_message "ERROR" "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è compose!"
        mv "${compose_file}.pre-update.bak" "$compose_file"
        log_message "ERROR" "Bot update failed: compose update error"
        echo ""
        print_message "INFO" "Compose —Ñ–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –±—ç–∫–∞–ø–∞."
        read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
        return 1
    fi
    
    # === –≠–¢–ê–ü 10: –û–°–¢–ê–ù–û–í–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ===
    debug_log "UPDATE" "[STAGE 10] Stopping containers..."
    echo ""
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ü–ï–†–ï–ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ‚ïê‚ïê‚ïê${RESET}"
    print_message "INFO" "[5/7] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    
    cd "$BOT_PATH"
    debug_log "CONTAINER" "Running: docker compose down in $BOT_PATH"
    docker compose down 2> "$SILENT_LOG"
    local down_result=$?
    debug_log "CONTAINER" "docker compose down result: $down_result"
    sleep 2
    
    # === –≠–¢–ê–ü 11: –ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ===
    debug_log "UPDATE" "[STAGE 11] Starting containers..."
    print_message "INFO" "[6/7] –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    debug_log "CONTAINER" "Running: docker compose up -d"
    docker compose up -d 2> "$SILENT_LOG"
    local up_result=$?
    debug_log "CONTAINER" "docker compose up result: $up_result"
    
    # === –≠–¢–ê–ü 12: –ü–†–û–í–ï–†–ö–ê –ó–î–û–†–û–í–¨–Ø ===
    debug_log "UPDATE" "[STAGE 12] Health checks..."
    print_message "INFO" "[7/7] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
    echo ""
    
    # –ñ–¥—ë–º –ë–î
    if [[ -n "$DB_CONTAINER_NAME" ]]; then
        debug_log "HEALTH" "Checking DB health for: $DB_CONTAINER_NAME"
        echo -n "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î..."
        if check_db_health "$DB_CONTAINER_NAME" 30; then
            debug_log "HEALTH" "DB health check: OK"
            echo -e " ${GREEN}OK${RESET}"
        else
            debug_log "HEALTH" "DB health check: WARN (may still be initializing)"
            echo -e " ${YELLOW}WARN${RESET}"
            print_message "WARN" "–ë–î –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –º–æ–∂–µ—Ç –µ—â—ë –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è"
        fi
    fi
    
    # –ñ–¥—ë–º –±–æ—Ç–∞
    if [[ -n "$BOT_CONTAINER_NAME" ]]; then
        debug_log "HEALTH" "Checking bot health for: $BOT_CONTAINER_NAME"
        echo -n "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞..."
        if check_bot_health "$BOT_CONTAINER_NAME" 20; then
            debug_log "HEALTH" "Bot health check: OK"
            echo -e " ${GREEN}OK${RESET}"
        else
            debug_log "HEALTH" "Bot health check: FAIL"
            echo -e " ${RED}FAIL${RESET}"
        fi
    fi
    
    sleep 2
    
    # === –≠–¢–ê–ü 13: –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ===
    debug_log "UPDATE" "[STAGE 13] Final verification..."
    local new_version=$(get_raw_bot_version)
    local new_status=$(get_container_status)
    debug_log "UPDATE" "New version: $new_version, status: $new_status"
    
    echo ""
    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    
    if [[ "$new_status" == "Online" ]]; then
        if [[ "$new_version" == "$selected_version" ]]; then
            debug_log "UPDATE" "=== Update SUCCESS: $current_version -> $new_version ==="
            echo -e "${GREEN}${BOLD}‚úì –û–ë–ù–û–í–õ–ï–ù–ò–ï –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û${RESET}"
            echo ""
            echo -e "  –í–µ—Ä—Å–∏—è: ${CYAN}$current_version${RESET} ‚Üí ${GREEN}$new_version${RESET}"
            echo -e "  –°—Ç–∞—Ç—É—Å: ${GREEN}$new_status${RESET}"
            log_message "SUCCESS" "Bot updated successfully: $current_version -> $new_version"
            
            # –£–¥–∞–ª—è–µ–º –±—ç–∫–∞–ø compose —Ñ–∞–π–ª–∞
            debug_log "UPDATE" "Removing compose backup file"
            rm -f "${compose_file}.pre-update.bak"
            
            echo ""
            read -erp "–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –æ–±—Ä–∞–∑–∞ $(basename "$selected_file")? (y/N): " del_confirm
            if [[ "$del_confirm" == "y" || "$del_confirm" == "Y" ]]; then
                debug_log "UPDATE" "Deleting image file: $selected_file"
                rm -f "$selected_file"
                print_message "SUCCESS" "–§–∞–π–ª —É–¥–∞–ª—ë–Ω"
            fi
        else
            debug_log "UPDATE" "=== Update WARN: version mismatch (expected=$selected_version, got=$new_version) ==="
            echo -e "${YELLOW}${BOLD}‚ö† –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –° –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï–ú${RESET}"
            echo ""
            echo -e "  –û–∂–∏–¥–∞–ª–∞—Å—å –≤–µ—Ä—Å–∏—è: ${CYAN}$selected_version${RESET}"
            echo -e "  –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:   ${YELLOW}$new_version${RESET}"
            echo -e "  –°—Ç–∞—Ç—É—Å:           ${GREEN}$new_status${RESET}"
            echo ""
            print_message "INFO" "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤–µ—Ä—Å–∏—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è"
            log_message "WARN" "Bot update: version mismatch (expected=$selected_version, got=$new_version)"
        fi
    else
        debug_log "UPDATE" "=== Update FAILED: container not running (status=$new_status) ==="
        echo -e "${RED}${BOLD}‚úó –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –° –û–®–ò–ë–ö–û–ô${RESET}"
        echo ""
        echo -e "  –°—Ç–∞—Ç—É—Å: ${RED}$new_status${RESET}"
        echo ""
        log_message "ERROR" "Bot update failed: container not running after update"
        
        echo -e "${YELLOW}–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:${RESET}"
        echo "  docker compose ps"
        echo "  docker compose logs -f bot"
        echo ""
        
        echo -e "${YELLOW}–î–ª—è –æ—Ç–∫–∞—Ç–∞:${RESET}"
        if [[ -n "$rollback_backup" ]]; then
            echo "  1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –±—ç–∫–∞–ø–∞ (–º–µ–Ω—é 3)"
            echo "  2. –ò–ª–∏ –≤—Ä—É—á–Ω—É—é: docker compose down && mv ${compose_file}.pre-update.bak $compose_file && docker compose up -d"
        fi
        echo ""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
        echo -e "${GRAY}–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:${RESET}"
        docker compose logs --tail 10 bot 2> "$SILENT_LOG" | tail -5
    fi
    
    echo -e "${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
    return 0
}

detect_bot_installation() {
    debug_log "SCAN" "=== detect_bot_installation ==="
    print_message "INFO" "–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞..."
    scan_system_for_bot 
    if [[ -n "$FOUND_PATH" ]]; then
        debug_log "SCAN" "Found installation: PATH=$FOUND_PATH, BOT=$FOUND_BOT, DB=$FOUND_DB"
        echo ""; print_message "SUCCESS" "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞!"
        echo -e "   –ü—É—Ç—å:      ${BOLD}$FOUND_PATH${RESET}"
        [[ -n "$FOUND_BOT" ]] && echo -e "   –ë–æ—Ç:       ${BOLD}$FOUND_BOT${RESET}"
        [[ -n "$FOUND_DB" ]]  && echo -e "   –ë–î:        ${BOLD}$FOUND_DB${RESET}"
        echo ""
        read -erp "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? (Y/n): " confirm
        if [[ -z "$confirm" || "$confirm" =~ ^[Yy]$ ]]; then
            debug_log "SCAN" "User confirmed, applying settings"
            BOT_PATH="$FOUND_PATH"
            if [[ -n "$FOUND_BOT" ]]; then BOT_CONTAINER_NAME="$FOUND_BOT"; fi
            if [[ -n "$FOUND_DB" ]]; then DB_CONTAINER_NAME="$FOUND_DB"; fi
            save_config; print_message "SUCCESS" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."; return 0
        else
            debug_log "SCAN" "User declined auto-detected settings"
        fi
    else
        debug_log "SCAN" "No installation found by auto-detection"
    fi
    print_message "WARN" "–ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."
    return 1
}

# --- –ü–†–û–í–ï–†–ö–ê –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–ô ---

check_config_mismatch() {
    debug_log "CONFIG" "=== check_config_mismatch ==="
    debug_log "CONFIG" "BOT_CONTAINER_NAME=$BOT_CONTAINER_NAME, IGNORE_MISMATCH=$IGNORE_MISMATCH"
    if [[ -n "$BOT_CONTAINER_NAME" && "$IGNORE_MISMATCH" != "true" ]]; then
        debug_log "CONFIG" "Checking if container exists..."
        if ! docker inspect "$BOT_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then
            debug_log "CONFIG" "Container '$BOT_CONTAINER_NAME' NOT found, scanning for alternatives"
            scan_system_for_bot
            if [[ -n "$FOUND_BOT" && "$FOUND_BOT" != "$BOT_CONTAINER_NAME" ]]; then
                debug_log "CONFIG" "Found alternative: $FOUND_BOT (was: $BOT_CONTAINER_NAME)"
                echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä '$BOT_CONTAINER_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–∞–π–¥–µ–Ω '$FOUND_BOT'."
                echo -e " ${GREEN}–ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.${RESET}"
                read -erp "–û–±–Ω–æ–≤–∏—Ç—å? (Y/n): " upd
                if [[ -z "$upd" || "$upd" =~ ^[Yy]$ ]]; then
                    debug_log "CONFIG" "User confirmed update to new container"
                    BOT_CONTAINER_NAME="$FOUND_BOT"
                    [[ -n "$FOUND_DB" ]] && DB_CONTAINER_NAME="$FOUND_DB"
                    [[ -n "$FOUND_PATH" ]] && BOT_PATH="$FOUND_PATH"
                    save_config; print_message "SUCCESS" "–û–±–Ω–æ–≤–ª–µ–Ω–æ."; sleep 1
                else
                    debug_log "CONFIG" "User declined, setting IGNORE_MISMATCH=true"
                    IGNORE_MISMATCH="true"; save_config
                fi
            fi
        else
            debug_log "CONFIG" "Container '$BOT_CONTAINER_NAME' exists"
        fi
    fi
}

ensure_bot_path() {
    debug_log "CONFIG" "=== ensure_bot_path ==="
    debug_log "CONFIG" "Current: BOT_PATH=$BOT_PATH, BOT=$BOT_CONTAINER_NAME, DB=$DB_CONTAINER_NAME"
    
    if [[ -z "$BOT_CONTAINER_NAME" || -z "$DB_CONTAINER_NAME" ]]; then
        debug_log "CONFIG" "Container names empty, starting detection"
        echo ""; print_message "WARN" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø—É—Å—Ç—ã."
        detect_bot_installation; load_or_create_config 
    fi

    local path_valid=false
    if [[ -n "$BOT_PATH" && -d "$BOT_PATH" && ( -f "$BOT_PATH/docker-compose.yml" || -f "$BOT_PATH/compose.yaml" ) ]]; then path_valid=true; fi
    debug_log "CONFIG" "path_valid=$path_valid (BOT_PATH=$BOT_PATH)"
    
    local container_valid=false
    if [[ -n "$BOT_CONTAINER_NAME" ]] && docker inspect "$BOT_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then container_valid=true; fi
    debug_log "CONFIG" "container_valid=$container_valid (BOT_CONTAINER=$BOT_CONTAINER_NAME)"
    
    local db_valid=false
    if [[ -n "$DB_CONTAINER_NAME" ]] && docker inspect "$DB_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then db_valid=true; fi
    debug_log "CONFIG" "db_valid=$db_valid (DB_CONTAINER=$DB_CONTAINER_NAME)"

    if [[ "$path_valid" == "false" || "$container_valid" == "false" || "$db_valid" == "false" ]]; then
        debug_log "CONFIG" "Some validations failed, attempting auto-detection"
        if [[ "$path_valid" == "false" ]]; then
            detect_bot_installation; load_or_create_config
            if [[ -n "$BOT_PATH" ]]; then path_valid=true; fi
            if [[ -n "$BOT_CONTAINER_NAME" ]]; then container_valid=true; fi
            if [[ -n "$DB_CONTAINER_NAME" ]]; then db_valid=true; fi
            debug_log "CONFIG" "After detection: path=$path_valid, container=$container_valid, db=$db_valid"
        fi

        if [[ -z "$BOT_PATH" || ! -d "$BOT_PATH" ]]; then
            debug_log "CONFIG" "BOT_PATH still invalid, prompting user"
            echo ""; print_message "ACTION" "–£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –±–æ—Ç–∞ –≤—Ä—É—á–Ω—É—é."
            read -erp "–ü—É—Ç—å (Enter –¥–ª—è '$DEFAULT_BOT_PATH'): " input_path
            BOT_PATH="${input_path:-$DEFAULT_BOT_PATH}"
            debug_log "CONFIG" "User entered BOT_PATH=$BOT_PATH"
            if [[ ! -d "$BOT_PATH" ]]; then 
                debug_log "CONFIG" "ERROR: Path does not exist"
                print_message "ERROR" "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; return 1
            fi
            save_config
        fi

        if [[ -z "$BOT_CONTAINER_NAME" ]] || ! docker inspect "$BOT_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then
            debug_log "CONFIG" "BOT_CONTAINER_NAME invalid, prompting user"
            echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω."
            print_message "ACTION" "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞ (–∫–∞–∫ –≤ 'docker ps')."
            read -erp "–ò–º—è (Enter –¥–ª—è '$DEFAULT_BOT_CONTAINER'): " input_name
            BOT_CONTAINER_NAME="${input_name:-$DEFAULT_BOT_CONTAINER}"
            debug_log "CONFIG" "User entered BOT_CONTAINER_NAME=$BOT_CONTAINER_NAME"
            save_config
        fi

        if [[ -z "$DB_CONTAINER_NAME" ]] || ! docker inspect "$DB_CONTAINER_NAME" > /dev/null 2> "$SILENT_LOG"; then
            debug_log "CONFIG" "DB_CONTAINER_NAME invalid, prompting user"
            echo ""; print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω."
            print_message "ACTION" "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î."
            read -erp "–ò–º—è –ë–î (Enter –¥–ª—è '$DEFAULT_DB_CONTAINER'): " input_db
            DB_CONTAINER_NAME="${input_db:-$DEFAULT_DB_CONTAINER}"
            debug_log "CONFIG" "User entered DB_CONTAINER_NAME=$DB_CONTAINER_NAME"
            save_config
        fi
    fi
    debug_log "CONFIG" "=== ensure_bot_path completed ==="
    return 0
}

save_config() {
    debug_log "CONFIG" "=== save_config ==="
    debug_log "CONFIG" "Creating config dir: $INSTALL_DIR"
    mkdir -p "$INSTALL_DIR"
    debug_log "CONFIG" "Writing config to: $CONFIG_FILE"
    cat > "$CONFIG_FILE" <<EOF
BOT_TOKEN="$BOT_TOKEN"
CHAT_ID="$CHAT_ID"
TG_MESSAGE_THREAD_ID="$TG_MESSAGE_THREAD_ID"
BOT_PATH="$BOT_PATH"
DB_USER="$DB_USER"
SCHEDULE_FULL="$SCHEDULE_FULL"
SCHEDULE_DB="$SCHEDULE_DB"
SCHEDULE_FILES="$SCHEDULE_FILES"
MAX_BACKUPS_COUNT="$MAX_BACKUPS_COUNT"
BOT_CONTAINER_NAME="$BOT_CONTAINER_NAME"
DB_CONTAINER_NAME="$DB_CONTAINER_NAME"
IGNORE_MISMATCH="$IGNORE_MISMATCH"
EXCLUDE_DIRS="$EXCLUDE_DIRS"
MAX_FILE_SIZE_MB="$MAX_FILE_SIZE_MB"
REMOTE_STORAGE_TYPE="$REMOTE_STORAGE_TYPE"
REMOTE_STORAGE_URL="$REMOTE_STORAGE_URL"
REMOTE_STORAGE_USER="$REMOTE_STORAGE_USER"
REMOTE_STORAGE_PASS="$REMOTE_STORAGE_PASS"
BACKUP_PASSWORD="$BACKUP_PASSWORD"
SEND_TO_TELEGRAM="$SEND_TO_TELEGRAM"
TG_SEND_FILE="$TG_SEND_FILE"
SEND_TO_REMOTE="$SEND_TO_REMOTE"
DELETE_MODE="$DELETE_MODE"
RETENTION_DAYS="$RETENTION_DAYS"
MAX_BACKUP_SIZE_MB="$MAX_BACKUP_SIZE_MB"
EOF
    chmod 600 "$CONFIG_FILE"
    debug_log "CONFIG" "Config saved, chmod 600 applied"
    debug_log "CONFIG" "BOT_PATH=$BOT_PATH"
    debug_log "CONFIG" "BOT_CONTAINER=$BOT_CONTAINER_NAME, DB_CONTAINER=$DB_CONTAINER_NAME"
    debug_log "CONFIG" "REMOTE_STORAGE_TYPE=$REMOTE_STORAGE_TYPE"
    debug_log "CONFIG" "DELETE_MODE=$DELETE_MODE, MAX_BACKUPS=$MAX_BACKUPS_COUNT, RETENTION=$RETENTION_DAYS days"
    debug_log "CONFIG" "MAX_BACKUP_SIZE_MB=$MAX_BACKUP_SIZE_MB"
}

load_or_create_config() {
    debug_log "CONFIG" "=== load_or_create_config ==="
    debug_log "CONFIG" "Config file: $CONFIG_FILE"
    if [[ -f "$CONFIG_FILE" ]]; then 
        debug_log "CONFIG" "Config exists, sourcing..."
        source "$CONFIG_FILE"
        debug_log "CONFIG" "Config loaded successfully"
    else
        debug_log "CONFIG" "Config file not found, using defaults"
    fi
    if [[ -z "$MAX_BACKUPS_COUNT" ]]; then MAX_BACKUPS_COUNT=100; fi
    if [[ -z "$IGNORE_MISMATCH" ]]; then IGNORE_MISMATCH="false"; fi
    if [[ -z "$MAX_FILE_SIZE_MB" ]]; then MAX_FILE_SIZE_MB="1"; fi
    if [[ -z "$REMOTE_STORAGE_TYPE" ]]; then REMOTE_STORAGE_TYPE="off"; fi
    if [[ -z "$SEND_TO_TELEGRAM" ]]; then SEND_TO_TELEGRAM="true"; fi
    if [[ -z "$TG_SEND_FILE" ]]; then TG_SEND_FILE="true"; fi
    if [[ -z "$SEND_TO_REMOTE" ]]; then SEND_TO_REMOTE="true"; fi
    if [[ -z "$DELETE_MODE" ]]; then DELETE_MODE="time"; fi
    if [[ -z "$RETENTION_DAYS" ]]; then RETENTION_DAYS="7"; fi
    if [[ -z "$MAX_BACKUP_SIZE_MB" ]]; then MAX_BACKUP_SIZE_MB="0"; fi
    debug_log "CONFIG" "Defaults applied: MAX_BACKUPS=$MAX_BACKUPS_COUNT, DELETE_MODE=$DELETE_MODE"
    debug_log "CONFIG" "Creating backup dir: $BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"

    local updated=false
    if [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]]; then
        debug_log "CONFIG" "Telegram settings missing, prompting user"
        echo ""; print_message "WARN" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
        [[ -z "$BOT_TOKEN" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ Bot Token: " BOT_TOKEN
        [[ -z "$CHAT_ID" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ Chat ID: " CHAT_ID
        [[ -z "$TG_MESSAGE_THREAD_ID" ]] && read -erp " –í–≤–µ–¥–∏—Ç–µ ID —Ç–æ–ø–∏–∫–∞ (–∏–ª–∏ Enter): " TG_MESSAGE_THREAD_ID
        updated=true
        debug_log "CONFIG" "Telegram settings received from user"
    fi
    
    if [[ -z "$BOT_PATH" || -z "$BOT_CONTAINER_NAME" || -z "$DB_CONTAINER_NAME" ]]; then 
        debug_log "CONFIG" "Bot installation not configured, starting detection"
        detect_bot_installation
    fi
    
    if $updated; then 
        debug_log "CONFIG" "Config updated, saving..."
        save_config
    fi
    debug_log "CONFIG" "=== load_or_create_config completed ==="
}

send_telegram_document() {
    local file_path="$1"; local caption="$2"
    debug_log "TG" "=== send_telegram_document ==="
    debug_log "TG" "File: $file_path"
    debug_log "TG" "SEND_TO_TELEGRAM=$SEND_TO_TELEGRAM, TG_SEND_FILE=$TG_SEND_FILE"
    [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]] && { debug_log "TG" "Missing BOT_TOKEN or CHAT_ID"; return 1; }
    
    # –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω—ã
    if [[ "$SEND_TO_TELEGRAM" != "true" ]]; then
        print_message "INFO" "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram –æ—Ç–∫–ª—é—á–µ–Ω—ã."
        debug_log "TG" "Notifications disabled, skipping"
        return 0
    fi
    
    # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if [[ "$TG_SEND_FILE" != "true" ]]; then
        print_message "INFO" "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ TG –æ—Ç–∫–ª—é—á–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ..."
        debug_log "TG" "File sending disabled, sending text only"
        local filename=$(basename "$file_path")
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è MarkdownV2
        local escaped_filename=$(escape_markdown_v2 "$filename")
        local escaped_caption=$(escape_markdown_v2 "$caption")
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (—É–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ)
        local notify_text="üì¶ *–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω*

${escaped_caption}

üìÅ –§–∞–π–ª: \`${escaped_filename}\`
üí° _–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ Telegram –æ—Ç–∫–ª—é—á–µ–Ω–∞_"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é (—Ç–µ–∫—Å—Ç —É–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω)
        local thread_param=""
        [[ -n "$TG_MESSAGE_THREAD_ID" ]] && thread_param="-d message_thread_id=$TG_MESSAGE_THREAD_ID"
        
        local http_code
        http_code=$(curl $CURL_SILENT -o "$SILENT_LOG" -w "%{http_code}" -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d parse_mode="MarkdownV2" \
            --data-urlencode text="$notify_text" \
            $thread_param 2> "$SILENT_LOG")
        debug_log "TG" "Text-only notification HTTP code: $http_code"
        
        if [[ "$http_code" == "200" ]]; then
            print_message "SUCCESS" "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram."
            return 0
        else
            print_message "WARN" "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (HTTP: $http_code)"
            log_message "WARN" "Telegram notification failed, HTTP code: $http_code"
            return 1
        fi
    fi
    
    print_message "INFO" "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram..."
    local file_size_bytes=$(stat -c%s "$file_path" 2> "$SILENT_LOG" || echo 0)
    debug_log "TG" "File size: $file_size_bytes bytes ($(numfmt --to=iec $file_size_bytes 2>/dev/null || echo "$file_size_bytes"))"
    
    local form_params=(-F chat_id="$CHAT_ID" -F document=@"$file_path" -F parse_mode="MarkdownV2" -F caption="$(escape_markdown_v2 "$caption")")
    [[ -n "$TG_MESSAGE_THREAD_ID" ]] && form_params+=(-F message_thread_id="$TG_MESSAGE_THREAD_ID")
    debug_log "TG" "Sending to: https://api.telegram.org/bot<TOKEN>/sendDocument"
    debug_log "TG" "Chat ID: $CHAT_ID, Thread ID: ${TG_MESSAGE_THREAD_ID:-none}"
    
    local http_code=$(curl $CURL_SILENT -o "$SILENT_LOG" -w "%{http_code}" -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" "${form_params[@]}")
    debug_log "TG" "HTTP response code: $http_code"
    
    if [[ "$http_code" == "200" ]]; then
        print_message "SUCCESS" "–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram."
    else
        local file_size=$(stat -c%s "$file_path" 2> "$SILENT_LOG" || echo 0)
        debug_log "TG" "Send FAILED! File size: $file_size"
        
        if [[ $file_size -ge 52428800 ]]; then
            print_message "ERROR" "–§–∞–π–ª >50MB. Telegram API –æ—Ç–∫–ª–æ–Ω–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É."
            debug_log "TG" "File exceeds 50MB limit"
            local escaped_fname=$(escape_markdown_v2 "$(basename "$file_path")")
            local error_msg="‚ö†Ô∏è *–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ç–∫–∞–ø–∞*

–§–∞–π–ª –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ 50 –ú–ë\. Telegram Bot API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–∞–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é\.

üìÇ *–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ:*
\`${escaped_fname}\`"
            
            local thread_param=""
            [[ -n "$TG_MESSAGE_THREAD_ID" ]] && thread_param="-d message_thread_id=$TG_MESSAGE_THREAD_ID"

            curl $CURL_SILENT -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
                -d chat_id="$CHAT_ID" \
                --data-urlencode text="$error_msg" \
                -d parse_mode="MarkdownV2" \
                $thread_param > "$SILENT_LOG"
        else
            print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram (HTTP –∫–æ–¥: $http_code)."
        fi
    fi
}

send_telegram_text() {
    # send simple text message to configured chat (expects already escaped MarkdownV2 text)
    local text="$1"
    [[ -z "$BOT_TOKEN" || -z "$CHAT_ID" ]] && return 1
    [[ "$SEND_TO_TELEGRAM" != "true" ]] && return 0
    local thread_param=""
    [[ -n "$TG_MESSAGE_THREAD_ID" ]] && thread_param="-d message_thread_id=$TG_MESSAGE_THREAD_ID"
    curl $CURL_SILENT -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        --data-urlencode text="$text" \
        -d parse_mode="MarkdownV2" $thread_param > "$SILENT_LOG" 2>&1
}

test_telegram_connection() {
    print_message "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ —Å Telegram API..."
    local res=$(curl $CURL_SILENT "https://api.telegram.org/bot$BOT_TOKEN/getMe")
    if [[ "$res" == *'"ok":true'* ]]; then
        local bot_user=$(echo "$res" | grep -o '"username":"[^"]*"' | cut -d'"' -f4)
        print_message "SUCCESS" "–£—Å–ø–µ—Ö! –ë–æ—Ç: @$bot_user"
    else
        print_message "ERROR" "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω."
    fi
    read -erp "Enter..." dummy
}

validate_remote_connection() {
    local type="$1"; local url="$2"; local user="$3"; local pass="$4"
    
    debug_log "REMOTE" "=== validate_remote_connection($type) ==="
    debug_log "REMOTE" "URL: $url"
    debug_log "REMOTE" "User: ${user:-<empty>}"
    
    print_message "INFO" "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ($type)..."
    
    local base_url="${url%/}"
    
    if [[ "$type" == "ftp" ]]; then
        debug_log "REMOTE" "Testing FTP connection..."
        # FTP: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏—Å—Ç–∏–Ω–≥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        local curl_cmd=(curl $CURL_SILENT -m 15 --ftp-pasv --list-only)
        [[ -n "$user" ]] && curl_cmd+=(--user "$user:$pass")
        
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FTPS (implicit –∏ explicit)
        if [[ "$base_url" == ftps://* ]]; then
            debug_log "REMOTE" "Using FTPS (implicit TLS)"
            curl_cmd+=(--ssl-reqd --insecure)
        elif [[ "$base_url" == ftp://* ]]; then
            debug_log "REMOTE" "Using FTP with optional TLS"
            # –ü–æ–ø—Ä–æ–±—É–µ–º explicit TLS –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            curl_cmd+=(--ssl --insecure)
        fi
        
        debug_log "REMOTE" "Running: ${curl_cmd[*]} $base_url/"
        if "${curl_cmd[@]}" "$base_url/" > "$SILENT_LOG" 2>&1; then 
            debug_log "REMOTE" "FTP connection SUCCESS"
            return 0
        else 
            debug_log "REMOTE" "FTP with TLS failed, trying without TLS..."
            # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ TLS –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ FTP
            if [[ "$base_url" == ftp://* ]]; then
                curl_cmd=(curl $CURL_SILENT -m 15 --ftp-pasv --list-only)
                [[ -n "$user" ]] && curl_cmd+=(--user "$user:$pass")
                if "${curl_cmd[@]}" "$base_url/" > "$SILENT_LOG" 2>&1; then
                    debug_log "REMOTE" "FTP without TLS SUCCESS"
                    return 0
                fi
            fi
            debug_log "REMOTE" "FTP connection FAILED"
            return 1
        fi
        
    elif [[ "$type" == "webdav" ]]; then
        debug_log "REMOTE" "Testing WebDAV connection..."
        # WebDAV: PROPFIND —Å Depth: 0
        local curl_cmd=(curl $CURL_SILENT -m 15 -L)
        [[ -n "$user" ]] && curl_cmd+=(--user "$user:$pass")
        
        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
        [[ "$base_url" == https://* ]] && curl_cmd+=(--insecure)
        
        local http_code
        debug_log "REMOTE" "Sending PROPFIND request..."
        http_code=$("${curl_cmd[@]}" -o "$SILENT_LOG" -w "%{http_code}" -X PROPFIND -H "Depth: 0" "$base_url/" 2> "$SILENT_LOG")
        debug_log "REMOTE" "PROPFIND HTTP code: $http_code"
        
        # 207 Multi-Status ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç WebDAV
        # 200 OK ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –æ—Ç–≤–µ—á–∞—é—Ç —Ç–∞–∫
        # 301/302 ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç (curl -L –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç)
        if [[ "$http_code" =~ ^(200|207)$ ]]; then 
            debug_log "REMOTE" "WebDAV connection SUCCESS"
            return 0
        else 
            debug_log "REMOTE" "PROPFIND failed, trying GET fallback..."
            # Fallback: –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π GET
            http_code=$("${curl_cmd[@]}" -o "$SILENT_LOG" -w "%{http_code}" "$base_url/" 2> "$SILENT_LOG")
            debug_log "REMOTE" "GET HTTP code: $http_code"
            if [[ "$http_code" =~ ^(200|207|401)$ ]]; then
                # 401 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                debug_log "REMOTE" "WebDAV connection SUCCESS (via GET)"
                return 0
            fi
            debug_log "REMOTE" "WebDAV connection FAILED"
            return 1
        fi
        
    elif [[ "$type" == "rclone" ]]; then
        debug_log "REMOTE" "Testing rclone connection..."
        if ! command -v rclone > "$SILENT_LOG" 2>&1; then
            debug_log "REMOTE" "rclone not installed!"
            print_message "ERROR" "Rclone –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            return 1
        fi
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å remote
        local remote_name="${url%%:*}"
        debug_log "REMOTE" "Remote name: $remote_name"
        if rclone listremotes 2> "$SILENT_LOG" | grep -q "^${remote_name}:$"; then
            debug_log "REMOTE" "Remote exists, testing lsd..."
            # Remote —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
            if rclone lsd "$url" > "$SILENT_LOG" 2>&1; then 
                debug_log "REMOTE" "Rclone connection SUCCESS"
                return 0
            fi
        else
            debug_log "REMOTE" "Remote '$remote_name' not found in rclone config"
        fi
        debug_log "REMOTE" "Rclone connection FAILED"
        return 1
    fi
    
    debug_log "REMOTE" "Unknown storage type: $type"
    return 1
}

upload_to_remote() {
    if [[ "$SEND_TO_REMOTE" != "true" ]]; then 
        debug_log "REMOTE" "Remote upload disabled (SEND_TO_REMOTE=$SEND_TO_REMOTE)"
        return 0
    fi
    local file_path="$1"
    local filename=$(basename "$file_path")
    local file_size=$(stat -c%s "$file_path" 2> "$SILENT_LOG" || echo "0")
    REMOTE_UPLOAD_STATUS_TEXT="" 
    
    debug_log "REMOTE" "=== upload_to_remote ==="
    debug_log "REMOTE" "File: $file_path"
    debug_log "REMOTE" "Size: $file_size bytes"
    debug_log "REMOTE" "Type: $REMOTE_STORAGE_TYPE"
    debug_log "REMOTE" "URL: $REMOTE_STORAGE_URL"

    if [[ "$REMOTE_STORAGE_TYPE" == "off" || -z "$REMOTE_STORAGE_URL" ]]; then 
        debug_log "REMOTE" "Remote storage disabled or URL empty"
        return 0
    fi
    
    if [[ ! -f "$file_path" ]]; then
        print_message "ERROR" "–§–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $file_path" >&2
        log_message "ERROR" "Upload failed: file not found $file_path"
        debug_log "REMOTE" "ERROR: File not found!"
        return 1
    fi

    print_message "INFO" "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ $REMOTE_STORAGE_TYPE ($(numfmt --to=iec $file_size 2> "$SILENT_LOG" || echo "${file_size}B"))..." >&2

    # === RCLONE ===
    if [[ "$REMOTE_STORAGE_TYPE" == "rclone" ]]; then
        debug_log "REMOTE" "Using rclone..."
        if ! command -v rclone > "$SILENT_LOG" 2>&1; then
            print_message "ERROR" "Rclone –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è Rclone: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
            return 1
        fi
        local dest="${REMOTE_STORAGE_URL%/}"
        local rclone_opts=(--progress --retries 3 --low-level-retries 10)
        [[ "$IS_INTERACTIVE" != "true" ]] && rclone_opts=(--quiet --retries 3 --low-level-retries 10)
        debug_log "REMOTE" "Running: rclone copy $file_path $dest ${rclone_opts[*]}"
        
        if rclone copy "$file_path" "$dest" "${rclone_opts[@]}" 2>&1; then
            print_message "SUCCESS" "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω (rclone)." >&2
            debug_log "REMOTE" "Rclone upload SUCCESS"
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è Rclone: OK'
            log_message "SUCCESS" "Uploaded $filename to rclone:$dest"
            return 0
        else
            print_message "ERROR" "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ rclone." >&2
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è Rclone: –û—à–∏–±–∫–∞'
            log_message "ERROR" "Failed upload $filename to rclone:$dest"
            return 1
        fi
    fi

    # === FTP / WEBDAV ===
    local upload_url="${REMOTE_STORAGE_URL%/}/$filename"
    local max_retries=3
    local retry_delay=5
    local attempt=1
    local http_code=""
    local upload_success=false
    
    # –†–∞—Å—á—ë—Ç —Ç–∞–π–º–∞—É—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∏–Ω–∏–º—É–º 120 —Å–µ–∫, +60 —Å–µ–∫ –Ω–∞ –∫–∞–∂–¥—ã–µ 50MB)
    local timeout=$((120 + (file_size / 50000000) * 60))
    [[ $timeout -gt 1800 ]] && timeout=1800  # –ú–∞–∫—Å–∏–º—É–º 30 –º–∏–Ω—É—Ç
    debug_log "UPLOAD" "Upload URL: $upload_url"
    debug_log "UPLOAD" "Timeout: ${timeout}s, Max retries: $max_retries"
    
    while [[ $attempt -le $max_retries ]]; do
        debug_log "UPLOAD" "Attempt $attempt/$max_retries"
        [[ $attempt -gt 1 ]] && print_message "INFO" "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ $attempt/$max_retries..." >&2
        
        # –ë–∞–∑–æ–≤—ã–µ –æ–ø—Ü–∏–∏ curl
        local curl_opts=(-o "$SILENT_LOG" -w "%{http_code}" -m "$timeout" -T "$file_path")
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏–ª–∏ —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º
        if [[ "$IS_INTERACTIVE" == "true" ]]; then
            curl_opts+=(-#)
        else
            curl_opts+=(-s)
        fi
        
        # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        [[ -n "$REMOTE_STORAGE_USER" ]] && curl_opts+=(--user "$REMOTE_STORAGE_USER:$REMOTE_STORAGE_PASS")
        
        if [[ "$REMOTE_STORAGE_TYPE" == "ftp" ]]; then
            # FTP —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ü–∏–∏
            curl_opts+=(--ftp-pasv)              # Passive mode (—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ NAT)
            curl_opts+=(--ftp-create-dirs)       # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            debug_log "UPLOAD" "FTP mode: passive, create-dirs"
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FTPS
            if [[ "$upload_url" == ftps://* ]]; then
                curl_opts+=(--ssl-reqd --insecure)
                debug_log "UPLOAD" "FTPS: SSL required"
            elif [[ "$upload_url" == ftp://* ]]; then
                curl_opts+=(--ssl --insecure)    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å TLS –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                debug_log "UPLOAD" "FTP: Try TLS if available"
            fi
            
            curl_opts+=("$upload_url")
            debug_log "UPLOAD" "Executing FTP upload..."
            http_code=$(curl "${curl_opts[@]}" 2> "$SILENT_LOG") || http_code="000"
            debug_log "UPLOAD" "FTP response code: $http_code"
            
            # FTP –∫–æ–¥—ã —É—Å–ø–µ—Ö–∞: 226 (Transfer complete), 250 (Requested file action okay)
            if [[ "$http_code" =~ ^(226|250|200)$ ]]; then
                upload_success=true
                debug_log "UPLOAD" "FTP upload SUCCESS"
                break
            fi
            
        elif [[ "$REMOTE_STORAGE_TYPE" == "webdav" ]]; then
            # WebDAV —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ü–∏–∏
            curl_opts+=(-L)                      # –°–ª–µ–¥–æ–≤–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º
            curl_opts+=(--retry 2)               # –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π retry curl
            curl_opts+=(--retry-delay 3)
            debug_log "UPLOAD" "WebDAV mode: follow redirects, retry 2"
            
            # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTTPS —Å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
            if [[ "$upload_url" == https://* ]]; then
                curl_opts+=(--insecure)
                debug_log "UPLOAD" "WebDAV: HTTPS with insecure"
            fi
            
            curl_opts+=("$upload_url")
            debug_log "UPLOAD" "Executing WebDAV upload..."
            http_code=$(curl "${curl_opts[@]}" 2> "$SILENT_LOG") || http_code="000"
            debug_log "UPLOAD" "WebDAV response code: $http_code"
            
            # WebDAV –∫–æ–¥—ã —É—Å–ø–µ—Ö–∞: 200 OK, 201 Created, 204 No Content
            if [[ "$http_code" =~ ^(200|201|204)$ ]]; then
                upload_success=true
                debug_log "UPLOAD" "WebDAV upload SUCCESS"
                break
            fi
        fi
        
        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
        debug_log "UPLOAD" "Attempt $attempt FAILED with HTTP $http_code"
        log_message "WARN" "Upload attempt $attempt failed: HTTP $http_code for $upload_url"
        
        ((attempt++))
        [[ $attempt -le $max_retries ]] && sleep $retry_delay
    done
    
    if [[ "$upload_success" == true ]]; then
        print_message "SUCCESS" "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ." >&2
        if [[ "$REMOTE_STORAGE_TYPE" == "ftp" ]]; then 
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è FTP: OK'
        else 
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è WebDAV: OK'
        fi
        log_message "SUCCESS" "Uploaded $filename to $REMOTE_STORAGE_TYPE ($upload_url) HTTP=$http_code"
        return 0
    else
        print_message "ERROR" "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ $max_retries –ø–æ–ø—ã—Ç–æ–∫ (–ö–æ–¥: $http_code)" >&2
        if [[ "$REMOTE_STORAGE_TYPE" == "ftp" ]]; then 
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è FTP: –û—à–∏–±–∫–∞'
        else 
            REMOTE_UPLOAD_STATUS_TEXT=$'\n‚òÅÔ∏è WebDAV: –û—à–∏–±–∫–∞'
        fi
        log_message "ERROR" "Failed upload $filename to $REMOTE_STORAGE_TYPE after $max_retries attempts. Last HTTP=$http_code"
        return 1
    fi
}

configure_remote_storage() {
    while true; do
        clear_screen
        echo -e "${GREEN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞${RESET}"
        echo ""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        if [[ "$REMOTE_STORAGE_TYPE" != "off" && -n "$REMOTE_STORAGE_URL" ]]; then
            echo -e "–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
            echo -e "  –¢–∏–ø: ${YELLOW}${REMOTE_STORAGE_TYPE^^}${RESET}"
            echo -e "  URL: ${CYAN}${REMOTE_STORAGE_URL}${RESET}"
            [[ -n "$REMOTE_STORAGE_USER" ]] && echo -e "  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${GRAY}${REMOTE_STORAGE_USER}${RESET}"
            echo ""
        fi
        
        echo " 1. FTP / FTPS"
        echo " 2. WebDAV (–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫, Nextcloud, –∏ –¥—Ä.)"
        echo " 3. Rclone (Google Drive, S3, Dropbox, –∏ –¥—Ä.)"
        echo ""
        echo -e " ${RED}0. –û—Ç–∫–ª—é—á–∏—Ç—å${RESET}"
        echo ""
        read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " r_type
        [[ -z "$r_type" ]] && return
        
        local new_type="off"
        local input_url="" input_user="" input_pass="" input_folder=""
        local base_url=""
        
        case $r_type in
            1) new_type="ftp" ;;
            2) new_type="webdav" ;;
            3) new_type="rclone" ;;
            0) 
                REMOTE_STORAGE_TYPE="off"
                REMOTE_STORAGE_URL=""
                REMOTE_STORAGE_USER=""
                REMOTE_STORAGE_PASS=""
                save_config
                print_message "SUCCESS" "–£–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ."
                sleep 1
                return 
                ;;
            *) continue ;;
        esac

        echo ""
        
        if [[ "$new_type" == "ftp" ]]; then
            echo -e "${CYAN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ FTP/FTPS${RESET}"
            echo ""
            echo -e "${GRAY}–®–∞–≥ 1/3: –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞${RESET}"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo -e "  ${GRAY}ftp://backup.example.com${RESET}"
            echo -e "  ${GRAY}ftps://secure.example.com:990${RESET}"
            echo ""
            read -erp "–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ (Enter - –Ω–∞–∑–∞–¥): " base_url
            [[ -z "$base_url" ]] && continue
            
            # –£–±–∏—Ä–∞–µ–º trailing slash
            base_url="${base_url%/}"
            
            echo ""
            echo -e "${GRAY}–®–∞–≥ 2/3: –ü–∞–ø–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ${RESET}"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo -e "  ${GRAY}backups${RESET}           ‚Üí ${CYAN}${base_url}/backups${RESET}"
            echo -e "  ${GRAY}backup/lazarus${RESET}    ‚Üí ${CYAN}${base_url}/backup/lazarus${RESET}"
            echo -e "  ${GRAY}(–ø—É—Å—Ç–æ)${RESET}           ‚Üí ${CYAN}${base_url}${RESET} (–∫–æ—Ä–µ–Ω—å)"
            echo ""
            read -erp "–ü–∞–ø–∫–∞: " input_folder
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π URL
            if [[ -n "$input_folder" ]]; then
                input_folder="${input_folder#/}"  # –£–±–∏—Ä–∞–µ–º leading slash
                input_folder="${input_folder%/}"  # –£–±–∏—Ä–∞–µ–º trailing slash
                input_url="${base_url}/${input_folder}"
            else
                input_url="$base_url"
            fi
            
            echo ""
            echo -e "–ò—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å: ${CYAN}${input_url}${RESET}"
            echo ""
            echo -e "${GRAY}–®–∞–≥ 3/3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è${RESET}"
            read -erp "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " input_user
            read -s -erp "–ü–∞—Ä–æ–ª—å: " input_pass
            echo ""
            
        elif [[ "$new_type" == "webdav" ]]; then
            echo -e "${CYAN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebDAV${RESET}"
            echo ""
            echo -e "${GRAY}–®–∞–≥ 1/3: –ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞${RESET}"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã –±–∞–∑–æ–≤—ã—Ö –∞–¥—Ä–µ—Å–æ–≤:"
            echo -e "  ${GRAY}https://webdav.yandex.ru${RESET}                    (–Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫)"
            echo -e "  ${GRAY}https://cloud.example.com/remote.php/dav/files/user${RESET} (Nextcloud)"
            echo ""
            read -erp "–ê–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ (Enter - –Ω–∞–∑–∞–¥): " base_url
            [[ -z "$base_url" ]] && continue
            
            # –£–±–∏—Ä–∞–µ–º trailing slash
            base_url="${base_url%/}"
            
            echo ""
            echo -e "${GRAY}–®–∞–≥ 2/3: –ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤${RESET}"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo -e "  ${GRAY}backups${RESET}           ‚Üí ${CYAN}${base_url}/backups${RESET}"
            echo -e "  ${GRAY}Backup/Lazarus${RESET}    ‚Üí ${CYAN}${base_url}/Backup/Lazarus${RESET}"
            echo -e "  ${GRAY}(–ø—É—Å—Ç–æ)${RESET}           ‚Üí ${CYAN}${base_url}${RESET} (–∫–æ—Ä–µ–Ω—å)"
            echo ""
            read -erp "–ü–∞–ø–∫–∞: " input_folder
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π URL
            if [[ -n "$input_folder" ]]; then
                input_folder="${input_folder#/}"
                input_folder="${input_folder%/}"
                input_url="${base_url}/${input_folder}"
            else
                input_url="$base_url"
            fi
            
            echo ""
            echo -e "–ò—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å: ${CYAN}${input_url}${RESET}"
            echo ""
            echo -e "${GRAY}–®–∞–≥ 3/3: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è${RESET}"
            read -erp "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " input_user
            read -s -erp "–ü–∞—Ä–æ–ª—å (–∏–ª–∏ —Ç–æ–∫–µ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è): " input_pass
            echo ""
            
        elif [[ "$new_type" == "rclone" ]]; then
            echo -e "${CYAN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Rclone${RESET}"
            echo ""
            if ! command -v rclone > "$SILENT_LOG" 2>&1; then
                print_message "ERROR" "Rclone –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
                echo -e "–£—Å—Ç–∞–Ω–æ–≤–∫–∞: ${GRAY}curl https://rclone.org/install.sh | sudo bash${RESET}"
                read -erp "Enter..." dummy
                continue
            fi
            
            echo -e "${GRAY}–®–∞–≥ 1/2: –í—ã–±–æ—Ä remote${RESET}"
            echo ""
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ remotes:"
            local remotes=$(rclone listremotes 2> "$SILENT_LOG")
            if [[ -z "$remotes" ]]; then
                print_message "WARN" "–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö remotes!"
                echo -e "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑: ${GRAY}rclone config${RESET}"
                read -erp "Enter..." dummy
                continue
            fi
            echo "$remotes" | sed 's/^/  /'
            echo ""
            read -erp "–ò–º—è remote (–±–µ–∑ –¥–≤–æ–µ—Ç–æ—á–∏—è, Enter - –Ω–∞–∑–∞–¥): " base_url
            [[ -z "$base_url" ]] && continue
            
            # –£–±–∏—Ä–∞–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–≥–æ –¥–æ–±–∞–≤–∏–ª
            base_url="${base_url%:}"
            
            echo ""
            echo -e "${GRAY}–®–∞–≥ 2/2: –ü–∞–ø–∫–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ${RESET}"
            echo ""
            echo "–ü—Ä–∏–º–µ—Ä—ã:"
            echo -e "  ${GRAY}backups${RESET}           ‚Üí ${CYAN}${base_url}:backups${RESET}"
            echo -e "  ${GRAY}Backup/Server1${RESET}    ‚Üí ${CYAN}${base_url}:Backup/Server1${RESET}"
            echo -e "  ${GRAY}(–ø—É—Å—Ç–æ)${RESET}           ‚Üí ${CYAN}${base_url}:${RESET} (–∫–æ—Ä–µ–Ω—å)"
            echo ""
            read -erp "–ü–∞–ø–∫–∞: " input_folder
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è rclone
            if [[ -n "$input_folder" ]]; then
                input_folder="${input_folder#/}"
                input_folder="${input_folder%/}"
                input_url="${base_url}:${input_folder}"
            else
                input_url="${base_url}:"
            fi
            
            echo ""
            echo -e "–ò—Ç–æ–≥–æ–≤—ã–π –ø—É—Ç—å: ${CYAN}${input_url}${RESET}"
            input_user=""
            input_pass=""
        fi

        echo ""
        print_message "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
        
        if validate_remote_connection "$new_type" "$input_url" "$input_user" "$input_pass"; then
            print_message "SUCCESS" "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!"
            REMOTE_STORAGE_TYPE="$new_type"
            REMOTE_STORAGE_URL="$input_url"
            REMOTE_STORAGE_USER="$input_user"
            REMOTE_STORAGE_PASS="$input_pass"
            save_config
            print_message "SUCCESS" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."
            sleep 1.5
            return
        else
            print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É!"
            echo ""
            read -erp "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É? (y/N): " force_save
            if [[ "$force_save" =~ ^[Yy]$ ]]; then
                REMOTE_STORAGE_TYPE="$new_type"
                REMOTE_STORAGE_URL="$input_url"
                REMOTE_STORAGE_USER="$input_user"
                REMOTE_STORAGE_PASS="$input_pass"
                save_config
                print_message "WARN" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)."
                sleep 1.5
                return
            else
                print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ. –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞..."
                sleep 1
            fi
        fi
    done
}

# --- –†–û–¢–ê–¶–ò–Ø (–£–î–ê–õ–ï–ù–ò–ï –õ–ò–®–ù–ò–•) ---

rotate_backups_by_count() {
    local PREFIX="$1"
    local LABEL="$2"
    local PERFORM_DELETE="$3" 
    
    debug_log "ROTATION" "=== rotate_backups_by_count($PREFIX, $LABEL, delete=$PERFORM_DELETE) ==="
    debug_log "ROTATION" "MAX_BACKUPS_COUNT=$MAX_BACKUPS_COUNT"
    
    # –°–¢–†–û–ì–ò–ô –ü–û–ò–°–ö (–¢–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤—ã), —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—ã–µ –≤ –Ω–∞—á–∞–ª–µ)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º ls -1tr –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ while read –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
    local files=()
    while IFS= read -r f; do
        files+=("$f")
    done < <(ls -1tr "$BACKUP_DIR"/${PREFIX}_*.tar.gz "$BACKUP_DIR"/${PREFIX}_*.tar.gz.enc 2> "$SILENT_LOG")
    
    local count=${#files[@]}
    local diff=$((count - MAX_BACKUPS_COUNT))
    debug_log "ROTATION" "Found $count files, limit=$MAX_BACKUPS_COUNT, to_delete=$diff"
    
    if [[ $diff -gt 0 ]]; then
        if [[ "$PERFORM_DELETE" == "true" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
                debug_log "ROTATION" "[DRY-RUN] Would delete $diff files"
                echo -e "${YELLOW}[DRY-RUN] –ö–∞—Ç–µ–≥–æ—Ä–∏—è '$LABEL': –±—ã–ª–æ –±—ã —É–¥–∞–ª–µ–Ω–æ $diff —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ (–ª–∏–º–∏—Ç $MAX_BACKUPS_COUNT).${RESET}"
                log_message "INFO" "[DRY_RUN] Would delete $diff files (count-based rotation, prefix=$PREFIX, limit=$MAX_BACKUPS_COUNT)"
                echo "$diff"
                return 0
            fi
            echo -e "${YELLOW}–û—á–∏—Å—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '$LABEL' (—É–¥–∞–ª–µ–Ω–∏–µ $diff —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤):${RESET}"
            for (( i=0; i<diff; i++ )); do
                local file_to_del="${files[$i]}"
                if [[ -f "$file_to_del" ]]; then
                    debug_log "ROTATION" "Deleting: $file_to_del"
                    rm -f "$file_to_del"
                    rm -f "$file_to_del.version"
                    echo "  üóë –£–¥–∞–ª–µ–Ω: $(basename "$file_to_del")"
                    log_message "INFO" "Deleted $file_to_del (count-based rotation, prefix=$PREFIX)"
                fi
            done
            debug_log "ROTATION" "Deleted $diff files"
            echo "$diff"
            return 0
        else
            echo -e " $LABEL: –ù–∞–π–¥–µ–Ω–æ $count (–õ–∏–º–∏—Ç $MAX_BACKUPS_COUNT) -> ${RED}–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ: $diff —à—Ç.${RESET}"
            echo "$diff"
        fi
    else
        debug_log "ROTATION" "No files to delete (count=$count <= limit=$MAX_BACKUPS_COUNT)"
        if [[ "$PERFORM_DELETE" != "true" ]]; then
            echo -e " $LABEL: –ù–∞–π–¥–µ–Ω–æ $count (–õ–∏–º–∏—Ç $MAX_BACKUPS_COUNT) -> ${GREEN}OK${RESET}"
        fi
        echo "0"
        return 0
    fi
}

rotate_backups_by_age() {
    local PREFIX="$1"
    local LABEL="$2"
    local DAYS="$3"
    local PERFORM_DELETE="$4"

    debug_log "ROTATION" "=== rotate_backups_by_age($PREFIX, $LABEL, days=$DAYS, delete=$PERFORM_DELETE) ==="

    # –ò—â–µ–º —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤—ã (–≤–∫–ª—é—á–∞—è .enc)
    local pattern1="$BACKUP_DIR/${PREFIX}_*.tar.gz"
    local pattern2="$BACKUP_DIR/${PREFIX}_*.tar.gz.enc"

    # –ù–∞–π–¥—ë–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ DAYS –¥–Ω–µ–π
    local files=()
    # find -mtime +N –æ–∑–Ω–∞—á–∞–µ—Ç "—Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ N –¥–Ω–µ–π". –ß—Ç–æ–±—ã RETENTION_DAYS=N –æ–∑–Ω–∞—á–∞–ª
    # "—É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π", –∏—Å–ø–æ–ª—å–∑—É–µ–º -mtime +$((N-1)). –î–ª—è N==0 ‚Äî –±—É–¥–µ–º
    # —É–¥–∞–ª—è—Ç—å –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ñ–∞–π–ª—ã.
    # –°–æ–±–∏—Ä–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã find –±–µ–∑ eval
    local find_args=("$BACKUP_DIR" -maxdepth 1 \( -name "${PREFIX}_*.tar.gz" -o -name "${PREFIX}_*.tar.gz.enc" \) -type f)
    if [[ "$DAYS" -le 0 ]]; then
        # –ï—Å–ª–∏ 0 –∏–ª–∏ –º–µ–Ω—å—à–µ - –Ω–µ —É–¥–∞–ª—è–µ–º –Ω–∏—á–µ–≥–æ (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏)
        debug_log "ROTATION" "Days <= 0, skipping rotation"
        return 0
    else
        local nd=$((DAYS - 1))
        find_args+=( -mtime +"$nd" )
        debug_log "ROTATION" "Find mtime: +$nd (files older than $DAYS days)"
    fi
    find_args+=( -print0 )
    while IFS= read -r -d $'\0' f; do files+=("$f"); done < <(find "${find_args[@]}" 2> "$SILENT_LOG")

    local count=${#files[@]}
    debug_log "ROTATION" "Found $count files older than $DAYS days"

    if [[ $count -gt 0 ]]; then
        if [[ "$PERFORM_DELETE" == "true" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
                debug_log "ROTATION" "[DRY-RUN] Would delete $count files"
                echo -e "${YELLOW}[DRY-RUN] –ö–∞—Ç–µ–≥–æ—Ä–∏—è '$LABEL': –±—ã–ª–æ –±—ã —É–¥–∞–ª–µ–Ω–æ $count —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ $DAYS –¥–Ω–µ–π.${RESET}"
                log_message "INFO" "[DRY_RUN] Would delete $count files (age-based rotation, prefix=$PREFIX, days=$DAYS)"
                echo "$count"
                return 0
            fi
            echo -e "${YELLOW}–û—á–∏—Å—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '$LABEL' (—É–¥–∞–ª–µ–Ω–∏–µ $count —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ $DAYS –¥–Ω–µ–π):${RESET}"
            for f in "${files[@]}"; do
                if [[ -f "$f" ]]; then
                    debug_log "ROTATION" "Deleting: $f"
                    rm -f "$f"
                    rm -f "$f.version"
                    echo "  üóë –£–¥–∞–ª–µ–Ω: $(basename "$f")"
                    log_message "INFO" "Deleted $f (age-based rotation, prefix=$PREFIX, days=$DAYS)"
                fi
            done
            debug_log "ROTATION" "Deleted $count files"
            echo "$count"
            return 0
        else
            echo -e " $LABEL: –ù–∞–π–¥–µ–Ω–æ $count —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ $DAYS –¥–Ω–µ–π -> ${RED}–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ: $count —à—Ç.${RESET}"
            echo "$count"
        fi
    else
        debug_log "ROTATION" "No files to delete"
        if [[ "$PERFORM_DELETE" != "true" ]]; then
            echo -e " $LABEL: –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å—Ç–∞—Ä—à–µ $DAYS –¥–Ω–µ–π -> ${GREEN}OK${RESET}"
        fi
        echo "0"
        return 0
    fi
}

# –†–æ—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É - —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –ø–æ–∫–∞ –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –Ω–µ —Å—Ç–∞–Ω–µ—Ç <= –ª–∏–º–∏—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: rotate_backups_by_size "true" –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è, –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞
rotate_backups_by_size() {
    local PERFORM_DELETE="$1"
    
    debug_log "SIZE" "=== rotate_backups_by_size(delete=$PERFORM_DELETE) ==="
    
    # –ï—Å–ª–∏ –ª–∏–º–∏—Ç 0 –∏–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if [[ -z "$MAX_BACKUP_SIZE_MB" || "$MAX_BACKUP_SIZE_MB" == "0" ]]; then
        debug_log "SIZE" "Size limit disabled (MAX_BACKUP_SIZE_MB=$MAX_BACKUP_SIZE_MB)"
        return 0
    fi
    
    local limit_mb="$MAX_BACKUP_SIZE_MB"
    local limit_bytes=$((limit_mb * 1024 * 1024))
    debug_log "SIZE" "Limit: $limit_mb MB ($limit_bytes bytes)"
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏ –±—ç–∫–∞–ø–æ–≤ –≤ –±–∞–π—Ç–∞—Ö
    local current_size_bytes=$(du -sb "$BACKUP_DIR" 2> "$SILENT_LOG" | awk '{print $1}')
    local current_size_mb=$((current_size_bytes / 1024 / 1024))
    debug_log "SIZE" "Current size: $current_size_mb MB ($current_size_bytes bytes)"
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    local limit_display=""
    local current_display=""
    if [[ $limit_mb -ge 1024 ]]; then
        limit_display="$(echo "scale=1; $limit_mb / 1024" | bc) GB"
    else
        limit_display="$limit_mb MB"
    fi
    if [[ $current_size_mb -ge 1024 ]]; then
        current_display="$(echo "scale=1; $current_size_mb / 1024" | bc) GB"
    else
        current_display="$current_size_mb MB"
    fi
    
    debug_log "SIZE" "Current: $current_size_bytes bytes ($current_display), Limit: $limit_bytes bytes ($limit_display)"
    
    # –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞ - –≤—Å—ë –æ–∫
    if [[ $current_size_bytes -le $limit_bytes ]]; then
        if [[ "$PERFORM_DELETE" != "true" ]]; then
            echo -e " –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤: ${GREEN}$current_display${RESET} / $limit_display -> ${GREEN}OK${RESET}"
        fi
        return 0
    fi
    
    # –ù—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã
    local excess_mb=$((current_size_mb - limit_mb))
    local excess_display=""
    if [[ $excess_mb -ge 1024 ]]; then
        excess_display="$(echo "scale=1; $excess_mb / 1024" | bc) GB"
    else
        excess_display="$excess_mb MB"
    fi
    debug_log "SIZE" "Excess: $excess_mb MB ($excess_display)"
    
    if [[ "$PERFORM_DELETE" != "true" ]]; then
        echo -e " –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤: ${RED}$current_display${RESET} / $limit_display -> ${RED}–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: $excess_display${RESET}"
        return 0
    fi
    
    # –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è
    if [[ "$DRY_RUN" == "true" ]]; then
        debug_log "SIZE" "[DRY-RUN] Would delete files to free $excess_display"
        echo -e "${YELLOW}[DRY-RUN] –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –Ω–∞ $excess_display. –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –±—ã–ª–∏ –±—ã —É–¥–∞–ª–µ–Ω—ã.${RESET}"
        log_message "INFO" "[DRY_RUN] Size rotation: current=$current_display, limit=$limit_display, excess=$excess_display"
        return 0
    fi
    
    debug_log "SIZE" "Starting deletion loop..."
    echo -e "${YELLOW}–û—á–∏—Å—Ç–∫–∞ –ø–æ –ª–∏–º–∏—Ç—É —Ä–∞–∑–º–µ—Ä–∞ (—Ç–µ–∫—É—â–∏–π: $current_display, –ª–∏–º–∏—Ç: $limit_display):${RESET}"
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    local files=()
    while IFS= read -r -d $'\0' f; do 
        files+=("$f")
    done < <(find "$BACKUP_DIR" -maxdepth 1 -type f \( -name "lazarus_*.tar.gz" -o -name "lazarus_*.tar.gz.enc" \) -printf '%T@ %p\0' 2> "$SILENT_LOG" | sort -zn | cut -z -d' ' -f2-)
    
    debug_log "SIZE" "Found ${#files[@]} backup files to process"
    
    local deleted_count=0
    local deleted_size=0
    
    for file in "${files[@]}"; do
        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä
        current_size_bytes=$(du -sb "$BACKUP_DIR" 2> "$SILENT_LOG" | awk '{print $1}')
        debug_log "SIZE" "Current: $current_size_bytes bytes, limit: $limit_bytes bytes"
        
        if [[ $current_size_bytes -le $limit_bytes ]]; then
            debug_log "SIZE" "Size now within limit, stopping"
            break
        fi
        
        if [[ -f "$file" ]]; then
            local file_size=$(stat -c%s "$file" 2> "$SILENT_LOG" || echo 0)
            debug_log "SIZE" "Deleting: $file (size=$file_size bytes)"
            rm -f "$file"
            rm -f "$file.version"
            echo "  üóë –£–¥–∞–ª–µ–Ω: $(basename "$file")"
            log_message "INFO" "Deleted $file (size-based rotation)"
            ((deleted_count++))
            ((deleted_size += file_size))
        fi
    done
    
    local deleted_display=""
    local deleted_mb=$((deleted_size / 1024 / 1024))
    if [[ $deleted_mb -ge 1024 ]]; then
        deleted_display="$(echo "scale=1; $deleted_mb / 1024" | bc) GB"
    else
        deleted_display="$deleted_mb MB"
    fi
    
    if [[ $deleted_count -gt 0 ]]; then
        print_message "SUCCESS" "–£–¥–∞–ª–µ–Ω–æ $deleted_count —Ñ–∞–π–ª–æ–≤ ($deleted_display)"
        log_message "SUCCESS" "Size-based rotation: deleted $deleted_count files ($deleted_display)"
    fi
    
    return 0
}

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
format_size_mb() {
    local size_mb="$1"
    if [[ -z "$size_mb" || "$size_mb" == "0" ]]; then
        echo "–ë–µ–∑ –ª–∏–º–∏—Ç–∞"
    elif [[ $size_mb -ge 1024 ]]; then
        echo "$(echo "scale=1; $size_mb / 1024" | bc) GB"
    else
        echo "$size_mb MB"
    fi
}

uninstall_script() {
    if [[ "$EUID" -ne 0 ]]; then
        print_message "ERROR" "Uninstall requires root (sudo)."
        return 1
    fi
    echo ""
    print_message "WARN" "–£–¥–∞–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –∏ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.";
    read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " ans
    if [[ ! "$ans" =~ ^[Yy]$ ]]; then print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ."; return 0; fi

    # remove symlink
    if [[ -L "$SYMLINK_PATH" ]]; then
        rm -f "$SYMLINK_PATH" && log_message "INFO" "Removed symlink $SYMLINK_PATH"
    fi
    # remove installed script
    if [[ -f "$INSTALL_DIR/$SCRIPT_NAME" ]]; then
        rm -f "$INSTALL_DIR/$SCRIPT_NAME" && log_message "INFO" "Removed $INSTALL_DIR/$SCRIPT_NAME"
    fi
    # remove config and backups (ask)
    if [[ -d "$INSTALL_DIR" ]]; then
        read -erp "–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É $INSTALL_DIR –∏ –≤—Å–µ –±—ç–∫–∞–ø—ã? (y/N): " r2
        if [[ "$r2" =~ ^[Yy]$ ]]; then
            rm -rf "$INSTALL_DIR" && log_message "INFO" "Removed $INSTALL_DIR"
        else
            log_message "INFO" "Preserved $INSTALL_DIR"
        fi
    fi
    # try to remove cron entries
    crontab -l 2> "$SILENT_LOG" | grep -v "# LAZARUS-JOB-" | crontab - 2> "$SILENT_LOG" || true
    log_message "INFO" "Attempted to remove cron entries for lazarus"
    print_message "SUCCESS" "Uninstall finished."
}

# --- –ü–†–û–í–ï–†–ö–ê CRON –ó–ê–î–ê–ß ---

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ cron-–∑–∞–¥–∞—á –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å
get_cron_status() {
    local JOB_TYPE="$1"  # full, db, files
    local JOB_ID="# LAZARUS-JOB-${JOB_TYPE^^}"
    
    local cron_line=$(crontab -l 2> "$SILENT_LOG" | grep "$JOB_ID")
    
    if [[ -z "$cron_line" ]]; then
        echo "–í—ã–∫–ª"
        return
    fi
    
    # –ü–∞—Ä—Å–∏–º cron-—Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    local minute=$(echo "$cron_line" | awk '{print $1}')
    local hour=$(echo "$cron_line" | awk '{print $2}')
    local day_month=$(echo "$cron_line" | awk '{print $3}')
    local month=$(echo "$cron_line" | awk '{print $4}')
    local day_week=$(echo "$cron_line" | awk '{print $5}')
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    if [[ "$minute" == "0" && "$hour" == "*" ]]; then
        echo "–ï–∂–µ—á–∞—Å–Ω–æ"
    elif [[ "$minute" =~ ^\*/([0-9]+)$ ]]; then
        echo "–ö–∞–∂–¥—ã–µ ${BASH_REMATCH[1]} –º–∏–Ω"
    elif [[ "$minute" == "0" && "$hour" == "4" && "$day_week" == "1" ]]; then
        echo "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ"
    elif [[ "$minute" == "0" && "$hour" =~ ^[0-9]+$ && "$day_month" == "*" ]]; then
        printf "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ %02d:00" "$hour"
    elif [[ "$hour" =~ ^[0-9]+$ && "$minute" =~ ^[0-9]+$ ]]; then
        printf "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ %02d:%02d" "$hour" "$minute"
    else
        echo "–ê–∫—Ç–∏–≤–Ω–æ"
    fi
}

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º cron
sync_cron_with_config() {
    local CRON_FULL=$(get_cron_status "full")
    local CRON_DB=$(get_cron_status "db")
    local CRON_FILES=$(get_cron_status "files")
    
    local needs_save=false
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ cron
    if [[ "$SCHEDULE_FULL" != "$CRON_FULL" ]]; then
        SCHEDULE_FULL="$CRON_FULL"
        needs_save=true
    fi
    if [[ "$SCHEDULE_DB" != "$CRON_DB" ]]; then
        SCHEDULE_DB="$CRON_DB"
        needs_save=true
    fi
    if [[ "$SCHEDULE_FILES" != "$CRON_FILES" ]]; then
        SCHEDULE_FILES="$CRON_FILES"
        needs_save=true
    fi
    
    if [[ "$needs_save" == "true" ]]; then
        save_config
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ cron, –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏—Å–ø—Ä–∞–≤–∏—Ç—å
check_cron_mismatch() {
    [[ "$IS_INTERACTIVE" != "true" ]] && return 0
    
    local CRON_FULL=$(get_cron_status "full")
    local CRON_DB=$(get_cron_status "db")
    local CRON_FILES=$(get_cron_status "files")
    
    local mismatches=()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∫–ª—é—á–µ–Ω–æ, –Ω–æ –≤ cron –Ω–µ—Ç
    if [[ "$SCHEDULE_FULL" != "–í—ã–∫–ª" && "$CRON_FULL" == "–í—ã–∫–ª" ]]; then
        mismatches+=("Full: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞='$SCHEDULE_FULL', cron=–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    fi
    if [[ "$SCHEDULE_DB" != "–í—ã–∫–ª" && "$CRON_DB" == "–í—ã–∫–ª" ]]; then
        mismatches+=("DB: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞='$SCHEDULE_DB', cron=–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    fi
    if [[ "$SCHEDULE_FILES" != "–í—ã–∫–ª" && "$CRON_FILES" == "–í—ã–∫–ª" ]]; then
        mismatches+=("Files: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞='$SCHEDULE_FILES', cron=–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
    fi
    
    if [[ ${#mismatches[@]} -eq 0 ]]; then
        return 0
    fi
    
    clear_screen
    echo -e "${YELLOW}${BOLD}‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ cron-–∑–∞–¥–∞—á${RESET}"
    echo ""
    echo "–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞ —É–∫–∞–∑–∞–Ω—ã –∑–∞–¥–∞—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞,"
    echo "–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ cron-–∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ."
    echo ""
    echo -e "${CYAN}–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:${RESET}"
    for m in "${mismatches[@]}"; do
        echo -e " ‚Ä¢ $m"
    done
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω–æ, cron-–∑–∞–¥–∞—á–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é."
    echo ""
    echo " 1. –°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ cron-–∑–∞–¥–∞—á–∏ (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)"
    echo " 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å cron (—Å–±—Ä–æ—Å–∏—Ç—å –≤ '–í—ã–∫–ª')"
    echo " 0. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)"
    echo ""
    read -erp "–í–∞—à –≤—ã–±–æ—Ä: " choice
    
    case $choice in
        1)
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cron-–∑–∞–¥–∞—á–∏ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if [[ "$SCHEDULE_FULL" != "–í—ã–∫–ª" && "$CRON_FULL" == "–í—ã–∫–ª" ]]; then
                recreate_cron_from_schedule "full" "$SCHEDULE_FULL"
            fi
            if [[ "$SCHEDULE_DB" != "–í—ã–∫–ª" && "$CRON_DB" == "–í—ã–∫–ª" ]]; then
                recreate_cron_from_schedule "db" "$SCHEDULE_DB"
            fi
            if [[ "$SCHEDULE_FILES" != "–í—ã–∫–ª" && "$CRON_FILES" == "–í—ã–∫–ª" ]]; then
                recreate_cron_from_schedule "files" "$SCHEDULE_FILES"
            fi
            print_message "SUCCESS" "Cron-–∑–∞–¥–∞—á–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
            sleep 1
            ;;
        2)
            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º cron
            sync_cron_with_config
            print_message "SUCCESS" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å cron."
            sleep 1
            ;;
        *)
            print_message "INFO" "–ü—Ä–æ–ø—É—â–µ–Ω–æ."
            sleep 0.5
            ;;
    esac
}

# –í–æ—Å—Å–æ–∑–¥–∞—ë—Ç cron-–∑–∞–¥–∞—á—É –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
recreate_cron_from_schedule() {
    local TASK_TYPE="$1"
    local SCHEDULE="$2"
    
    local JOB_CMD="$SYMLINK_PATH backup_$TASK_TYPE"
    [[ "$TASK_TYPE" == "db" ]] && JOB_CMD="$SYMLINK_PATH backup_db"
    [[ "$TASK_TYPE" == "files" ]] && JOB_CMD="$SYMLINK_PATH backup_files"
    [[ "$TASK_TYPE" == "full" ]] && JOB_CMD="$SYMLINK_PATH backup_full"
    
    local JOB_ID="# LAZARUS-JOB-${TASK_TYPE^^}"
    local NEW_CRON_LINE=""
    
    # –ü–∞—Ä—Å–∏–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—ë–º cron-—Å—Ç—Ä–æ–∫—É
    case "$SCHEDULE" in
        "–ï–∂–µ—á–∞—Å–Ω–æ")
            NEW_CRON_LINE="0 * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
            ;;
        "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ")
            NEW_CRON_LINE="0 4 * * 1 $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
            ;;
        –ï–∂–µ–¥–Ω–µ–≤–Ω–æ\ *)
            # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏–∑ "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ HH:MM" –∏–ª–∏ "–ï–∂–µ–¥–Ω–µ–≤–Ω–æ HH:00"
            local time_part="${SCHEDULE#–ï–∂–µ–¥–Ω–µ–≤–Ω–æ }"
            local hour="${time_part%%:*}"
            local minute="${time_part##*:}"
            hour=$((10#$hour))  # –£–±–∏—Ä–∞–µ–º –≤–µ–¥—É—â–∏–π –Ω–æ–ª—å
            minute=$((10#$minute))
            NEW_CRON_LINE="$minute $hour * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
            ;;
        –ö–∞–∂–¥—ã–µ\ *\ –º–∏–Ω)
            local interval="${SCHEDULE#–ö–∞–∂–¥—ã–µ }"
            interval="${interval% –º–∏–Ω}"
            NEW_CRON_LINE="*/$interval * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
            ;;
        *)
            # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            print_message "WARN" "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: $SCHEDULE"
            return 1
            ;;
    esac
    
    if [[ -n "$NEW_CRON_LINE" ]]; then
        local CURRENT_CRON=$(crontab -l 2> "$SILENT_LOG" | grep -v "$JOB_ID")
        echo -e "$CURRENT_CRON\n$NEW_CRON_LINE" | crontab -
        log_message "INFO" "Recreated cron job for $TASK_TYPE: $SCHEDULE"
    fi
}

# --- –ë–≠–ö–ê–ü ---

create_backup() {
    local TYPE="$1"
    debug_log "BACKUP" "=== Starting backup: type=$TYPE ==="
    debug_log "BACKUP" "BOT_PATH=$BOT_PATH"
    debug_log "BACKUP" "BOT_CONTAINER=$BOT_CONTAINER_NAME, DB_CONTAINER=$DB_CONTAINER_NAME"
    debug_log "BACKUP" "IS_INTERACTIVE=$IS_INTERACTIVE"
    
    # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ (—Ç–æ–ª—å–∫–æ –≤ non-interactive —Ä–µ–∂–∏–º–µ)
    local LOCK_ACQUIRED="false"
    if [[ "$IS_INTERACTIVE" == "false" ]]; then
        debug_log "LOCK" "Attempting to acquire lock..."
        if ! acquire_lock; then
            local owner_pid=$(check_lock_owner)
            debug_log "LOCK" "Lock failed! Owner PID: $owner_pid"
            log_message "WARN" "Backup skipped: another instance is running (PID: $owner_pid)"
            print_message "WARN" "–î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –±—ç–∫–∞–ø–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $owner_pid)"
            return 1
        fi
        debug_log "LOCK" "Lock acquired successfully"
        LOCK_ACQUIRED="true"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ (–º–∏–Ω–∏–º—É–º 1GB)
    local MIN_SPACE_MB=1024
    local free_space_kb=$(df -P "$BACKUP_DIR" 2> "$SILENT_LOG" | tail -1 | awk '{print $4}')
    local free_space_mb=$((free_space_kb / 1024))
    local free_space_human=$(df -h "$BACKUP_DIR" 2> "$SILENT_LOG" | tail -1 | awk '{print $4}')
    debug_log "DISK" "Free space: ${free_space_mb}MB (${free_space_human}), required: ${MIN_SPACE_MB}MB"
    
    if [[ $free_space_mb -lt $MIN_SPACE_MB ]]; then
        print_message "ERROR" "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ! –°–≤–æ–±–æ–¥–Ω–æ: ${free_space_human} (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 1GB)"
        log_message "ERROR" "Backup aborted: insufficient disk space (free=${free_space_human}, required=1GB)"
        if [[ "$IS_INTERACTIVE" == "true" ]]; then
            echo ""
            echo -e "${YELLOW}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${RESET}"
            echo " ‚Ä¢ –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–º–µ–Ω—é 5)"
            echo " ‚Ä¢ –û—Å–≤–æ–±–æ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ"
            echo ""
            read -erp "–í—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " force_continue
            if [[ ! "$force_continue" =~ ^[Yy]$ ]]; then
                return 1
            fi
            print_message "WARN" "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω–∞ —Å–≤–æ–π —Ä–∏—Å–∫..."
        else
            # –í non-interactive —Ä–µ–∂–∏–º–µ (cron) –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –ø—Ä–µ—Ä—ã–≤–∞–µ–º
            send_telegram_notification "–ë—ç–∫–∞–ø –ø—Ä–µ—Ä–≤–∞–Ω: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (${free_space_human})"
            [[ "$LOCK_ACQUIRED" == "true" ]] && release_lock
            return 1
        fi
    fi
    
    # Health-check –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –±—ç–∫–∞–ø–æ–º
    if [[ "$TYPE" == "full" || "$TYPE" == "db_only" ]]; then
        debug_log "HEALTH" "Checking DB container health..."
        if [[ -n "$DB_CONTAINER_NAME" ]]; then
            local db_running=$(docker container inspect -f '{{.State.Running}}' "$DB_CONTAINER_NAME" 2> "$SILENT_LOG")
            debug_log "HEALTH" "Container $DB_CONTAINER_NAME running=$db_running"
            if [[ "$db_running" != "true" ]]; then
                print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î ($DB_CONTAINER_NAME) –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
                log_message "ERROR" "Backup aborted: DB container not running ($DB_CONTAINER_NAME)"
                if [[ "$IS_INTERACTIVE" != "true" ]]; then
                    send_telegram_notification "–ë—ç–∫–∞–ø –ø—Ä–µ—Ä–≤–∞–Ω: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î –Ω–µ –∑–∞–ø—É—â–µ–Ω ($DB_CONTAINER_NAME)"
                fi
                [[ "$LOCK_ACQUIRED" == "true" ]] && release_lock
                return 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º health status –µ—Å–ª–∏ –µ—Å—Ç—å
            local db_health=$(docker container inspect -f '{{.State.Health.Status}}' "$DB_CONTAINER_NAME" 2> "$SILENT_LOG")
            debug_log "HEALTH" "Container health status: $db_health"
            if [[ "$db_health" == "unhealthy" ]]; then
                print_message "WARN" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ 'unhealthy'!"
                log_message "WARN" "DB container health status: unhealthy ($DB_CONTAINER_NAME)"
                if [[ "$IS_INTERACTIVE" == "true" ]]; then
                    read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ? (y/N): " cont_unhealthy
                    if [[ ! "$cont_unhealthy" =~ ^[Yy]$ ]]; then
                        return 1
                    fi
                fi
                # –í cron-—Ä–µ–∂–∏–º–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            fi
        fi
    fi
    
    if [[ -z "$BACKUP_PASSWORD" && "$IS_INTERACTIVE" == "true" ]]; then
        clear_screen
        echo -e "${RED}${BOLD}‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–∞—Ä–æ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${RESET}"
        echo "–§–∞–π–ª –±—ç–∫–∞–ø–∞ –Ω–µ –±—É–¥–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º."
        echo ""
        echo " 1. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"
        echo " 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å —Å–µ–π—á–∞—Å"
        echo " 0. –û—Ç–º–µ–Ω–∞"
        echo ""
        read -erp "–í–∞—à –≤—ã–±–æ—Ä: " enc_choice
        case $enc_choice in
            1) ;; 
            2) read -s -erp "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: " np
               echo ""; if [[ -n "$np" ]]; then BACKUP_PASSWORD="$np"; save_config; print_message "SUCCESS" "–ü–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."; else print_message "ERROR" "–ü—É—Å—Ç–æ–π –ø–∞—Ä–æ–ª—å. –û—Ç–º–µ–Ω–∞."; return; fi ;;
            *) print_message "INFO" "–ë—ç–∫–∞–ø –æ—Ç–º–µ–Ω–µ–Ω."; return ;;
        esac
    fi

    local TIMESTAMP=$(date +%Y-%m-%d"_"%H_%M_%S)
    local FILE_DB="db_${TIMESTAMP}.sql.gz"
    local FILE_DIR="dir_${TIMESTAMP}.tar.gz"
    local FILE_VERSION="bot_version.txt"
    local FILE_FINAL=""
    local HAS_ERROR=0
    local SKIP_INFO=""
    local SKIP_FILE="$BACKUP_DIR/skipped_files.txt"

    if [[ "$TYPE" != "db_only" ]]; then if ! ensure_bot_path; then return; fi; fi
    if [[ "$TYPE" == "db_only" || "$TYPE" == "full" ]]; then
        if [[ -z "$DB_CONTAINER_NAME" ]]; then ensure_bot_path; fi
    fi

    local CURRENT_VER=$(get_raw_bot_version)
    echo "${CURRENT_VER:-Unknown}" > "$BACKUP_DIR/$FILE_VERSION"
    debug_log "BACKUP" "Bot version saved: ${CURRENT_VER:-Unknown}"

    if [[ "$TYPE" == "full" || "$TYPE" == "db_only" ]]; then
        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –∏–∑ .env –±–æ—Ç–∞ (—Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
        local ACTUAL_DB_USER=$(get_db_user)
        local ACTUAL_DB_NAME=$(get_db_name)
        debug_log "DB" "DB params: user=$ACTUAL_DB_USER, db=$ACTUAL_DB_NAME"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ë–î —á–µ—Ä–µ–∑ pg_isready (—Å–æ–≥–ª–∞—Å–Ω–æ healthcheck –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
        print_message "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î..."
        debug_log "DB" "Running: docker exec $DB_CONTAINER_NAME pg_isready -U $ACTUAL_DB_USER -d $ACTUAL_DB_NAME"
        if ! docker exec "$DB_CONTAINER_NAME" pg_isready -U "$ACTUAL_DB_USER" -d "$ACTUAL_DB_NAME" > "$SILENT_LOG" 2>&1; then
            print_message "ERROR" "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –≥–æ—Ç–æ–≤–∞! (pg_isready failed)"
            log_message "ERROR" "Backup aborted: pg_isready failed for $DB_CONTAINER_NAME"
            if [[ "$IS_INTERACTIVE" != "true" ]]; then
                send_telegram_notification "–ë—ç–∫–∞–ø –ø—Ä–µ—Ä–≤–∞–Ω: –ë–î –Ω–µ –≥–æ—Ç–æ–≤–∞ ($DB_CONTAINER_NAME)"
            fi
            [[ "$LOCK_ACQUIRED" == "true" ]] && release_lock
            return 1
        fi
        debug_log "DB" "pg_isready: OK"
        
        print_message "INFO" "–î–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ($DB_CONTAINER_NAME, user=$ACTUAL_DB_USER, db=$ACTUAL_DB_NAME)..."
        debug_log "DB" "Running: docker exec $DB_CONTAINER_NAME pg_dump -U $ACTUAL_DB_USER $ACTUAL_DB_NAME | gzip -9 > $BACKUP_DIR/$FILE_DB"
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º pg_dump –≤–º–µ—Å—Ç–æ pg_dumpall (—Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
        # pg_dump –±—ã—Å—Ç—Ä–µ–µ –∏ –ø—Ä–æ—â–µ –¥–ª—è –æ–¥–Ω–æ–π –ë–î
        if ! docker exec "$DB_CONTAINER_NAME" pg_dump -U "$ACTUAL_DB_USER" "$ACTUAL_DB_NAME" 2> "$SILENT_LOG" | gzip -9 > "$BACKUP_DIR/$FILE_DB"; then
            print_message "ERROR" "–û—à–∏–±–∫–∞ –¥–∞–º–ø–∞ –ë–î."
            debug_log "DB" "pg_dump FAILED"
            HAS_ERROR=1
        else
            local db_size=$(du -h "$BACKUP_DIR/$FILE_DB" 2>/dev/null | cut -f1)
            debug_log "DB" "pg_dump SUCCESS, file size: $db_size"
        fi
    fi

    if [[ $HAS_ERROR -eq 1 ]]; then 
        rm -f "$BACKUP_DIR/$FILE_DB" "$BACKUP_DIR/$FILE_VERSION"
        [[ "$LOCK_ACQUIRED" == "true" ]] && release_lock
        return 1
    fi

    IFS=' ' read -r -a EXCLUDE_ARRAY <<< "$EXCLUDE_DIRS"
    EXCLUDE_FLAGS=()
    for ex in "${EXCLUDE_ARRAY[@]}"; do if [[ -n "$ex" ]]; then EXCLUDE_FLAGS+=(--exclude="$ex"); fi; done
    # –ò—Å–∫–ª—é—á–∞–µ–º —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
    # - *.log —Ñ–∞–π–ª—ã
    # - .git –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
    # - Docker –æ–±—Ä–∞–∑—ã (*.tar —Ñ–∞–π–ª—ã)
    # - logs/ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (access-–ª–æ–≥–∏ –∏–∑ ACCESS_LOG_PATH)
    # - backups/ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è (–ª–æ–∫–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    EXCLUDE_FLAGS+=(--exclude="*.log" --exclude=".git" --exclude="logs" --exclude="backups")
    EXCLUDE_FLAGS+=(--exclude="private-remnawave-*.tar" --exclude="rwp_shop*.tar" --exclude="telegram-shop*.tar")
    debug_log "TAR" "Exclude flags: ${EXCLUDE_FLAGS[*]}"

    if [[ "$TYPE" != "db_only" ]]; then
        : > "$SKIP_FILE"
        local BOT_DIRNAME=$(basename "$BOT_PATH")
        debug_log "TAR" "BOT_DIRNAME=$BOT_DIRNAME, MAX_FILE_SIZE_MB=$MAX_FILE_SIZE_MB"
        local FIND_CMD="find ."
        for ex in "${EXCLUDE_ARRAY[@]}"; do if [[ -n "$ex" ]]; then FIND_CMD+=" -path './$ex' -prune -o"; fi; done
        FIND_CMD+=" -type f -size +${MAX_FILE_SIZE_MB}M -print"
        debug_log "TAR" "Find command: $FIND_CMD"
        cd "$BOT_PATH"; eval "$FIND_CMD" | while read -r f; do
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ./path/file –≤ BOT_DIRNAME/path/file –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã --exclude-from
            echo "${BOT_DIRNAME}${f#.}"
        done > "$SKIP_FILE"
        local SKIP_COUNT=$(wc -l < "$SKIP_FILE")
        debug_log "TAR" "Large files to skip: $SKIP_COUNT"
        if [[ "$SKIP_COUNT" -gt 0 ]]; then
            local SKIP_SIZE=$(cd "$BOT_PATH" && eval "$FIND_CMD" | tr '\n' '\0' | du -ch --files0-from=- 2>/dev/null | tail -1 | cut -f1)
            print_message "WARN" "–ü—Ä–æ–ø—É—â–µ–Ω–æ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>${MAX_FILE_SIZE_MB}MB): $SKIP_COUNT (–æ–±—â–∏–π –≤–µ—Å: $SKIP_SIZE)"
            debug_log "TAR" "Skipped files content:"
            if [[ "$DEBUG_MODE" == true ]]; then cat "$SKIP_FILE"; fi
            EXCLUDE_FLAGS+=(--exclude-from="$SKIP_FILE")
            SKIP_INFO=$'\n‚ö†Ô∏è Skip: '"$SKIP_COUNT"$' (>'"$MAX_FILE_SIZE_MB"$'MB)'
        fi
    fi

    if [[ "$TYPE" == "db_only" ]]; then
        FILE_FINAL="lazarus_db_${TIMESTAMP}.tar.gz"
        debug_log "TAR" "Creating DB archive: $FILE_FINAL"
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "$FILE_DB"
        rm -f "$BACKUP_DIR/$FILE_DB"
    elif [[ "$TYPE" == "files_only" ]]; then
        FILE_FINAL="lazarus_files_${TIMESTAMP}.tar.gz"
        local FILE_DIR="bot_files_${TIMESTAMP}.tar.gz"
        print_message "INFO" "–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
        debug_log "TAR" "Creating files archive: $FILE_FINAL"
        debug_log "TAR" "Running: tar -czf $BACKUP_DIR/$FILE_DIR ${EXCLUDE_FLAGS[*]} -C $(dirname "$BOT_PATH") $(basename "$BOT_PATH")"
        # –°–Ω–∞—á–∞–ª–∞ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –±–æ—Ç–∞ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
        tar -czf "$BACKUP_DIR/$FILE_DIR" "${EXCLUDE_FLAGS[@]}" -C "$(dirname "$BOT_PATH")" "$(basename "$BOT_PATH")"
        # –ó–∞—Ç–µ–º –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å –≤–µ—Ä—Å–∏–µ–π
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "$FILE_DIR"
        rm -f "$BACKUP_DIR/$FILE_DIR"
    else 
        FILE_FINAL="lazarus_full_${TIMESTAMP}.tar.gz"
        print_message "INFO" "–ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
        debug_log "TAR" "Creating full archive: $FILE_FINAL"
        tar -czf "$BACKUP_DIR/$FILE_DIR" "${EXCLUDE_FLAGS[@]}" -C "$(dirname "$BOT_PATH")" "$(basename "$BOT_PATH")"
        tar -czf "$BACKUP_DIR/$FILE_FINAL" -C "$BACKUP_DIR" "$FILE_VERSION" "$FILE_DB" "$FILE_DIR"
        rm -f "$BACKUP_DIR/$FILE_DB" "$BACKUP_DIR/$FILE_DIR"
    fi

    rm -f "$SKIP_FILE"

    local ENC_STATUS="üîì Unencrypted"
    if [[ -z "$BACKUP_PASSWORD" && "$IS_INTERACTIVE" == "false" ]]; then ENC_STATUS="‚ö†Ô∏è NO PASSWORD"; fi

    if [[ -n "$BACKUP_PASSWORD" ]]; then
        print_message "INFO" "–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
        # Pass password via env var to avoid process listing leak
        # AES-256-CBC + PBKDF2 with 100k iterations for brute-force protection
        export LAZARUS_ENC_PASS="$BACKUP_PASSWORD"
        openssl enc -aes-256-cbc -salt -pbkdf2 -iter 100000 -in "$BACKUP_DIR/$FILE_FINAL" -out "$BACKUP_DIR/${FILE_FINAL}.enc" -pass env:LAZARUS_ENC_PASS
        local enc_res=$?
        unset LAZARUS_ENC_PASS
        
        if [[ $enc_res -eq 0 ]]; then
            rm "$BACKUP_DIR/$FILE_FINAL"
            FILE_FINAL="${FILE_FINAL}.enc"
            ENC_STATUS="üîí Encrypted"
            print_message "SUCCESS" "–ê—Ä—Ö–∏–≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω."
            debug_log "ENC" "Encryption successful: $FILE_FINAL"
        else
            print_message "ERROR" "–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è! –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞."
            debug_log "ENC" "Encryption FAILED!"
        fi
    fi

    local FINAL_VERSION_FILE="$BACKUP_DIR/$FILE_FINAL.version"
    cp "$BACKUP_DIR/$FILE_VERSION" "$FINAL_VERSION_FILE"
    rm -f "$BACKUP_DIR/$FILE_VERSION"
    debug_log "BACKUP" "Version file: $FINAL_VERSION_FILE"
    
    # --- VERIFY ARCHIVE ---
    print_message "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏–≤–∞..."
    debug_log "VERIFY" "Verifying archive integrity..."
    local VERIFY_OK="false"
    if [[ "$FILE_FINAL" == *".enc" ]]; then
        # For encrypted files, we can't easily verify without decrypting. 
        # We assume openssl exit code 0 was enough, or we could decrypt to /dev/null
        debug_log "VERIFY" "Running: openssl enc -d ... | gzip -t"
        export LAZARUS_VERIFY_PASS="$BACKUP_PASSWORD"
        if openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 -in "$BACKUP_DIR/$FILE_FINAL" -pass env:LAZARUS_VERIFY_PASS | gzip -t 2> "$SILENT_LOG"; then
             VERIFY_OK="true"
        fi
        unset LAZARUS_VERIFY_PASS
    else
        debug_log "VERIFY" "Running: gzip -t $BACKUP_DIR/$FILE_FINAL"
        if gzip -t "$BACKUP_DIR/$FILE_FINAL" 2> "$SILENT_LOG"; then
             VERIFY_OK="true"
        fi
    fi
    debug_log "VERIFY" "Result: $VERIFY_OK"

    if [[ "$VERIFY_OK" == "true" ]]; then
        print_message "SUCCESS" "–ê—Ä—Ö–∏–≤ –≤–∞–ª–∏–¥–µ–Ω."
    else
        print_message "ERROR" "–ê—Ä—Ö–∏–≤ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω! (Verification failed)"
        # We do not delete it, just warn
    fi

    local SIZE=$(du -h "$BACKUP_DIR/$FILE_FINAL" | awk '{print $1}')
    print_message "SUCCESS" "–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $FILE_FINAL ($SIZE)"
    log_message "SUCCESS" "Backup created: $FILE_FINAL (type=$TYPE, size=$SIZE, enc_status=$ENC_STATUS, verify=$VERIFY_OK)"
    debug_log "BACKUP" "Final file: $FILE_FINAL, size: $SIZE"

    debug_log "UPLOAD" "Starting remote upload..."
    upload_to_remote "$BACKUP_DIR/$FILE_FINAL"
    debug_log "UPLOAD" "Remote upload complete"
    
    local DISPLAY_DATE=$(date "+%d.%m.%Y %H:%M:%S")
    local HASHTAG=""; local TYPE_NAME=""; local ROTATION_KEY=""
    
    case "$TYPE" in
        "full") HASHTAG="üíæ #full_backup"; TYPE_NAME="üì¶ –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø"; ROTATION_KEY="–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã" ;;
        "db_only") HASHTAG="üíæ #db_only"; TYPE_NAME="üóÑ –î–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"; ROTATION_KEY="–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" ;;
        "files_only") HASHTAG="üíæ #files_only"; TYPE_NAME="üìÇ –§–∞–π–ª—ã –±–æ—Ç–∞"; ROTATION_KEY="–ê—Ä—Ö–∏–≤—ã —Ñ–∞–π–ª–æ–≤" ;;
    esac

    local VER_MSG=""; [[ -n "$CURRENT_VER" ]] && VER_MSG=" | üè∑ v${CURRENT_VER}"
    local CAPTION="${HASHTAG}
üìÖ ${DISPLAY_DATE}
${TYPE_NAME}
üìè ${SIZE}${VER_MSG}
${ENC_STATUS}${REMOTE_UPLOAD_STATUS_TEXT}${SKIP_INFO}"
    
    send_telegram_document "$BACKUP_DIR/$FILE_FINAL" "$CAPTION"

    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –±—ç–∫–∞–ø–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è (–ø–æ–¥–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ —Å—á—ë—Ç—á–∏–∫–æ–≤)
    local ROTATION_PREFIX="lazarus_$TYPE"
    if [[ "$TYPE" == "db_only" ]]; then ROTATION_PREFIX="lazarus_db"; fi
    if [[ "$TYPE" == "files_only" ]]; then ROTATION_PREFIX="lazarus_files"; fi

    # –†–æ—Ç–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ DELETE_MODE
    if [[ "$DELETE_MODE" == "count" ]]; then
        rotate_backups_by_count "$ROTATION_PREFIX" "$ROTATION_KEY" "true" > /dev/null
    else
        rotate_backups_by_age "$ROTATION_PREFIX" "$ROTATION_KEY" "$RETENTION_DAYS" "true" > /dev/null
    fi
    
    # –†–æ—Ç–∞—Ü–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏–º–∏—Ç)
    rotate_backups_by_size "true" > /dev/null
    
    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    [[ "$LOCK_ACQUIRED" == "true" ]] && release_lock
    
    return 0
}

# --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï ---

select_backup_file() {
    local FILTER_PREFIX="$1"; local TITLE="$2"
    local show_limit=5; local show_filenames=false

    while true; do
        local files_raw=("$BACKUP_DIR/${FILTER_PREFIX}_"*.tar.gz*)
        local valid_files=()
        for f in "${files_raw[@]}"; do
            if [[ ! -e "$f" ]]; then continue; fi 
            if [[ "$f" == *".version" ]]; then continue; fi
            if [[ ! "$f" =~ \.tar\.gz(\.enc)?$ ]]; then continue; fi
            valid_files+=("$f")
        done
        
        local total_count=${#valid_files[@]}
        
        if [[ "$total_count" -eq 0 ]]; then
            print_message "WARN" "–§–∞–π–ª–æ–≤ —Ç–∏–ø–∞ '${TITLE}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."; read -erp "Enter..." dummy; return 1
        fi
        
        IFS=$'\n' sorted_backups=($(sort -r <<<"${valid_files[*]}"))
        unset IFS
        
        local CURRENT_VER=$(get_raw_bot_version)

        clear_screen; echo -e "${GREEN}–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: ${BOLD}${TITLE}${RESET}"
        echo -e "–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${CYAN}${total_count}${RESET}"; echo ""

        local loop_limit=$show_limit
        if [[ $loop_limit -gt $total_count ]]; then loop_limit=$total_count; fi

        for (( i=0; i<loop_limit; i++ )); do
            local file="${sorted_backups[$i]}"
            local filename=$(basename "$file")
            
            local CACHE_FILE="${file}.version"
            local B_VER=""
            if [[ -f "$CACHE_FILE" ]]; then B_VER=$(cat "$CACHE_FILE")
            else
                if [[ "$file" != *".enc" ]]; then
                    B_VER=$(tar -xzf "$file" -O bot_version.txt 2> "$SILENT_LOG")
                fi
                if [[ -n "$B_VER" ]]; then echo "$B_VER" > "$CACHE_FILE"; else echo "?" > "$CACHE_FILE"; B_VER="?"; fi
            fi
            
            local ENC_MARK=""; [[ "$file" == *".enc" ]] && ENC_MARK="${RED}[ENC]${RESET} "
            
            local VER_STR=""
            if [[ "$B_VER" == "Unknown" || "$B_VER" == "" ]]; then VER_STR="${GRAY}[–ù/–î]${RESET}"
            elif [[ "$B_VER" == "?" ]]; then VER_STR="${GRAY}[Legacy]${RESET}"
            elif [[ -z "$CURRENT_VER" ]]; then VER_STR="${GRAY}[v$B_VER]${RESET}"
            elif [[ "$B_VER" == "$CURRENT_VER" ]]; then VER_STR="${GREEN}[v$B_VER]${RESET}"
            else VER_STR="${RED}[v$B_VER]${RESET}"; fi

            if [[ "$show_filenames" == "true" ]]; then
                printf " %2d. %s%s %s\n" "$((i+1))" "$ENC_MARK" "$filename" "$VER_STR"
            else
                if [[ $filename =~ _([0-9]{4}-[0-9]{2}-[0-9]{2})_([0-9]{2})_([0-9]{2}) ]]; then
                    local date_part="${BASH_REMATCH[1]}"
                    local time_part="${BASH_REMATCH[2]}:${BASH_REMATCH[3]}"
                    local d_d=${date_part:8:2}; local d_m=${date_part:5:2}
                    local pretty_date="$d_d.$d_m $time_part"
                    local fsize=$(du -h "$file" | awk '{print $1}')
                    printf " %2d. %s | %5s | %s%s\n" "$((i+1))" "${BOLD}$pretty_date${RESET}" "$fsize" "$ENC_MARK" "$VER_STR"
                else
                    printf " %2d. %s %s\n" "$((i+1))" "$filename" "$VER_STR"
                fi
            fi
        done

        echo ""
        if [[ $total_count -gt 5 ]]; then
            if [[ $loop_limit -lt $total_count ]]; then
                 echo -e " ${MAGENTA}888. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ($total_count —à—Ç)${RESET}"
            else
                 echo -e " ${MAGENTA}888. –°–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ (–ø–æ–∫–∞–∑–∞—Ç—å 5)${RESET}"
            fi
        fi

        if [[ "$show_filenames" == "false" ]]; then
            echo -e " 999. –ü–æ–∫–∞–∑–∞—Ç—å –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤"; 
        else
            echo -e " 999. –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É –∏ —Ä–∞–∑–º–µ—Ä"; 
        fi
        echo " 0. –ù–∞–∑–∞–¥"; echo ""
        read -erp "–ù–æ–º–µ—Ä —Ñ–∞–π–ª–∞ –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ (Enter - –ù–∞–∑–∞–¥): " choice
        
        if [[ -z "$choice" || "$choice" == "0" ]]; then return 1
        elif [[ "$choice" == "888" ]]; then 
            if [[ $loop_limit -lt $total_count ]]; then loop_limit=$total_count; else loop_limit=5; fi
            show_limit=$loop_limit
            continue
        elif [[ "$choice" == "999" ]]; then 
            if [[ "$show_filenames" == "false" ]]; then show_filenames=true; else show_filenames=false; fi
            continue
        elif [[ "$choice" =~ ^[0-9]+$ && "$choice" -ge 1 && "$choice" -le "$total_count" ]]; then SELECTED_FILE="${sorted_backups[$((choice-1))]}"; return 0
        else print_message "ERROR" "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä."; sleep 1; fi
    done
}

execute_restore() {
    local MODE="$1"; local FILE="$2"
    debug_log "RESTORE" "=== execute_restore ==="
    debug_log "RESTORE" "Mode: $MODE, File: $FILE"
    echo ""; print_message "WARN" "–í–ù–ò–ú–ê–ù–ò–ï: –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã!"
    read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " confirm; [[ "$confirm" != "y" ]] && return

    local TMP_DIR="$BACKUP_DIR/restore_tmp_$$"
    mkdir -p "$TMP_DIR"
    debug_log "RESTORE" "Temp dir: $TMP_DIR"
    
    local WORK_FILE="$FILE"
    if [[ "$FILE" == *".enc" ]]; then
        print_message "INFO" "–§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å."
        debug_log "RESTORE" "File is encrypted, requesting password..."
        read -s -erp "–ü–∞—Ä–æ–ª—å: " decrypt_pass; echo ""
        local DECRYPTED_FILE="$TMP_DIR/decrypted.tar.gz"
        
        debug_log "RESTORE" "Decrypting to: $DECRYPTED_FILE"
        export LAZARUS_DEC_PASS="$decrypt_pass"
        openssl enc -d -aes-256-cbc -pbkdf2 -iter 100000 -in "$FILE" -out "$DECRYPTED_FILE" -pass env:LAZARUS_DEC_PASS 2> "$SILENT_LOG"
        local dec_res=$?
        unset LAZARUS_DEC_PASS
        debug_log "RESTORE" "Decryption result: $dec_res"

        if [[ $dec_res -ne 0 ]]; then print_message "ERROR" "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π —Ñ–∞–π–ª!"; rm -rf "$TMP_DIR"; return; fi
        print_message "SUCCESS" "–ü–∞—Ä–æ–ª—å –ø—Ä–∏–Ω—è—Ç."
        WORK_FILE="$DECRYPTED_FILE"
    fi

    print_message "INFO" "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞..."
    debug_log "RESTORE" "Extracting: tar -xzf $WORK_FILE -C $TMP_DIR"
    tar -xzf "$WORK_FILE" -C "$TMP_DIR"
    debug_log "RESTORE" "Contents: $(ls -la "$TMP_DIR")"

    local DB_DUMP=$(find "$TMP_DIR" -name "db_*.sql.gz" | head -1)
    local DIR_ARC=$(find "$TMP_DIR" -name "dir_*.tar.gz" | head -1)
    debug_log "RESTORE" "DB_DUMP: $DB_DUMP"
    debug_log "RESTORE" "DIR_ARC: $DIR_ARC"

    if [[ "$MODE" == "full" && -n "$DIR_ARC" ]]; then
        if ! ensure_bot_path; then rm -rf "$TMP_DIR"; return; fi
        print_message "INFO" "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        debug_log "RESTORE" "Stopping containers in $BOT_PATH"
        cd "$BOT_PATH" && docker compose down 2> "$SILENT_LOG"
        print_message "INFO" "–û—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏..."
        debug_log "RESTORE" "Cleaning $BOT_PATH/*"
        rm -rf "$BOT_PATH"/*
        print_message "INFO" "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
        debug_log "RESTORE" "Extracting: tar -xzf $DIR_ARC -C $(dirname "$BOT_PATH")"
        tar -xzf "$DIR_ARC" -C "$(dirname "$BOT_PATH")"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è volume –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        local volume_name=$(get_db_volume_name)
        debug_log "RESTORE" "DB Volume: $volume_name"
        if [[ -n "$volume_name" ]]; then
            print_message "INFO" "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ volume: $volume_name"
            debug_log "RESTORE" "Running: docker volume rm $volume_name"
            docker volume rm "$volume_name" 2> "$SILENT_LOG" || true
        else
            print_message "WARN" "Volume –ë–î –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ."
        fi
        
        print_message "INFO" "–ó–∞–ø—É—Å–∫ –ë–î..."
        debug_log "RESTORE" "Running: docker compose up -d $DB_SERVICE_NAME"
        docker compose up -d "$DB_SERVICE_NAME"
        sleep 5
    fi

    if [[ -n "$DB_DUMP" ]]; then
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        if ! ensure_bot_path; then rm -rf "$TMP_DIR"; return; fi
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –∏–∑ .env –±–æ—Ç–∞
        local ACTUAL_DB_USER=$(get_db_user)
        local ACTUAL_DB_NAME=$(get_db_name)
        debug_log "RESTORE" "DB params: user=$ACTUAL_DB_USER, db=$ACTUAL_DB_NAME"
        
        # –°–æ–≥–ª–∞—Å–Ω–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: –æ—á–∏—â–∞–µ–º —Å—Ö–µ–º—É –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
        # https://docs.remnawave.shop/ru/private/backup/
        print_message "INFO" "–û—á–∏—Å—Ç–∫–∞ —Å—Ö–µ–º—ã –ë–î (DROP SCHEMA public CASCADE)..."
        debug_log "RESTORE" "Running: docker exec $DB_CONTAINER_NAME psql -U $ACTUAL_DB_USER -c 'DROP SCHEMA...'"
        docker exec -i "$DB_CONTAINER_NAME" psql -U "$ACTUAL_DB_USER" -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;" > "$SILENT_LOG" 2>&1
        
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (user=$ACTUAL_DB_USER, db=$ACTUAL_DB_NAME)..."
        debug_log "RESTORE" "Running: zcat $DB_DUMP | docker exec $DB_CONTAINER_NAME psql -U $ACTUAL_DB_USER $ACTUAL_DB_NAME"
        zcat "$DB_DUMP" | docker exec -i "$DB_CONTAINER_NAME" psql -U "$ACTUAL_DB_USER" "$ACTUAL_DB_NAME" > "$SILENT_LOG" 2>&1
        debug_log "RESTORE" "DB import complete"
    fi

    if [[ "$MODE" == "full" ]]; then
        print_message "INFO" "–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
        debug_log "RESTORE" "Running: docker compose up -d"
        cd "$BOT_PATH" && docker compose up -d
    fi

    rm -rf "$TMP_DIR"
    debug_log "RESTORE" "Temp dir cleaned up"
    print_message "SUCCESS" "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."
    log_message "SUCCESS" "Restore completed (mode=$MODE, file=$FILE)"
    read -erp "–ù–∞–∂–º–∏—Ç–µ Enter..." dummy
}

# --- –ú–ï–ù–Æ–®–ö–ò ---

menu_manual_backup() {
    while true; do
        clear_screen; echo -e "${GREEN}–°–æ–∑–¥–∞–Ω–∏–µ —Ä—É—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞${RESET}"
        echo " 1. –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø (–ë–î + –§–∞–π–ª—ã)"
        echo " 2. –¢–æ–ª—å–∫–æ –ë–î"
        echo " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í–∞—à –≤—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " m_choice
        [[ -z "$m_choice" ]] && return
        case $m_choice in
            1) create_backup "full"; read -erp "Enter..." dummy; return ;;
            2) create_backup "db_only"; read -erp "Enter..." dummy; return ;;
            3) create_backup "files_only"; read -erp "Enter..." dummy; return ;;
            0) return ;;
        esac
    done
}

menu_restore() {
    while true; do
        # –°–¢–†–û–ì–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–î–°–ß–ï–¢–ê
        local n_full=$(find "$BACKUP_DIR" -type f \( -name "lazarus_full_*.tar.gz" -o -name "lazarus_full_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)
        local n_db=$(find "$BACKUP_DIR" -type f \( -name "lazarus_db_*.tar.gz" -o -name "lazarus_db_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)
        local n_files=$(find "$BACKUP_DIR" -type f \( -name "lazarus_files_*.tar.gz" -o -name "lazarus_files_*.tar.gz.enc" \) 2> "$SILENT_LOG" | wc -l)

        local c_f="$CYAN"; [[ "$n_full" == "0" ]] && c_f="$GRAY"
        local c_d="$CYAN"; [[ "$n_db" == "0" ]] && c_d="$GRAY"
        local c_fl="$CYAN"; [[ "$n_files" == "0" ]] && c_fl="$GRAY"

        clear_screen; echo -e "${GREEN}–ú–µ–Ω—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è${RESET}"
        echo -e " 1. –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø      ${c_f}[${n_full} —à—Ç]${RESET}"
        echo -e " 2. –¢–æ–ª—å–∫–æ –ë–î         ${c_d}[${n_db} —à—Ç]${RESET}"
        echo -e " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã      ${c_fl}[${n_files} —à—Ç]${RESET}"
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " r_choice
        [[ -z "$r_choice" ]] && return

        local SELECTED_FILE=""
        case $r_choice in
            1) if select_backup_file "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã"; then execute_restore "full" "$SELECTED_FILE"; fi ;;
            2) if select_backup_file "lazarus_db" "–ë—ç–∫–∞–ø—ã –ë–î"; then execute_restore "db_only" "$SELECTED_FILE"; fi ;;
            3) if select_backup_file "lazarus_files" "–ë—ç–∫–∞–ø—ã –§–∞–π–ª–æ–≤"; then 
                   echo ""; print_message "WARN" "–ë—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ –±–æ—Ç–∞!"
                   read -erp "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " cf
                   if [[ "$cf" == "y" ]]; then 
                       if ensure_bot_path; then tar -xzf "$SELECTED_FILE" -C "$(dirname "$BOT_PATH")"; print_message "SUCCESS" "–§–∞–π–ª—ã —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã."; read -erp "Enter..." dummy; fi
                   fi
               fi ;;
            0) return ;;
        esac
    done
}

setup_cron_task() {
    local TASK_TYPE="$1"; local JOB_CMD=""; local JOB_ID=""
    if [[ "$TASK_TYPE" == "db" ]]; then JOB_CMD="$SYMLINK_PATH backup_db"; JOB_ID="# LAZARUS-JOB-DB"
    elif [[ "$TASK_TYPE" == "files" ]]; then if ! ensure_bot_path; then return; fi; JOB_CMD="$SYMLINK_PATH backup_files"; JOB_ID="# LAZARUS-JOB-FILES"
    elif [[ "$TASK_TYPE" == "full" ]]; then if ! ensure_bot_path; then return; fi; JOB_CMD="$SYMLINK_PATH backup_full"; JOB_ID="# LAZARUS-JOB-FULL"; fi

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
    local CURRENT_STATUS=$(get_cron_status "$TASK_TYPE")
    local STATUS_COLOR="$GRAY"; [[ "$CURRENT_STATUS" != "–í—ã–∫–ª" ]] && STATUS_COLOR="$YELLOW"
    
    # –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞
    local TYPE_NAME=""
    case "$TASK_TYPE" in
        "full") TYPE_NAME="–ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø" ;;
        "db") TYPE_NAME="–¢–æ–ª—å–∫–æ –ë–î" ;;
        "files") TYPE_NAME="–¢–æ–ª—å–∫–æ –§–∞–π–ª—ã" ;;
    esac

    clear_screen
    echo -e "${GREEN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ${TYPE_NAME}${RESET}"
    echo -e "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: [${STATUS_COLOR}${CURRENT_STATUS}${RESET}]"
    echo ""
    echo -e " 1. –ï–∂–µ—á–∞—Å–Ω–æ          ${GRAY}[–≤ :00]${RESET}"
    echo -e " 2. –ï–∂–µ–¥–Ω–µ–≤–Ω–æ         ${GRAY}[–≤ 04:00]${RESET}"
    echo -e " 3. –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ       ${GRAY}[–ü–Ω –≤ 04:00]${RESET}"
    echo -e " 4. –°–≤–æ—ë –≤—Ä–µ–º—è        ${GRAY}[–ß–ß:–ú–ú]${RESET}"
    echo -e " 5. –ö–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç    ${GRAY}[1-59]${RESET}"
    echo ""
    if [[ "$CURRENT_STATUS" != "–í—ã–∫–ª" ]]; then
        echo -e " ${RED}0. –û—Ç–∫–ª—é—á–∏—Ç—å${RESET}"
    else
        echo " 0. –ù–∞–∑–∞–¥"
    fi
    echo ""
    read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " c
    [[ -z "$c" ]] && return
    
    local NEW_CRON_LINES=""; local DISPLAY_TIME=""

    case $c in
        1) NEW_CRON_LINES="0 * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ—á–∞—Å–Ω–æ" ;;
        2) NEW_CRON_LINES="0 4 * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 04:00" ;;
        3) NEW_CRON_LINES="0 4 * * 1 $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"; DISPLAY_TIME="–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ" ;;
        4) 
           echo ""
           echo "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è (–ß–ß:–ú–ú), –º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª:"
           echo -e "${GRAY}–ü—Ä–∏–º–µ—Ä: 09:00 18:30${RESET}"
           read -erp "> " times_input
           if [[ -z "$times_input" ]]; then print_message "ERROR" "–í—Ä–µ–º—è –Ω–µ –≤–≤–µ–¥–µ–Ω–æ!"; sleep 1; return; fi
           for t in $times_input; do 
               if [[ "$t" =~ ^([0-9]{1,2}):([0-9]{1,2})$ ]]; then 
                   h=$((10#${BASH_REMATCH[1]})); m=$((10#${BASH_REMATCH[2]}))
                   NEW_CRON_LINES+="$m $h * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"$'\n'
               fi
           done
           DISPLAY_TIME="–°–≤–æ–µ: $times_input" ;;
        5) 
           echo ""
           echo "–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –º–∏–Ω—É—Ç–∞—Ö (1-59):"
           read -erp "> " interval
           if [[ "$interval" =~ ^[0-9]+$ ]] && [ "$interval" -gt 0 ] && [ "$interval" -lt 60 ]; then
               NEW_CRON_LINES="*/$interval * * * * $JOB_CMD >> /var/log/lazarus_backup.log 2>&1 $JOB_ID"
               DISPLAY_TIME="–ö–∞–∂–¥—ã–µ $interval –º–∏–Ω"
           else print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 59."; sleep 1; return; fi ;;
        0) 
           if [[ "$CURRENT_STATUS" != "–í—ã–∫–ª" ]]; then
               DISPLAY_TIME="–í—ã–∫–ª"
           else
               return
           fi ;;
        *) return ;;
    esac

    local CURRENT_CRON=$(crontab -l 2> "$SILENT_LOG" | grep -v "$JOB_ID")
    if [[ "$DISPLAY_TIME" != "–í—ã–∫–ª" && -n "$NEW_CRON_LINES" ]]; then echo -e "$CURRENT_CRON\n$NEW_CRON_LINES" | crontab -
    else echo "$CURRENT_CRON" | crontab -; fi

    # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º cron
    sync_cron_with_config
    
    log_message "INFO" "Cron task updated: $TASK_TYPE -> $DISPLAY_TIME"
    print_message "SUCCESS" "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!"; sleep 1
}

menu_automation() {
    while true; do
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ cron
        local CRON_FULL=$(get_cron_status "full")
        local CRON_DB=$(get_cron_status "db")
        local CRON_FILES=$(get_cron_status "files")
        
        # –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: –∂—ë–ª—Ç—ã–π –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω, —Å–µ—Ä—ã–π –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω
        local COLOR_FULL="$GRAY"; [[ "$CRON_FULL" != "–í—ã–∫–ª" ]] && COLOR_FULL="$YELLOW"
        local COLOR_DB="$GRAY"; [[ "$CRON_DB" != "–í—ã–∫–ª" ]] && COLOR_DB="$YELLOW"
        local COLOR_FILES="$GRAY"; [[ "$CRON_FILES" != "–í—ã–∫–ª" ]] && COLOR_FILES="$YELLOW"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ-–±—ç–∫–∞–ø
        local HAS_ANY_CRON=false
        [[ "$CRON_FULL" != "–í—ã–∫–ª" || "$CRON_DB" != "–í—ã–∫–ª" || "$CRON_FILES" != "–í—ã–∫–ª" ]] && HAS_ANY_CRON=true
        
        clear_screen
        echo -e "${GREEN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ë—ç–∫–∞–ø–∞${RESET}"
        echo ""
        echo -e " 1. –ü–æ–ª–Ω—ã–π –±—ç–∫–∞–ø  [${COLOR_FULL}${CRON_FULL}${RESET}]"
        echo -e " 2. –¢–æ–ª—å–∫–æ –ë–î     [${COLOR_DB}${CRON_DB}${RESET}]"
        echo -e " 3. –¢–æ–ª—å–∫–æ –§–∞–π–ª—ã  [${COLOR_FILES}${CRON_FILES}${RESET}]"
        echo ""
        if [[ "$HAS_ANY_CRON" == true ]]; then
            echo -e " ${RED}9. –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ –∞–≤—Ç–æ-–±—ç–∫–∞–ø—ã${RESET}"
            echo ""
        fi
        echo " 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä (Enter - –ù–∞–∑–∞–¥): " ac
        [[ -z "$ac" ]] && return
        case $ac in
            1) setup_cron_task "full" ;;
            2) setup_cron_task "db" ;;
            3) setup_cron_task "files" ;;
            9) 
                if [[ "$HAS_ANY_CRON" == true ]]; then
                    disable_all_cron_tasks
                fi
                ;;
            0) return ;;
        esac
    done
}

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö cron-–∑–∞–¥–∞—á LAZARUS
disable_all_cron_tasks() {
    echo ""
    print_message "WARN" "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –í–°–ï –∞–≤—Ç–æ-–±—ç–∫–∞–ø—ã?"
    read -erp "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å? (y/n): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ cron-–∑–∞–¥–∞—á–∏ LAZARUS
        local current_cron
        current_cron=$(crontab -l 2> "$SILENT_LOG" || echo "")
        local new_cron
        new_cron=$(echo "$current_cron" | grep -v "# LAZARUS-JOB-")
        
        if [[ -z "$new_cron" ]]; then
            crontab -r 2> "$SILENT_LOG" || true
        else
            echo "$new_cron" | crontab -
        fi
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥
        SCHEDULE_FULL="–í—ã–∫–ª"
        SCHEDULE_DB="–í—ã–∫–ª"
        SCHEDULE_FILES="–í—ã–∫–ª"
        save_config
        
        print_message "SUCCESS" "–í—Å–µ –∞–≤—Ç–æ-–±—ç–∫–∞–ø—ã –æ—Ç–∫–ª—é—á–µ–Ω—ã"
        log_message "INFO" "All LAZARUS cron tasks disabled by user"
        sleep 1.5
    else
        print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ"
        sleep 1
    fi
}

menu_settings() {
    while true; do
        clear_screen; echo -e "${GREEN}${BOLD}–ù–∞—Å—Ç—Ä–æ–π–∫–∏${RESET}"
        
        local MASKED_TOKEN="${BOT_TOKEN:0:5}.......${BOT_TOKEN: -5}"; [[ ${#BOT_TOKEN} -lt 10 ]] && MASKED_TOKEN="*******"
        local PASS_MASK="–ù–µ—Ç"; [[ -n "$BACKUP_PASSWORD" ]] && PASS_MASK="********"
        
        # –ú–∞—Å–∫–∏—Ä—É–µ–º Chat ID (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–∏–º–≤–æ–ª–∞)
        local MASKED_CHAT_ID="-"
        if [[ -n "$CHAT_ID" ]]; then
            if [[ ${#CHAT_ID} -gt 8 ]]; then
                MASKED_CHAT_ID="${CHAT_ID:0:4}...${CHAT_ID: -3}"
            else
                MASKED_CHAT_ID="*****"
            fi
        fi
        
        local MASKED_REMOTE_USER="-"
        if [[ -n "$REMOTE_STORAGE_USER" ]]; then
            if [[ ${#REMOTE_STORAGE_USER} -gt 4 ]]; then
                MASKED_REMOTE_USER="${REMOTE_STORAGE_USER:0:3}...${REMOTE_STORAGE_USER: -2}"
            else
                MASKED_REMOTE_USER="*****"
            fi
        fi

        # –°—Ç–∞—Ç—É—Å—ã
        local ST_TG_NOTIFY="${RED}–í—ã–∫–ª${RESET}"; [[ "$SEND_TO_TELEGRAM" == "true" ]] && ST_TG_NOTIFY="${GREEN}–í–∫–ª${RESET}"
        local ST_TG_FILE="${RED}–í—ã–∫–ª${RESET}"; [[ "$TG_SEND_FILE" == "true" ]] && ST_TG_FILE="${GREEN}–í–∫–ª${RESET}"
        local ST_REM="${RED}–í—ã–∫–ª${RESET}"; [[ "$SEND_TO_REMOTE" == "true" ]] && ST_REM="${GREEN}–í–∫–ª${RESET}"
        
        local STORAGE_TYPE_DISP="–í—ã–∫–ª"
        if [[ "$REMOTE_STORAGE_TYPE" != "off" ]]; then STORAGE_TYPE_DISP="${REMOTE_STORAGE_TYPE^^}"; fi

        echo -e "${CYAN}--- –û–ë–©–ò–ï ---${RESET}"
        echo -e " 1. –ü—É—Ç—å –∫ –±–æ—Ç—É:        ${GRAY}${BOT_PATH}${RESET}"
        echo -e " 2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞:     ${GRAY}${BOT_CONTAINER_NAME}${RESET}"
        echo -e " 3. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î:       ${GRAY}${DB_CONTAINER_NAME}${RESET}"
        echo -e " 4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î:    ${GRAY}${DB_USER}${RESET}"
        echo -e " 5. –ò—Å–∫–ª—é—á–∏—Ç—å –ø–∞–ø–∫–∏:    ${GRAY}${EXCLUDE_DIRS:-–ù–µ—Ç}${RESET}"
        echo -e " 6. –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${GRAY}${MAX_FILE_SIZE_MB} MB${RESET}"
        
        echo -e "\n${CYAN}--- TELEGRAM ---${RESET}"
        echo -e " 7.  Token:             ${GRAY}${MASKED_TOKEN}${RESET}"
        echo -e " 8.  Chat ID:           ${GRAY}${MASKED_CHAT_ID}${RESET}"
        echo -e " 9.  Thread ID:         ${GRAY}${TG_MESSAGE_THREAD_ID:-–ù–µ—Ç}${RESET}"
        echo -e " 10. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:       $ST_TG_NOTIFY"
        echo -e " 11. –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞:    $ST_TG_FILE"
        echo -e " 12. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å"

        echo -e "\n${CYAN}--- –£–î–ê–õ–Å–ù–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ---${RESET}"
        echo -e " 13. –¢–∏–ø:               ${GRAY}${STORAGE_TYPE_DISP}${RESET}"
        echo -e " 14. URL:               ${GRAY}${REMOTE_STORAGE_URL:-–ù–µ—Ç}${RESET}"
        echo -e " 15. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:      ${GRAY}${MASKED_REMOTE_USER}${RESET}"
        echo -e " 16. –ó–∞–≥—Ä—É–∑–∫–∞:          $ST_REM"
        echo -e " 17. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å / –ü—Ä–æ–≤–µ—Ä–∏—Ç—å"

        echo -e "\n${CYAN}--- –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ ---${RESET}"
        echo -e " 18. –ü–∞—Ä–æ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ${GRAY}${PASS_MASK}${RESET}"
        
        echo -e "\n${CYAN}--- –†–û–¢–ê–¶–ò–Ø –ë–≠–ö–ê–ü–û–í ---${RESET}"
        local DM_DISPLAY="–ü–æ –≤—Ä–µ–º–µ–Ω–∏"; [[ "$DELETE_MODE" == "count" ]] && DM_DISPLAY="–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É"
        echo -e " 19. –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è:    ${GRAY}${DM_DISPLAY}${RESET}"
        if [[ "$DELETE_MODE" == "count" ]]; then
            echo -e " 20. –ú–∞–∫—Å. –±—ç–∫–∞–ø–æ–≤:     ${GRAY}${MAX_BACKUPS_COUNT} —à—Ç.${RESET}"
        else
            echo -e " 20. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è:     ${GRAY}${RETENTION_DAYS} –¥–Ω–µ–π${RESET}"
        fi
        echo -e " 21. –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞:     ${GRAY}$(format_size_mb "$MAX_BACKUP_SIZE_MB")${RESET}"
        
        echo -e "\n 0. –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä: " s
        [[ -z "$s" ]] && return
        
        case $s in
            1) read -erp "–ù–æ–≤—ã–π –ø—É—Ç—å: " np
               if [[ -n "$np" ]]; then 
                   if [[ -d "$np" ]]; then BOT_PATH="$np"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
                   else print_message "ERROR" "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; fi
               fi ;;
            
            2) 
                scan_system_for_bot
                local def_cont="${FOUND_BOT:-$BOT_CONTAINER_NAME}"
                local prompt_msg="–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞"
                [[ -n "$FOUND_BOT" ]] && prompt_msg+=" (Enter = '$FOUND_BOT')"
                read -erp "$prompt_msg: " nc; nc="${nc:-$def_cont}"
                if [[ -n "$nc" ]]; then BOT_CONTAINER_NAME="$nc"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
                
            3) 
                scan_system_for_bot
                local def_db="${FOUND_DB:-$DB_CONTAINER_NAME}"
                local prompt_msg="–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î"
                [[ -n "$FOUND_DB" ]] && prompt_msg+=" (Enter = '$FOUND_DB')"
                read -erp "$prompt_msg: " ndb_c; ndb_c="${ndb_c:-$def_db}"
                if [[ -n "$ndb_c" ]]; then DB_CONTAINER_NAME="$ndb_c"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;

            4) read -erp "–ù–æ–≤—ã–π DB User: " ndb
               if [[ -n "$ndb" ]]; then DB_USER="$ndb"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
               
            5) read -erp "–ò—Å–∫–ª—é—á–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: uploads/cache): " ed
               if [[ -n "$ed" ]]; then 
                   EXCLUDE_DIRS="$ed"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
               else 
                   if [[ -n "$EXCLUDE_DIRS" ]]; then 
                       read -erp "–û—á–∏—Å—Ç–∏—Ç—å? (y/N): " clr
                       if [[ "$clr" =~ ^[Yy]$ ]]; then EXCLUDE_DIRS=""; save_config; fi
                   fi
               fi ;;
               
            6) read -erp "–ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ MB: " msize
               if [[ "$msize" =~ ^[0-9]+$ ]] && [ "$msize" -gt 0 ]; then 
                   MAX_FILE_SIZE_MB="$msize"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
               fi ;;
            
            7) read -erp "–ù–æ–≤—ã–π Token: " nt
               if [[ -n "$nt" ]]; then BOT_TOKEN="$nt"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
               
            8) echo -e "–¢–µ–∫—É—â–∏–π Chat ID: ${CYAN}${CHAT_ID}${RESET}"
               read -erp "–ù–æ–≤—ã–π Chat ID: " nid
               if [[ -n "$nid" ]]; then CHAT_ID="$nid"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; fi ;;
               
            9) read -erp "–ù–æ–≤—ã–π Thread ID (–ø—É—Å—Ç–æ - —Å–±—Ä–æ—Å–∏—Ç—å): " ntid
                TG_MESSAGE_THREAD_ID="$ntid"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" ;;
                
            10) # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                if [[ "$SEND_TO_TELEGRAM" == "true" ]]; then 
                    SEND_TO_TELEGRAM="false"
                    print_message "INFO" "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram –æ—Ç–∫–ª—é—á–µ–Ω—ã"
                else 
                    SEND_TO_TELEGRAM="true"
                    print_message "SUCCESS" "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram –≤–∫–ª—é—á–µ–Ω—ã"
                fi
                save_config ;;
                
            11) # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                if [[ "$TG_SEND_FILE" == "true" ]]; then
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                    if [[ "$REMOTE_STORAGE_TYPE" == "off" || "$SEND_TO_REMOTE" != "true" ]]; then
                        echo ""
                        print_message "WARN" "–£–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ!"
                        print_message "WARN" "–ë—ç–∫–∞–ø—ã –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–∏—Å–∫–µ."
                        read -erp "–í—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–∞–π–ª–∞ –≤ TG? (y/N): " confirm
                        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                            print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ"
                            sleep 1
                            continue
                        fi
                    fi
                    TG_SEND_FILE="false"
                    print_message "INFO" "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ TG –æ—Ç–∫–ª—é—á–µ–Ω–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã)"
                else
                    TG_SEND_FILE="true"
                    print_message "SUCCESS" "–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ TG –≤–∫–ª—é—á–µ–Ω–∞"
                fi
                save_config ;;
                
            12) test_telegram_connection ;;

            13|14|15|17) configure_remote_storage ;;
            
            16) # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                if [[ "$SEND_TO_REMOTE" == "true" ]]; then 
                    SEND_TO_REMOTE="false"
                    print_message "INFO" "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞"
                else 
                    if [[ "$REMOTE_STORAGE_TYPE" == "off" ]]; then
                        print_message "WARN" "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–ø—É–Ω–∫—Ç 17)"
                        sleep 1.5
                        continue
                    fi
                    SEND_TO_REMOTE="true"
                    print_message "SUCCESS" "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∫–ª—é—á–µ–Ω–∞"
                fi
                save_config ;;

            18) echo ""
                read -s -erp "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–ø—É—Å—Ç–æ - –æ—Ç–∫–ª—é—á–∏—Ç—å): " new_pass
                echo ""
                BACKUP_PASSWORD="$new_pass"
                save_config
                if [[ -n "$new_pass" ]]; then
                    print_message "SUCCESS" "–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
                else
                    print_message "INFO" "–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ"
                fi ;;
                
            19) echo ""
                echo "–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤:"
                echo " 1. –ü–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π)"
                echo " 2. –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–æ—Å—Ç–∞–≤–ª—è—Ç—å N –ø–æ—Å–ª–µ–¥–Ω–∏—Ö)"
                read -erp "–í—ã–±–æ—Ä (1/2): " dm
                if [[ "$dm" == "1" ]]; then DELETE_MODE="time"; elif [[ "$dm" == "2" ]]; then DELETE_MODE="count"; fi
                save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" ;;
                
            20) # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if [[ "$DELETE_MODE" == "count" ]]; then
                    read -erp "–ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—ç–∫–∞–ø–æ–≤: " nd
                    if [[ "$nd" =~ ^[0-9]+$ ]] && [ "$nd" -ge 1 ]; then 
                        MAX_BACKUPS_COUNT="$nd"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
                    else 
                        print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >= 1"
                    fi
                else
                    read -erp "–°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –¥–Ω—è—Ö: " ndays
                    if [[ "$ndays" =~ ^[0-9]+$ ]] && [ "$ndays" -ge 1 ]; then 
                        RETENTION_DAYS="$ndays"; save_config; print_message "SUCCESS" "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
                    else 
                        print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >= 1"
                    fi
                fi ;;
                
            21) # –õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –±—ç–∫–∞–ø–æ–≤
                echo ""
                echo "–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏ —Å –±—ç–∫–∞–ø–∞–º–∏ (–≤ MB)"
                echo "–í–≤–µ–¥–∏—Ç–µ 0 –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞"
                echo ""
                local current_mb="$MAX_BACKUP_SIZE_MB"
                echo -e "–¢–µ–∫—É—â–∏–π –ª–∏–º–∏—Ç: ${CYAN}$(format_size_mb "$current_mb")${RESET}"
                read -erp "–ù–æ–≤—ã–π –ª–∏–º–∏—Ç (MB): " new_limit
                if [[ "$new_limit" =~ ^[0-9]+$ ]]; then 
                    MAX_BACKUP_SIZE_MB="$new_limit"
                    save_config
                    if [[ "$new_limit" == "0" ]]; then
                        print_message "INFO" "–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç–∫–ª—é—á—ë–Ω"
                    else
                        print_message "SUCCESS" "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏–º–∏—Ç: $(format_size_mb "$new_limit")"
                    fi
                else 
                    print_message "ERROR" "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (0 –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è)"
                fi ;;
            
            0) return ;;
        esac
        [[ -n "$s" ]] && sleep 0.5
    done
}

# =============================================================================
# –ú–ò–ì–†–ê–¶–ò–Ø –ú–ï–ñ–î–£ –ë–û–¢–ê–ú–ò (Bedolaga ‚Üí RWP-Shop (Private))
# =============================================================================

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏
MIGRATION_SOURCE_HOST=""
MIGRATION_SOURCE_PORT="5432"
MIGRATION_SOURCE_DB=""
MIGRATION_SOURCE_USER=""
MIGRATION_SOURCE_PASS=""
MIGRATION_TARGET_CONTAINER=""
MIGRATION_TARGET_DB=""
MIGRATION_TARGET_USER=""
MIGRATION_WORK_DIR=""

# –ú–∞–ø–ø–∏–Ω–≥ payment_method (Bedolaga) ‚Üí invoice_type (RWP-Shop)
# 
# Bedolaga –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: telegram_stars, tribute, yookassa, cryptobot, 
#                        heleket, mulenpay, pal24, wata, platega, cloudpayments, manual
#
# RWP-Shop –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: yookassa, crypto, telegram, severpay_cards, 
#                               severpay_sbp, wata, platega, stripe
#
# ‚ö†Ô∏è –ú–µ—Ç–æ–¥—ã –±–µ–∑ –∞–Ω–∞–ª–æ–≥–∞ –≤ Remnawave: tribute, heleket, mulenpay, pal24, cloudpayments
#    –û–Ω–∏ –±—É–¥—É—Ç –∑–∞–º–∞–ø–ø–µ–Ω—ã –Ω–∞ "unknown" –∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
declare -A PAYMENT_METHOD_MAP=(
    # –ü—Ä—è–º—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–ø—É–±–ª–∏—á–Ω–∞—è + –ø—Ä–∏–≤–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    ["yookassa"]="yookassa"
    ["tribute"]="tribute"
    ["wata"]="wata"
    
    # –¢—Ä–µ–±—É—é—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
    ["telegram_stars"]="telegram"
    ["cryptobot"]="crypto"
    
    # Platega –≤ Bedolaga ‚Üí platega_cards –≤ Remnawave (–ø—Ä–∏–≤–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è)
    # –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: platega_cards, platega_sbp, platega_crypto, platega_acquiring, platega_worldwide
    ["platega"]="platega_cards"
    
    # –ù–µ—Ç –∞–Ω–∞–ª–æ–≥–∞ –≤ RWP-Shop - –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ unknown
    ["manual"]="unknown"
    ["heleket"]="unknown"
    ["mulenpay"]="unknown"
    ["pal24"]="unknown"
    ["cloudpayments"]="unknown"
)

# --- –§—É–Ω–∫—Ü–∏—è: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ---
migrate_analyze_source() {
    debug_log "MIGRATE" "Starting source analysis"
    print_message "INFO" "–ê–Ω–∞–ª–∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞..."
    
    local source_info=""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ Docker (–µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
    if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
        debug_log "MIGRATE" "Using Docker container: $MIGRATION_SOURCE_CONTAINER"
        source_info=$(docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -c "
            SELECT 'tables:' || count(*) FROM information_schema.tables WHERE table_schema='public';
        " 2>&1)
    else
        debug_log "MIGRATE" "Using direct connection: $MIGRATION_SOURCE_HOST:$MIGRATION_SOURCE_PORT"
        export PGPASSWORD="$MIGRATION_SOURCE_PASS"
        source_info=$(psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -c "
            SELECT 'tables:' || count(*) FROM information_schema.tables WHERE table_schema='public';
        " 2>&1)
        unset PGPASSWORD
    fi
    
    if [[ $? -ne 0 ]]; then
        print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –∏—Å—Ç–æ—á–Ω–∏–∫–∞"
        debug_log "MIGRATE" "Connection failed: $source_info"
        return 1
    fi
    
    echo "$source_info"
    debug_log "MIGRATE" "Source info: $source_info"
}

# --- –§—É–Ω–∫—Ü–∏—è: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ---
migrate_check_compatibility() {
    debug_log "MIGRATE" "Checking source compatibility"
    print_message "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞..."
    
    local required_tables=("users" "transactions" "promocodes")
    local missing_tables=()
    
    for table in "${required_tables[@]}"; do
        local exists=""
        if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
            exists=$(docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -c "
                SELECT 1 FROM information_schema.tables WHERE table_schema='public' AND table_name='$table' LIMIT 1;
            " 2>/dev/null | tr -d ' ')
        else
            export PGPASSWORD="$MIGRATION_SOURCE_PASS"
            exists=$(psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -c "
                SELECT 1 FROM information_schema.tables WHERE table_schema='public' AND table_name='$table' LIMIT 1;
            " 2>/dev/null | tr -d ' ')
            unset PGPASSWORD
        fi
        
        if [[ "$exists" != "1" ]]; then
            missing_tables+=("$table")
        fi
    done
    
    if [[ ${#missing_tables[@]} -gt 0 ]]; then
        print_message "ERROR" "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: ${missing_tables[*]}"
        debug_log "MIGRATE" "Missing tables: ${missing_tables[*]}"
        return 1
    fi
    
    print_message "SUCCESS" "–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–≤–º–µ—Å—Ç–∏–º (Bedolaga format)"
    return 0
}

# --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–∞ ---
BALANCE_HANDLING_MODE=""      # ignore, export_csv, convert_days, convert_partner
BALANCE_CONVERSION_PRICE=""   # –°—Ç–æ–∏–º–æ—Å—Ç—å –º–µ—Å—è—Ü–∞ –≤ —Ä—É–±–ª—è—Ö (–¥–ª—è convert_days)
BALANCE_CONVERSION_DAYS=""    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ (–¥–ª—è convert_days)

# --- –§—É–Ω–∫—Ü–∏—è: –ê–Ω–∞–ª–∏–∑ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
migrate_handle_balances() {
    debug_log "MIGRATE" "Analyzing user balances"
    print_message "INFO" "–ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
    
    local export_dir="$MIGRATION_WORK_DIR/export"
    local balances_file="$export_dir/user_balances.csv"
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ–Ω—É–ª–µ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º
    local balance_query="
        SELECT telegram_id, username, first_name, balance_kopeks, 
               ROUND(balance_kopeks::numeric / 100, 2) as balance_rubles
        FROM users 
        WHERE balance_kopeks > 0 
        ORDER BY balance_kopeks DESC;
    "
    
    local balance_data=""
    if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
        balance_data=$(docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -A -F',' -c "$balance_query" 2>/dev/null)
    else
        export PGPASSWORD="$MIGRATION_SOURCE_PASS"
        balance_data=$(psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -A -F',' -c "$balance_query" 2>/dev/null)
        unset PGPASSWORD
    fi
    
    if [[ -z "$balance_data" ]]; then
        print_message "SUCCESS" "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–∞–ª–∞–Ω—Å–æ–º > 0 –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        BALANCE_HANDLING_MODE="none"
        return 0
    fi
    
    # –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    local users_with_balance=0
    local total_balance_kopeks=0
    
    while IFS=',' read -r tg_id username fname balance_kop balance_rub; do
        [[ -z "$tg_id" ]] && continue
        ((users_with_balance++))
        total_balance_kopeks=$((total_balance_kopeks + balance_kop))
    done <<< "$balance_data"
    
    local total_balance_rubles=$(echo "scale=2; $total_balance_kopeks / 100" | bc 2>/dev/null || echo "0")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª
    echo "telegram_id,username,first_name,balance_kopeks,balance_rubles" > "$balances_file"
    echo "$balance_data" >> "$balances_file"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    echo ""
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${RED}${BOLD}  ‚ö†Ô∏è  –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –° –ù–ï–ù–£–õ–ï–í–´–ú –ë–ê–õ–ê–ù–°–û–ú!          ${RESET}"
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo -e "  ${YELLOW}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–∞–ª–∞–Ω—Å–æ–º > 0:${RESET} ${WHITE}${BOLD}$users_with_balance${RESET}"
    echo -e "  ${YELLOW}–û–±—â–∞—è —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤:${RESET}        ${WHITE}${BOLD}$total_balance_rubles ‚ÇΩ${RESET}"
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    echo -e "${CYAN}  –¢–æ–ø-5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –±–∞–ª–∞–Ω—Å—É:${RESET}"
    local count=0
    while IFS=',' read -r tg_id username fname balance_kop balance_rub; do
        [[ -z "$tg_id" ]] && continue
        ((count++))
        [[ $count -gt 5 ]] && break
        local display_name="${username:-${fname:-ID:$tg_id}}"
        printf "    %d. %-20s %10s ‚ÇΩ\n" "$count" "$display_name" "$balance_rub"
    done <<< "$balance_data"
    echo ""
    
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${YELLOW}  –í RWP-Shop –ù–ï–¢ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!${RESET}"
    echo -e "${YELLOW}  –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ:${RESET}"
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo -e "  ${GREEN}1.${RESET} –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    echo "     ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤ —Ñ–∞–π–ª –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏"
    echo "     ‚Üí –í—ã —Å–º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏ –∏–ª–∏ –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –≤—Ä—É—á–Ω—É—é"
    echo ""
    echo -e "  ${GREEN}2.${RESET} –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –¥–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
    echo "     ‚Üí –ë–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –≤ –¥–Ω–∏ –ø–æ –≤–∞—à–µ–º—É —Ç–∞—Ä–∏—Ñ—É"
    echo "     ‚Üí –î–Ω–∏ –¥–æ–±–∞–≤—è—Ç—Å—è –∫ expire_at –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    echo ""
    echo -e "  ${GREEN}3.${RESET} –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –±–∞–ª–∞–Ω—Å"
    echo "     ‚Üí –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∞—Ä—Ç–Ω—ë—Ä ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ available_balance"
    echo "     ‚Üí –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV"
    echo ""
    echo -e "  ${RED}4.${RESET} –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (–ü–û–¢–ï–†–Ø –î–ê–ù–ù–´–•!)"
    echo "     ‚Üí –ë–∞–ª–∞–Ω—Å—ã –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ"
    echo ""
    
    while true; do
        read -erp "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç [1-4]: " choice
        case "$choice" in
            1)
                BALANCE_HANDLING_MODE="export_csv"
                print_message "INFO" "–ë–∞–ª–∞–Ω—Å—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $balances_file"
                break
                ;;
            2)
                echo ""
                echo -e "${CYAN}=== –ù–ê–°–¢–†–û–ô–ö–ê –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò –ë–ê–õ–ê–ù–°–ê –í –î–ù–ò ===${RESET}"
                echo ""
                echo "–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∞—à–µ–≥–æ —Ç–∞—Ä–∏—Ñ–∞:"
                echo ""
                
                # –°—Ç–æ–∏–º–æ—Å—Ç—å –º–µ—Å—è—Ü–∞
                read -erp "–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –º–µ—Å—è—Ü–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Ä—É–±–ª—è—Ö [100]: " month_price
                month_price="${month_price:-100}"
                
                # –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–∞
                if ! [[ "$month_price" =~ ^[0-9]+([.][0-9]+)?$ ]] || [[ $(echo "$month_price <= 0" | bc) -eq 1 ]]; then
                    print_message "ERROR" "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 100‚ÇΩ"
                    month_price="100"
                fi
                
                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
                read -erp "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ 1 –º–µ—Å—è—Ü–µ –ø–æ–¥–ø–∏—Å–∫–∏ [30]: " days_per_month
                days_per_month="${days_per_month:-30}"
                
                # –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–∞
                if ! [[ "$days_per_month" =~ ^[0-9]+$ ]] || [[ "$days_per_month" -le 0 ]]; then
                    print_message "ERROR" "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 30"
                    days_per_month="30"
                fi
                
                BALANCE_CONVERSION_PRICE="$month_price"
                BALANCE_CONVERSION_DAYS="$days_per_month"
                BALANCE_HANDLING_MODE="convert_days"
                
                echo ""
                echo -e "${CYAN}–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞:${RESET}"
                echo "  extra_days = (balance_rubles / $month_price) √ó $days_per_month"
                echo ""
                
                # –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞
                local example_balance="150"
                local example_days=$(echo "scale=0; ($example_balance / $month_price) * $days_per_month" | bc 2>/dev/null || echo "?")
                echo -e "  ${YELLOW}–ü—Ä–∏–º–µ—Ä:${RESET} –±–∞–ª–∞–Ω—Å 150‚ÇΩ ‚Üí $example_days –¥–Ω–µ–π"
                echo ""
                
                print_message "SUCCESS" "–ö—É—Ä—Å: $month_price ‚ÇΩ = $days_per_month –¥–Ω–µ–π"
                break
                ;;
            3)
                BALANCE_HANDLING_MODE="convert_partner"
                print_message "INFO" "–ë–∞–ª–∞–Ω—Å—ã –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ ‚Üí partner.available_balance"
                break
                ;;
            4)
                echo ""
                echo -e "${RED}${BOLD}  ‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –í–´ –ü–û–¢–ï–†–Ø–ï–¢–ï $total_balance_rubles ‚ÇΩ!${RESET}"
                echo ""
                read -erp "–í–≤–µ–¥–∏—Ç–µ 'LOSE DATA' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm
                if [[ "$confirm" == "LOSE DATA" ]]; then
                    BALANCE_HANDLING_MODE="ignore"
                    print_message "WARN" "–ë–∞–ª–∞–Ω—Å—ã –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö)"
                    # –í—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                    print_message "INFO" "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±–∞–ª–∞–Ω—Å–æ–≤: $balances_file"
                    break
                else
                    print_message "INFO" "–û—Ç–º–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç."
                fi
                ;;
            *)
                print_message "ERROR" "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                ;;
        esac
    done
    
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤ ---
migrate_apply_balance_handling() {
    debug_log "MIGRATE" "Applying balance handling: $BALANCE_HANDLING_MODE"
    
    local export_dir="$MIGRATION_WORK_DIR/export"
    local import_dir="$MIGRATION_WORK_DIR/import"
    local balances_file="$export_dir/user_balances.csv"
    local balance_report="$MIGRATION_WORK_DIR/balance_report.txt"
    
    case "$BALANCE_HANDLING_MODE" in
        "none")
            debug_log "MIGRATE" "No balances to process"
            return 0
            ;;
        "export_csv")
            # –£–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ migrate_handle_balances
            print_message "SUCCESS" "–ë–∞–ª–∞–Ω—Å—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤: $balances_file"
            
            # –°–æ–∑–¥–∞—ë–º –æ—Ç—á—ë—Ç
            {
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "  –û–¢–ß–Å–¢ –û –ë–ê–õ–ê–ù–°–ê–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô"
                echo "  –î–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: $(date '+%Y-%m-%d %H:%M:%S')"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "–§–∞–π–ª —Å –±–∞–ª–∞–Ω—Å–∞–º–∏: $balances_file"
                echo ""
                echo "–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
                echo "1. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤"
                echo "2. –ò–ª–∏ –ø—Ä–æ–¥–ª–∏—Ç–µ –∏–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–π —Å—Ä–æ–∫"
                echo "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Remnawave –¥–ª—è —Ä—É—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π"
                echo ""
                echo "–°–ü–ò–°–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:"
                cat "$balances_file"
            } > "$balance_report"
            
            print_message "INFO" "–û—Ç—á—ë—Ç —Å–æ–∑–¥–∞–Ω: $balance_report"
            ;;
            
        "convert_days")
            print_message "INFO" "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –≤ –¥–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏..."
            
            # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Å –¥–æ–ø. –¥–Ω—è–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            local days_file="$import_dir/balance_to_days.csv"
            echo "telegram_id,extra_days,balance_rubles,month_price,days_per_month" > "$days_file"
            
            local month_price="${BALANCE_CONVERSION_PRICE:-100}"
            local days_per_month="${BALANCE_CONVERSION_DAYS:-30}"
            
            tail -n +2 "$balances_file" | while IFS=',' read -r tg_id username fname balance_kop balance_rub; do
                [[ -z "$tg_id" ]] && continue
                # –†–∞—Å—á—ë—Ç –¥–Ω–µ–π: (balance_rub / month_price) * days_per_month
                local extra_days=$(echo "scale=0; ($balance_rub / $month_price) * $days_per_month" | bc 2>/dev/null || echo "0")
                [[ "$extra_days" -lt 1 ]] && extra_days=0
                echo "$tg_id,$extra_days,$balance_rub,$month_price,$days_per_month" >> "$days_file"
            done
            
            print_message "SUCCESS" "–§–∞–π–ª –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω: $days_file"
            
            # –û—Ç—á—ë—Ç
            {
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "  –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ë–ê–õ–ê–ù–°–û–í –í –î–ù–ò –ü–û–î–ü–ò–°–ö–ò"
                echo "  –¢–∞—Ä–∏—Ñ: $month_price ‚ÇΩ = $days_per_month –¥–Ω–µ–π"
                echo "  –§–æ—Ä–º—É–ª–∞: extra_days = (balance / $month_price) √ó $days_per_month"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "telegram_id,extra_days,balance_rubles"
                tail -n +2 "$days_file" | cut -d',' -f1-3
            } > "$balance_report"
            ;;
            
        "convert_partner")
            print_message "INFO" "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –≤ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–µ..."
            
            # –§–∞–π–ª—ã –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ –Ω–µ-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤
            local partner_file="$import_dir/balance_to_partner.csv"
            local non_partner_file="$export_dir/non_partner_balances.csv"
            
            echo "telegram_id,balance_rubles" > "$partner_file"
            echo "telegram_id,username,first_name,balance_rubles" > "$non_partner_file"
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ (users —Å referral_commission_percent > 0)
            local partners_query="SELECT telegram_id FROM users WHERE referral_commission_percent > 0;"
            local partners_list=""
            
            if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
                partners_list=$(docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -A -c "$partners_query" 2>/dev/null)
            else
                export PGPASSWORD="$MIGRATION_SOURCE_PASS"
                partners_list=$(psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -t -A -c "$partners_query" 2>/dev/null)
                unset PGPASSWORD
            fi
            
            tail -n +2 "$balances_file" | while IFS=',' read -r tg_id username fname balance_kop balance_rub; do
                [[ -z "$tg_id" ]] && continue
                if echo "$partners_list" | grep -q "^${tg_id}$"; then
                    echo "$tg_id,$balance_rub" >> "$partner_file"
                else
                    echo "$tg_id,$username,$fname,$balance_rub" >> "$non_partner_file"
                fi
            done
            
            local partner_count=$(($(wc -l < "$partner_file") - 1))
            local non_partner_count=$(($(wc -l < "$non_partner_file") - 1))
            
            print_message "SUCCESS" "–ü–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å –±–∞–ª–∞–Ω—Å–æ–º: $partner_count ‚Üí partner.available_balance"
            [[ $non_partner_count -gt 0 ]] && print_message "WARN" "–ù–µ-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —Å –±–∞–ª–∞–Ω—Å–æ–º: $non_partner_count ‚Üí —ç–∫—Å–ø–æ—Ä—Ç –≤ CSV"
            
            # –û—Ç—á—ë—Ç
            {
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "  –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ë–ê–õ–ê–ù–°–û–í –í –ü–ê–†–¢–ù–Å–†–°–ö–ò–ï"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "–ü–ê–†–¢–ù–Å–†–´ (–±–∞–ª–∞–Ω—Å ‚Üí partner.available_balance):"
                cat "$partner_file"
                echo ""
                echo "–ù–ï-–ü–ê–†–¢–ù–Å–†–´ (—Ç—Ä–µ–±—É—é—Ç —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏):"
                cat "$non_partner_file"
            } > "$balance_report"
            ;;
            
        "ignore")
            print_message "WARN" "–ë–∞–ª–∞–Ω—Å—ã –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã!"
            
            {
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo "  ‚ö†Ô∏è  –ë–ê–õ–ê–ù–°–´ –ë–´–õ–ò –ü–†–û–ò–ì–ù–û–†–ò–†–û–í–ê–ù–´ (–ü–û–¢–ï–†–Ø –î–ê–ù–ù–´–•)"
                echo "  –î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
                echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                echo ""
                echo "–†–ï–ó–ï–†–í–ù–ê–Ø –ö–û–ü–ò–Ø –ü–û–¢–ï–†–Ø–ù–ù–´–• –ë–ê–õ–ê–ù–°–û–í:"
                cat "$balances_file"
            } > "$balance_report"
            ;;
    esac
    
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ---
migrate_export_data() {
    debug_log "MIGRATE" "Starting data export"
    print_message "INFO" "–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Bedolaga..."
    
    local export_dir="$MIGRATION_WORK_DIR/export"
    mkdir -p "$export_dir"
    
    local export_sql="
-- Export users
COPY (
    SELECT 
        telegram_id,
        tg_username,
        tg_first_name,
        language,
        created_at,
        balance,
        referral_balance,
        referrer_id
    FROM users
    ORDER BY telegram_id
) TO STDOUT WITH CSV HEADER;
"
    
    local users_file="$export_dir/users.csv"
    local transactions_file="$export_dir/transactions.csv"
    local promocodes_file="$export_dir/promocodes.csv"
    local promo_uses_file="$export_dir/promocode_uses.csv"
    
    # –≠–∫—Å–ø–æ—Ä—Ç users
    if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
        docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT telegram_id, tg_username, tg_first_name, language, created_at, balance, referral_balance, referrer_id FROM users ORDER BY telegram_id) TO STDOUT WITH CSV HEADER;
        " > "$users_file" 2>/dev/null
    else
        export PGPASSWORD="$MIGRATION_SOURCE_PASS"
        psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT telegram_id, tg_username, tg_first_name, language, created_at, balance, referral_balance, referrer_id FROM users ORDER BY telegram_id) TO STDOUT WITH CSV HEADER;
        " > "$users_file" 2>/dev/null
        unset PGPASSWORD
    fi
    
    if [[ ! -s "$users_file" ]]; then
        print_message "ERROR" "–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        return 1
    fi
    
    local user_count=$(wc -l < "$users_file")
    user_count=$((user_count - 1))  # –ú–∏–Ω—É—Å –∑–∞–≥–æ–ª–æ–≤–æ–∫
    print_message "SUCCESS" "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $user_count"
    
    # –≠–∫—Å–ø–æ—Ä—Ç transactions
    if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
        docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT id, user_id, amount, payment_method, status, created_at, subscription_days FROM transactions WHERE status='completed' ORDER BY id) TO STDOUT WITH CSV HEADER;
        " > "$transactions_file" 2>/dev/null
    else
        export PGPASSWORD="$MIGRATION_SOURCE_PASS"
        psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT id, user_id, amount, payment_method, status, created_at, subscription_days FROM transactions WHERE status='completed' ORDER BY id) TO STDOUT WITH CSV HEADER;
        " > "$transactions_file" 2>/dev/null
        unset PGPASSWORD
    fi
    
    local tx_count=0
    [[ -s "$transactions_file" ]] && tx_count=$(($(wc -l < "$transactions_file") - 1))
    print_message "SUCCESS" "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: $tx_count"
    
    # –≠–∫—Å–ø–æ—Ä—Ç promocodes
    if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
        docker exec "$MIGRATION_SOURCE_CONTAINER" psql -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT code, bonus_days, max_uses, current_uses, is_active, created_at FROM promocodes ORDER BY code) TO STDOUT WITH CSV HEADER;
        " > "$promocodes_file" 2>/dev/null
    else
        export PGPASSWORD="$MIGRATION_SOURCE_PASS"
        psql -h "$MIGRATION_SOURCE_HOST" -p "$MIGRATION_SOURCE_PORT" -U "$MIGRATION_SOURCE_USER" -d "$MIGRATION_SOURCE_DB" -c "
            COPY (SELECT code, bonus_days, max_uses, current_uses, is_active, created_at FROM promocodes ORDER BY code) TO STDOUT WITH CSV HEADER;
        " > "$promocodes_file" 2>/dev/null
        unset PGPASSWORD
    fi
    
    local promo_count=0
    [[ -s "$promocodes_file" ]] && promo_count=$(($(wc -l < "$promocodes_file") - 1))
    print_message "SUCCESS" "–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: $promo_count"
    
    debug_log "MIGRATE" "Export complete: users=$user_count, tx=$tx_count, promo=$promo_count"
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ---
migrate_transform_data() {
    debug_log "MIGRATE" "Starting data transformation"
    print_message "INFO" "–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Remnawave..."
    
    local export_dir="$MIGRATION_WORK_DIR/export"
    local import_dir="$MIGRATION_WORK_DIR/import"
    mkdir -p "$import_dir"
    
    # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è users ‚Üí customer
    if [[ -f "$export_dir/users.csv" ]]; then
        print_message "INFO" "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è users ‚Üí customer..."
        
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        tail -n +2 "$export_dir/users.csv" | while IFS=',' read -r telegram_id tg_username tg_first_name language created_at balance referral_balance referrer_id; do
            # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è balance –∏–∑ –∫–æ–ø–µ–µ–∫ –≤ —Ä—É–±–ª–∏
            local balance_rub=0
            if [[ -n "$balance" && "$balance" != "0" ]]; then
                balance_rub=$(echo "scale=2; $balance / 100" | bc 2>/dev/null || echo "0")
            fi
            
            local referral_rub=0
            if [[ -n "$referral_balance" && "$referral_balance" != "0" ]]; then
                referral_rub=$(echo "scale=2; $referral_balance / 100" | bc 2>/dev/null || echo "0")
            fi
            
            # –Ø–∑—ã–∫: ru/en (Bedolaga) ‚Üí ru/en (Remnawave)
            local lang="${language:-ru}"
            [[ "$lang" != "ru" && "$lang" != "en" ]] && lang="ru"
            
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UUID
            local uuid=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "$(date +%s)-$telegram_id")
            
            echo "$uuid,$telegram_id,$tg_username,$tg_first_name,,$lang,$balance_rub,$referral_rub,0,$created_at,$created_at"
        done > "$import_dir/customer.csv"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        sed -i '1i id,telegram_id,username,first_name,last_name,language,balance,referral_balance,lead_score,created_at,updated_at' "$import_dir/customer.csv" 2>/dev/null || \
        { echo "id,telegram_id,username,first_name,last_name,language,balance,referral_balance,lead_score,created_at,updated_at"; cat "$import_dir/customer.csv"; } > "$import_dir/customer.csv.tmp" && mv "$import_dir/customer.csv.tmp" "$import_dir/customer.csv"
        
        print_message "SUCCESS" "customer.csv —Å–æ–∑–¥–∞–Ω"
    fi
    
    # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è transactions ‚Üí purchase
    if [[ -f "$export_dir/transactions.csv" ]]; then
        print_message "INFO" "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è transactions ‚Üí purchase..."
        
        tail -n +2 "$export_dir/transactions.csv" | while IFS=',' read -r id user_id amount payment_method status created_at subscription_days; do
            # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è amount –∏–∑ –∫–æ–ø–µ–µ–∫ –≤ —Ä—É–±–ª–∏
            local amount_rub=0
            if [[ -n "$amount" && "$amount" != "0" ]]; then
                amount_rub=$(echo "scale=2; $amount / 100" | bc 2>/dev/null || echo "0")
            fi
            
            # –ú–∞–ø–ø–∏–Ω–≥ payment_method ‚Üí invoice_type
            local invoice_type="${PAYMENT_METHOD_MAP[$payment_method]:-admin}"
            
            # UUID
            local uuid=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "$(date +%s)-$id")
            
            echo "$uuid,$user_id,$amount_rub,$invoice_type,completed,$subscription_days,$created_at,$created_at"
        done > "$import_dir/purchase.csv"
        
        sed -i '1i id,customer_telegram_id,amount,invoice_type,status,subscription_days,created_at,updated_at' "$import_dir/purchase.csv" 2>/dev/null || \
        { echo "id,customer_telegram_id,amount,invoice_type,status,subscription_days,created_at,updated_at"; cat "$import_dir/purchase.csv"; } > "$import_dir/purchase.csv.tmp" && mv "$import_dir/purchase.csv.tmp" "$import_dir/purchase.csv"
        
        print_message "SUCCESS" "purchase.csv —Å–æ–∑–¥–∞–Ω"
    fi
    
    # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è promocodes ‚Üí promo
    if [[ -f "$export_dir/promocodes.csv" ]]; then
        print_message "INFO" "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è promocodes ‚Üí promo..."
        
        tail -n +2 "$export_dir/promocodes.csv" | while IFS=',' read -r code bonus_days max_uses current_uses is_active created_at; do
            local uuid=$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "$(date +%s)-$code")
            
            # promo_type: subscription (–¥–∞—ë—Ç –¥–Ω–∏)
            local promo_type="subscription"
            [[ "$bonus_days" == "0" || -z "$bonus_days" ]] && promo_type="balance"
            
            # active: is_active (bool)
            local active="true"
            [[ "$is_active" == "false" || "$is_active" == "0" || "$is_active" == "f" ]] && active="false"
            
            echo "$uuid,$code,$promo_type,$bonus_days,0,$max_uses,${current_uses:-0},$active,$created_at,$created_at"
        done > "$import_dir/promo.csv"
        
        sed -i '1i id,code,promo_type,subscription_days,balance_bonus,max_uses,uses,active,created_at,updated_at' "$import_dir/promo.csv" 2>/dev/null || \
        { echo "id,code,promo_type,subscription_days,balance_bonus,max_uses,uses,active,created_at,updated_at"; cat "$import_dir/promo.csv"; } > "$import_dir/promo.csv.tmp" && mv "$import_dir/promo.csv.tmp" "$import_dir/promo.csv"
        
        print_message "SUCCESS" "promo.csv —Å–æ–∑–¥–∞–Ω"
    fi
    
    debug_log "MIGRATE" "Transformation complete"
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Remnawave ---
migrate_import_data() {
    debug_log "MIGRATE" "Starting data import to Remnawave"
    print_message "INFO" "–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ RWP-Shop..."
    
    local import_dir="$MIGRATION_WORK_DIR/import"
    
    if [[ -z "$MIGRATION_TARGET_CONTAINER" ]]; then
        print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î Remnawave –Ω–µ —É–∫–∞–∑–∞–Ω"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
    if ! docker ps --format '{{.Names}}' | grep -q "^${MIGRATION_TARGET_CONTAINER}$"; then
        print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $MIGRATION_TARGET_CONTAINER –Ω–µ –∑–∞–ø—É—â–µ–Ω"
        return 1
    fi
    
    # –ò–º–ø–æ—Ä—Ç customer
    if [[ -f "$import_dir/customer.csv" ]]; then
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç customer..."
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        docker cp "$import_dir/customer.csv" "${MIGRATION_TARGET_CONTAINER}:/tmp/customer.csv"
        
        # –ò–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ COPY
        docker exec "$MIGRATION_TARGET_CONTAINER" psql -U "$MIGRATION_TARGET_USER" -d "$MIGRATION_TARGET_DB" -c "
            CREATE TEMP TABLE tmp_customer (LIKE customer INCLUDING ALL);
            COPY tmp_customer FROM '/tmp/customer.csv' WITH CSV HEADER;
            INSERT INTO customer SELECT * FROM tmp_customer
            ON CONFLICT (telegram_id) DO UPDATE SET
                username = EXCLUDED.username,
                first_name = EXCLUDED.first_name,
                balance = customer.balance + EXCLUDED.balance,
                referral_balance = customer.referral_balance + EXCLUDED.referral_balance,
                updated_at = NOW();
            DROP TABLE tmp_customer;
        " 2>&1
        
        local result=$?
        docker exec "$MIGRATION_TARGET_CONTAINER" rm -f /tmp/customer.csv
        
        if [[ $result -ne 0 ]]; then
            print_message "WARN" "–ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç customer (–≤–æ–∑–º–æ–∂–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã)"
        else
            print_message "SUCCESS" "customer –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω"
        fi
    fi
    
    # –ò–º–ø–æ—Ä—Ç purchase
    if [[ -f "$import_dir/purchase.csv" ]]; then
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç purchase..."
        
        docker cp "$import_dir/purchase.csv" "${MIGRATION_TARGET_CONTAINER}:/tmp/purchase.csv"
        
        docker exec "$MIGRATION_TARGET_CONTAINER" psql -U "$MIGRATION_TARGET_USER" -d "$MIGRATION_TARGET_DB" -c "
            COPY purchase(id, customer_telegram_id, amount, invoice_type, status, subscription_days, created_at, updated_at)
            FROM '/tmp/purchase.csv' WITH CSV HEADER;
        " 2>&1
        
        docker exec "$MIGRATION_TARGET_CONTAINER" rm -f /tmp/purchase.csv
        print_message "SUCCESS" "purchase –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω"
    fi
    
    # –ò–º–ø–æ—Ä—Ç promo
    if [[ -f "$import_dir/promo.csv" ]]; then
        print_message "INFO" "–ò–º–ø–æ—Ä—Ç promo..."
        
        docker cp "$import_dir/promo.csv" "${MIGRATION_TARGET_CONTAINER}:/tmp/promo.csv"
        
        docker exec "$MIGRATION_TARGET_CONTAINER" psql -U "$MIGRATION_TARGET_USER" -d "$MIGRATION_TARGET_DB" -c "
            CREATE TEMP TABLE tmp_promo (LIKE promo INCLUDING ALL);
            COPY tmp_promo FROM '/tmp/promo.csv' WITH CSV HEADER;
            INSERT INTO promo SELECT * FROM tmp_promo
            ON CONFLICT (code) DO UPDATE SET
                uses = promo.uses + EXCLUDED.uses,
                active = EXCLUDED.active,
                updated_at = NOW();
            DROP TABLE tmp_promo;
        " 2>&1
        
        docker exec "$MIGRATION_TARGET_CONTAINER" rm -f /tmp/promo.csv
        print_message "SUCCESS" "promo –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω"
    fi
    
    debug_log "MIGRATE" "Import complete"
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ ---
migrate_generate_report() {
    print_message "INFO" "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏..."
    
    local report_file="$MIGRATION_WORK_DIR/migration_report_$(date +%Y%m%d_%H%M%S).txt"
    
    {
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë           LAZARUS Migration Report                             ‚ïë"
        echo "‚ïë           Bedolaga ‚Üí RWP-Shop (Private)                    ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "=== SOURCE (Bedolaga) ==="
        if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
            echo "Container: $MIGRATION_SOURCE_CONTAINER"
        else
            echo "Host: $MIGRATION_SOURCE_HOST:$MIGRATION_SOURCE_PORT"
        fi
        echo "Database: $MIGRATION_SOURCE_DB"
        echo ""
        echo "=== TARGET (RWP-Shop) ==="
        echo "Container: $MIGRATION_TARGET_CONTAINER"
        echo "Database: $MIGRATION_TARGET_DB"
        echo ""
        echo "=== MIGRATION STATS ==="
        
        local export_dir="$MIGRATION_WORK_DIR/export"
        local import_dir="$MIGRATION_WORK_DIR/import"
        
        if [[ -f "$export_dir/users.csv" ]]; then
            local users_count=$(($(wc -l < "$export_dir/users.csv") - 1))
            echo "Users exported: $users_count"
        fi
        
        if [[ -f "$export_dir/transactions.csv" ]]; then
            local tx_count=$(($(wc -l < "$export_dir/transactions.csv") - 1))
            echo "Transactions exported: $tx_count"
        fi
        
        if [[ -f "$export_dir/promocodes.csv" ]]; then
            local promo_count=$(($(wc -l < "$export_dir/promocodes.csv") - 1))
            echo "Promocodes exported: $promo_count"
        fi
        
        echo ""
        echo "=== FILES CREATED ==="
        ls -la "$import_dir"/*.csv 2>/dev/null || echo "No import files"
        echo ""
        echo "Migration completed at: $(date '+%Y-%m-%d %H:%M:%S')"
    } > "$report_file"
    
    print_message "SUCCESS" "–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: $report_file"
    cat "$report_file"
}

# =============================================================================
# –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö (Settings Migration)
# =============================================================================

# –ü—É—Ç–∏ –∫ .env —Ñ–∞–π–ª–∞–º
MIGRATION_SOURCE_ENV_FILE=""     # –ü—É—Ç—å –∫ .env Bedolaga
MIGRATION_TARGET_ENV_FILE=""     # –ü—É—Ç—å –∫ .env RWP-Shop
MIGRATION_TARGET_BOT_PATH=""     # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ RWP-Shop –±–æ—Ç–∞

# –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫: Bedolaga .env ‚Üí RWP-Shop .env (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
declare -A SETTINGS_ENV_TO_ENV=(
    # Telegram
    ["BOT_TOKEN"]="TELEGRAM_TOKEN"
    ["ADMIN_ID"]="ADMIN_TELEGRAM_ID"
    # Database  
    ["DATABASE_URL"]="DATABASE_URL"
    ["POSTGRES_USER"]="POSTGRES_USER"
    ["POSTGRES_PASSWORD"]="POSTGRES_PASSWORD"
    ["POSTGRES_DB"]="POSTGRES_DB"
    # Remnawave API
    ["REMNAWAVE_BASE_URL"]="REMNAWAVE_URL"
    ["REMNAWAVE_API_KEY"]="REMNAWAVE_TOKEN"
)

# –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫: Bedolaga .env ‚Üí RWP-Shop settings DB
declare -A SETTINGS_ENV_TO_DB=(
    # === YooKassa ===
    ["YOOKASSA_ENABLED"]="yookasa_enabled"
    ["YOOKASSA_SHOP_ID"]="yookasa_shop_id"
    ["YOOKASSA_SECRET_KEY"]="yookasa_secret_key"
    ["YOOKASSA_RETURN_URL"]="payment_return_url"
    ["YOOKASSA_PAYMENT_MODE"]="yookassa_payment_mode"
    ["YOOKASSA_PAYMENT_METHODS"]="yookassa_payment_methods"
    
    # === CryptoBot ‚Üí CryptoPay ===
    ["CRYPTOBOT_ENABLED"]="crypto_pay_enabled"
    ["CRYPTOBOT_TOKEN"]="crypto_pay_token"
    
    # === Telegram Stars ===
    ["TELEGRAM_STARS_ENABLED"]="telegram_stars_enabled"
    ["STARS_EXCHANGE_RATE"]="stars_exchange_rate"
    ["STARS_REQUIRE_PAID_PURCHASE"]="require_paid_purchase_for_stars"
    
    # === Tribute ===
    ["TRIBUTE_ENABLED"]="tribute_enabled"
    ["TRIBUTE_API_KEY"]="tribute_api_key"
    ["TRIBUTE_PAYMENT_URL"]="tribute_payment_url"
    ["TRIBUTE_WEBHOOK_URL"]="tribute_webhook_url"
    
    # === Platega ===
    ["PLATEGA_ENABLED"]="platega_cards_enabled"
    ["PLATEGA_MERCHANT_ID"]="platega_merchant_id"
    ["PLATEGA_SECRET_KEY"]="platega_secret"
    
    # === Trial ===
    ["TRIAL_ENABLED"]="trial_enabled"
    ["TRIAL_DAYS"]="trial_days"
    ["TRIAL_TRAFFIC_LIMIT_GB"]="trial_traffic_limit"
    ["TRIAL_DEVICE_LIMIT"]="trial_device_limit"
    ["TRIAL_SERVER_TAG"]="trial_remnawave_tag"
    
    # === Referral ===
    ["REFERRAL_ENABLED"]="referral_enabled"
    ["REFERRAL_BONUS_DAYS"]="referral_bonus_days"
    ["REFERRAL_REFEREE_BONUS_DAYS"]="referral_referee_bonus_days"
    ["REFERRAL_COMMISSION_PERCENT"]="referral_recurring_percent"
    ["REFERRAL_TIERS_ENABLED"]="referral_tiers_enabled"
    ["REFERRAL_TIER_1_THRESHOLD"]="referral_tier1_threshold"
    ["REFERRAL_TIER_1_BONUS"]="referral_tier1_bonus"
    ["REFERRAL_TIER_2_THRESHOLD"]="referral_tier2_threshold"
    ["REFERRAL_TIER_2_BONUS"]="referral_tier2_bonus"
    ["REFERRAL_TIER_3_THRESHOLD"]="referral_tier3_threshold"
    ["REFERRAL_TIER_3_BONUS"]="referral_tier3_bonus"
    ["REFERRAL_RECURRING_ENABLED"]="referral_recurring_enabled"
    ["REFERRAL_RECURRING_PERCENT"]="referral_recurring_percent"
    
    # === UI/Branding ===
    ["BRAND_PRIMARY_COLOR"]="brand_primary_color"
    ["BRAND_TEXT_COLOR"]="brand_text_color"
    ["BRAND_SUCCESS_COLOR"]="brand_success_color"
    ["BRAND_WARNING_COLOR"]="brand_warning_color"
    ["BRAND_ERROR_COLOR"]="brand_error_color"
    ["EFFECT_SNOWFALL"]="effect_snowfall"
    ["EFFECT_SNOWFALL_VARIANT"]="effect_snowfall_variant"
    ["EFFECT_HALLOWEEN"]="effect_halloween"
    ["EFFECT_SAKURA"]="effect_sakura"
    
    # === Menu/Buttons ===
    ["MENU_BUTTONS_LAYOUT"]="menu_buttons_layout"
    ["MENU_BUTTON_CONNECT_ENABLED"]="menu_button_connect_enabled"
    ["MENU_BUTTON_REFERRAL_ENABLED"]="menu_button_referral_enabled"
    ["MENU_BUTTON_PARTNER_ENABLED"]="menu_button_partner_enabled"
    
    # === URLs ===
    ["SERVER_STATUS_URL"]="server_status_url"
    ["SERVER_STATUS_ENABLED"]="server_status_enabled"
    ["SUPPORT_URL"]="support_url"
    ["FEEDBACK_URL"]="feedback_url"
    ["CHANNEL_URL"]="channel_url"
    ["TOS_URL"]="tos_url"
    
    # === MiniApp ===
    ["MINIAPP_ENABLED"]="mini_app_enabled"
    ["MINIAPP_URL"]="mini_app_url"
    ["WEBAPP_MODE"]="web_app_mode"
    
    # === Recurring/Autopay ===
    ["AUTOPAY_ENABLED"]="recurring_payments_enabled"
    ["AUTOPAY_REMINDER_DAYS"]="recurring_notify_days_before"
)

# --- –§—É–Ω–∫—Ü–∏—è: –ß—Ç–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –≤ –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω—ã–π –º–∞—Å—Å–∏–≤ ---
read_env_file() {
    local env_file="$1"
    local -n result_map=$2
    
    if [[ ! -f "$env_file" ]]; then
        debug_log "MIGRATE" "ENV file not found: $env_file"
        return 1
    fi
    
    while IFS= read -r line || [[ -n "$line" ]]; do
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        [[ "$line" =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line// }" ]] && continue
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º KEY=VALUE
        if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)=(.*)$ ]]; then
            local key="${BASH_REMATCH[1]}"
            local value="${BASH_REMATCH[2]}"
            
            # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            value="${value#\"}"
            value="${value%\"}"
            value="${value#\'}"
            value="${value%\'}"
            
            result_map["$key"]="$value"
        fi
    done < "$env_file"
    
    debug_log "MIGRATE" "Read ${#result_map[@]} variables from $env_file"
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ó–∞–ø–∏—Å—å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ .env —Ñ–∞–π–ª ---
write_env_variable() {
    local env_file="$1"
    local key="$2"
    local value="$3"
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è sed
    local escaped_value="${value//\\/\\\\}"
    escaped_value="${escaped_value//&/\\&}"
    
    if grep -q "^${key}=" "$env_file" 2>/dev/null; then
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        sed -i "s|^${key}=.*|${key}=\"${escaped_value}\"|" "$env_file"
    else
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
        echo "${key}=\"${value}\"" >> "$env_file"
    fi
}

# --- –§—É–Ω–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É—Ç–µ–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
migrate_settings_configure_paths() {
    clear_screen
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –î–õ–Ø –ú–ò–ì–†–ê–¶–ò–ò –ù–ê–°–¢–†–û–ï–ö ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    
    # === –ò—Å—Ç–æ—á–Ω–∏–∫ (Bedolaga .env) ===
    echo -e "${YELLOW}=== –ò–°–¢–û–ß–ù–ò–ö (Bedolaga) ===${RESET}"
    
    # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    local found_bedolaga=""
    for path in "/opt/bedolaga-bot" "/opt/shop-bot" "/opt/telegram-shop-bot" "/root/bedolaga-bot"; do
        if [[ -f "$path/.env" ]]; then
            found_bedolaga="$path/.env"
            break
        fi
    done
    
    if [[ -n "$found_bedolaga" ]]; then
        echo -e "–ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª: ${GREEN}$found_bedolaga${RESET}"
        read -erp "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ? (Y/n): " use_found
        if [[ ! "$use_found" =~ ^[Nn]$ ]]; then
            MIGRATION_SOURCE_ENV_FILE="$found_bedolaga"
        fi
    fi
    
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        read -erp "–ü—É—Ç—å –∫ .env —Ñ–∞–π–ª—É Bedolaga: " MIGRATION_SOURCE_ENV_FILE
    fi
    
    if [[ ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $MIGRATION_SOURCE_ENV_FILE"
        read -erp "Enter..." dummy
        return 1
    fi
    
    echo ""
    
    # === –ü—Ä–∏—ë–º–Ω–∏–∫ (RWP-Shop) ===
    echo -e "${YELLOW}=== –ü–†–ò–Å–ú–ù–ò–ö (RWP-Shop) ===${RESET}"
    
    # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    local found_rwp=""
    for path in "/opt/private-remnawave-telegram-shop-bot" "/opt/rwp-shop" "/opt/telegram-shop"; do
        if [[ -f "$path/.env" ]]; then
            found_rwp="$path"
            break
        fi
    done
    
    if [[ -n "$found_rwp" ]]; then
        echo -e "–ù–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞: ${GREEN}$found_rwp${RESET}"
        read -erp "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë? (Y/n): " use_found
        if [[ ! "$use_found" =~ ^[Nn]$ ]]; then
            MIGRATION_TARGET_BOT_PATH="$found_rwp"
            MIGRATION_TARGET_ENV_FILE="$found_rwp/.env"
        fi
    fi
    
    if [[ -z "$MIGRATION_TARGET_BOT_PATH" ]]; then
        read -erp "–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ RWP-Shop –±–æ—Ç–∞: " MIGRATION_TARGET_BOT_PATH
        MIGRATION_TARGET_ENV_FILE="$MIGRATION_TARGET_BOT_PATH/.env"
    fi
    
    if [[ ! -f "$MIGRATION_TARGET_ENV_FILE" ]]; then
        print_message "WARN" "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $MIGRATION_TARGET_BOT_PATH"
        read -erp "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π .env —Ñ–∞–π–ª? (y/N): " create_new
        if [[ "$create_new" =~ ^[Yy]$ ]]; then
            touch "$MIGRATION_TARGET_ENV_FILE"
            chmod 600 "$MIGRATION_TARGET_ENV_FILE"
            print_message "SUCCESS" "–°–æ–∑–¥–∞–Ω: $MIGRATION_TARGET_ENV_FILE"
        else
            return 1
        fi
    fi
    
    print_message "SUCCESS" "–ü—É—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
    echo ""
    echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫: ${GREEN}$MIGRATION_SOURCE_ENV_FILE${RESET}"
    echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ .env: ${GREEN}$MIGRATION_TARGET_ENV_FILE${RESET}"
    echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ –ë–î: ${GREEN}$MIGRATION_TARGET_CONTAINER${RESET}"
    
    read -erp "Enter..." dummy
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ ---
migrate_settings_analyze() {
    debug_log "MIGRATE" "Analyzing settings for migration"
    
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        return 1
    fi
    
    # –ß–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π .env
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    local total_source=${#source_settings[@]}
    local can_migrate_env=0
    local can_migrate_db=0
    local no_mapping=0
    
    # –ü–æ–¥—Å—á—ë—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å –º–∞–ø–ø–∏–Ω–≥–æ–º
    for key in "${!source_settings[@]}"; do
        if [[ -n "${SETTINGS_ENV_TO_ENV[$key]}" ]]; then
            ((can_migrate_env++))
        elif [[ -n "${SETTINGS_ENV_TO_DB[$key]}" ]]; then
            ((can_migrate_db++))
        else
            ((no_mapping++))
        fi
    done
    
    echo ""
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ê–ù–ê–õ–ò–ó –ù–ê–°–¢–†–û–ï–ö ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫: ${GREEN}$MIGRATION_SOURCE_ENV_FILE${RESET}"
    echo ""
    echo "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    printf "‚îÇ %-43s %10s ‚îÇ\n" "–ù–∞–π–¥–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ Bedolaga:" "$total_source"
    printf "‚îÇ %-43s %10s ‚îÇ\n" "–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ .env:" "$can_migrate_env"
    printf "‚îÇ %-43s %10s ‚îÇ\n" "–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ settings DB:" "$can_migrate_db"
    printf "‚îÇ %-43s %10s ‚îÇ\n" "–ë–µ–∑ –∞–Ω–∞–ª–æ–≥–∞ (–Ω–µ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è):" "$no_mapping"
    echo "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
    
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞–ø–ø–∏–Ω–≥–∞ .env ‚Üí .env ---
migrate_settings_show_env_mapping() {
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        read -erp "Enter..." dummy
        return 1
    fi
    
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    clear_screen
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ú–ê–ü–ü–ò–ù–ì .env ‚Üí .env (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    printf "%-30s ‚îÇ %-30s ‚îÇ %s\n" "Bedolaga" "RWP-Shop" "–ó–Ω–∞—á–µ–Ω–∏–µ"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    for bedolaga_key in "${!SETTINGS_ENV_TO_ENV[@]}"; do
        local rwp_key="${SETTINGS_ENV_TO_ENV[$bedolaga_key]}"
        local value="${source_settings[$bedolaga_key]:-<–Ω–µ –∑–∞–¥–∞–Ω–æ>}"
        
        # –ú–∞—Å–∫–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if [[ "$bedolaga_key" =~ TOKEN|SECRET|PASSWORD|KEY ]]; then
            if [[ -n "${source_settings[$bedolaga_key]}" ]]; then
                local masked="${value:0:6}***${value: -3}"
                value="$masked"
            fi
        fi
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∑–Ω–∞—á–µ–Ω–∏—è
        [[ ${#value} -gt 25 ]] && value="${value:0:22}..."
        
        printf "%-30s ‚îÇ %-30s ‚îÇ %s\n" "$bedolaga_key" "$rwp_key" "$value"
    done
    
    echo ""
    read -erp "Enter..." dummy
}

# --- –§—É–Ω–∫—Ü–∏—è: –ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞–ø–ø–∏–Ω–≥–∞ .env ‚Üí settings DB ---
migrate_settings_show_db_mapping() {
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        read -erp "Enter..." dummy
        return 1
    fi
    
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    clear_screen
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ú–ê–ü–ü–ò–ù–ì .env ‚Üí settings DB ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    local categories=("Payment" "Trial" "Referral" "UI" "URLs" "Other")
    
    printf "%-35s ‚îÇ %-35s ‚îÇ %s\n" "Bedolaga .env" "RWP-Shop settings.key" "–ó–Ω–∞—á–µ–Ω–∏–µ"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    local count=0
    for bedolaga_key in "${!SETTINGS_ENV_TO_DB[@]}"; do
        local db_key="${SETTINGS_ENV_TO_DB[$bedolaga_key]}"
        local value="${source_settings[$bedolaga_key]:-<–Ω–µ –∑–∞–¥–∞–Ω–æ>}"
        
        # –ú–∞—Å–∫–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        if [[ "$bedolaga_key" =~ TOKEN|SECRET|PASSWORD|KEY ]]; then
            if [[ -n "${source_settings[$bedolaga_key]}" ]]; then
                local masked="${value:0:6}***${value: -3}"
                value="$masked"
            fi
        fi
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        [[ ${#value} -gt 20 ]] && value="${value:0:17}..."
        
        printf "%-35s ‚îÇ %-35s ‚îÇ %s\n" "$bedolaga_key" "$db_key" "$value"
        
        ((count++))
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 20 —Å—Ç—Ä–æ–∫
        if [[ $((count % 20)) -eq 0 ]]; then
            echo ""
            read -erp "-- –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è --" dummy
            echo ""
        fi
    done
    
    echo ""
    echo "–í—Å–µ–≥–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –ë–î: ${#SETTINGS_ENV_TO_DB[@]}"
    echo ""
    read -erp "Enter..." dummy
}

# --- –§—É–Ω–∫—Ü–∏—è: –ü—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –∞–Ω–∞–ª–æ–≥–∞ ---
migrate_settings_show_no_mapping() {
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        read -erp "Enter..." dummy
        return 1
    fi
    
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    clear_screen
    echo -e "${YELLOW}${BOLD}‚ïê‚ïê‚ïê –ù–ê–°–¢–†–û–ô–ö–ò –ë–ï–ó –ê–ù–ê–õ–û–ì–ê –í RWP-SHOP ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo "–≠—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ù–ï –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã (–Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–∞ –≤ RWP-Shop):"
    echo ""
    
    local count=0
    for key in "${!source_settings[@]}"; do
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –º–∞–ø–ø–∏–Ω–≥
        if [[ -z "${SETTINGS_ENV_TO_ENV[$key]}" && -z "${SETTINGS_ENV_TO_DB[$key]}" ]]; then
            local value="${source_settings[$key]}"
            
            # –ú–∞—Å–∫–∏—Ä—É–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            if [[ "$key" =~ TOKEN|SECRET|PASSWORD|KEY ]]; then
                [[ -n "$value" ]] && value="${value:0:6}***"
            fi
            
            [[ ${#value} -gt 40 ]] && value="${value:0:37}..."
            
            printf "  %-35s = %s\n" "$key" "$value"
            ((count++))
            
            # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            if [[ $((count % 25)) -eq 0 ]]; then
                echo ""
                read -erp "-- –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è --" dummy
                echo ""
            fi
        fi
    done | sort
    
    echo ""
    echo "–í—Å–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –∞–Ω–∞–ª–æ–≥–∞: $count"
    echo ""
    read -erp "Enter..." dummy
}

# --- –§—É–Ω–∫—Ü–∏—è: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
migrate_settings_execute() {
    debug_log "MIGRATE" "Starting settings migration"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        return 1
    fi
    
    if [[ -z "$MIGRATION_TARGET_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –ø—Ä–∏—ë–º–Ω–∏–∫—É .env –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        return 1
    fi
    
    if [[ -z "$MIGRATION_TARGET_CONTAINER" ]]; then
        print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–î RWP-Shop –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        return 1
    fi
    
    echo ""
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${RED}${BOLD}  ‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö!               ${RESET}"
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo "–ë—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã:"
    echo " ‚Ä¢ –§–∞–π–ª .env: $MIGRATION_TARGET_ENV_FILE"
    echo " ‚Ä¢ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $MIGRATION_TARGET_CONTAINER / $MIGRATION_TARGET_DB"
    echo ""
    echo -e "${YELLOW}–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º!${RESET}"
    echo ""
    read -erp "–í–≤–µ–¥–∏—Ç–µ 'SETTINGS' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm
    
    if [[ "$confirm" != "SETTINGS" ]]; then
        print_message "INFO" "–ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
        return 0
    fi
    
    # –ß–∏—Ç–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π .env
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    local work_dir="$MIGRATION_WORK_DIR"
    [[ -z "$work_dir" ]] && work_dir="${BACKUP_DIR}/migration_settings_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$work_dir"
    
    # –ë—ç–∫–∞–ø —Ü–µ–ª–µ–≤–æ–≥–æ .env
    if [[ -f "$MIGRATION_TARGET_ENV_FILE" ]]; then
        cp "$MIGRATION_TARGET_ENV_FILE" "$work_dir/target_env_backup.env"
        print_message "INFO" "–ë—ç–∫–∞–ø .env: $work_dir/target_env_backup.env"
    fi
    
    local env_migrated=0
    local db_migrated=0
    local errors=0
    
    # === –≠–¢–ê–ü 1: –ú–∏–≥—Ä–∞—Ü–∏—è .env ‚Üí .env ===
    print_message "INFO" "[1/2] –ú–∏–≥—Ä–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ .env..."
    
    for bedolaga_key in "${!SETTINGS_ENV_TO_ENV[@]}"; do
        local rwp_key="${SETTINGS_ENV_TO_ENV[$bedolaga_key]}"
        local value="${source_settings[$bedolaga_key]}"
        
        if [[ -n "$value" ]]; then
            write_env_variable "$MIGRATION_TARGET_ENV_FILE" "$rwp_key" "$value"
            debug_log "MIGRATE" "ENV: $bedolaga_key ‚Üí $rwp_key"
            ((env_migrated++))
        fi
    done
    
    print_message "SUCCESS" "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ .env: $env_migrated –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö"
    
    # === –≠–¢–ê–ü 2: –ú–∏–≥—Ä–∞—Ü–∏—è .env ‚Üí settings DB ===
    print_message "INFO" "[2/2] –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü—É settings..."
    
    local sql_file="$work_dir/settings_import.sql"
    echo "-- Settings migration: Bedolaga ‚Üí RWP-Shop" > "$sql_file"
    echo "-- Generated: $(date '+%Y-%m-%d %H:%M:%S')" >> "$sql_file"
    echo "" >> "$sql_file"
    
    for bedolaga_key in "${!SETTINGS_ENV_TO_DB[@]}"; do
        local db_key="${SETTINGS_ENV_TO_DB[$bedolaga_key]}"
        local value="${source_settings[$bedolaga_key]}"
        
        if [[ -n "$value" ]]; then
            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è SQL
            local escaped_value="${value//\'/\'\'}"
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –±—É–ª–µ–≤—ã –∑–Ω–∞—á–µ–Ω–∏—è
            if [[ "$value" =~ ^(true|false|True|False|TRUE|FALSE|1|0)$ ]]; then
                case "${value,,}" in
                    true|1) escaped_value="true" ;;
                    false|0) escaped_value="false" ;;
                esac
            fi
            
            echo "INSERT INTO settings (key, value, created_at, updated_at) VALUES ('$db_key', '$escaped_value', NOW(), NOW())" >> "$sql_file"
            echo "ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value, updated_at = NOW();" >> "$sql_file"
            
            debug_log "MIGRATE" "DB: $bedolaga_key ‚Üí $db_key = $value"
            ((db_migrated++))
        fi
    done
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º SQL
    docker cp "$sql_file" "${MIGRATION_TARGET_CONTAINER}:/tmp/settings_import.sql"
    
    local sql_result
    sql_result=$(docker exec "$MIGRATION_TARGET_CONTAINER" psql -U "$MIGRATION_TARGET_USER" -d "$MIGRATION_TARGET_DB" -f /tmp/settings_import.sql 2>&1)
    local sql_exit=$?
    
    docker exec "$MIGRATION_TARGET_CONTAINER" rm -f /tmp/settings_import.sql
    
    if [[ $sql_exit -ne 0 ]]; then
        print_message "ERROR" "–û—à–∏–±–∫–∞ SQL: $sql_result"
        ((errors++))
    else
        print_message "SUCCESS" "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ settings DB: $db_migrated –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    fi
    
    # === –û–¢–ß–Å–¢ ===
    local report_file="$work_dir/settings_migration_report.txt"
    {
        echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
        echo "‚ïë           –û–¢–ß–Å–¢ –ú–ò–ì–†–ê–¶–ò–ò –ù–ê–°–¢–†–û–ï–ö                              ‚ïë"
        echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        echo ""
        echo "–î–∞—Ç–∞: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        echo "–ò—Å—Ç–æ—á–Ω–∏–∫: $MIGRATION_SOURCE_ENV_FILE"
        echo "–ü—Ä–∏—ë–º–Ω–∏–∫ .env: $MIGRATION_TARGET_ENV_FILE"
        echo "–ü—Ä–∏—ë–º–Ω–∏–∫ –ë–î: $MIGRATION_TARGET_CONTAINER / $MIGRATION_TARGET_DB"
        echo ""
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ ==="
        echo "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ .env: $env_migrated"
        echo "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ settings DB: $db_migrated"
        echo "–û—à–∏–±–æ–∫: $errors"
        echo ""
        echo "=== –í–ê–ñ–ù–û ==="
        echo "1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ .env"
        echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å RWP-Shop –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ë–î"
        echo "3. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏"
        echo ""
        echo "=== –ù–ê–°–¢–†–û–ô–ö–ò –ë–ï–ó –ú–ò–ì–†–ê–¶–ò–ò ==="
        echo "–°–ª–µ–¥—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Bedolaga –Ω–µ –∏–º–µ—é—Ç –∞–Ω–∞–ª–æ–≥–æ–≤ –≤ RWP-Shop:"
        echo ""
        for key in "${!source_settings[@]}"; do
            if [[ -z "${SETTINGS_ENV_TO_ENV[$key]}" && -z "${SETTINGS_ENV_TO_DB[$key]}" ]]; then
                echo "  - $key"
            fi
        done | sort
    } > "$report_file"
    
    echo ""
    echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo -e "${GREEN}${BOLD}  ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö –ó–ê–í–ï–†–®–ï–ù–ê!                  ${RESET}"
    echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
    echo " ‚Ä¢ .env: $env_migrated –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö"
    echo " ‚Ä¢ settings DB: $db_migrated –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    echo " ‚Ä¢ –û—à–∏–±–æ–∫: $errors"
    echo ""
    echo "–û—Ç—á—ë—Ç: $report_file"
    echo ""
    
    if [[ $errors -eq 0 ]]; then
        print_message "WARN" "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π!"
        echo ""
        read -erp "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å–µ–π—á–∞—Å? (y/N): " restart_bot
        if [[ "$restart_bot" =~ ^[Yy]$ ]]; then
            if [[ -n "$MIGRATION_TARGET_BOT_PATH" && -f "$MIGRATION_TARGET_BOT_PATH/compose.yaml" ]]; then
                print_message "INFO" "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
                (cd "$MIGRATION_TARGET_BOT_PATH" && docker compose restart bot)
                print_message "SUCCESS" "–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
            else
                print_message "WARN" "–ü—É—Ç—å –∫ compose.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –≤—Ä—É—á–Ω—É—é."
            fi
        fi
    fi
    
    log_message "SUCCESS" "Settings migration completed: env=$env_migrated, db=$db_migrated, errors=$errors"
    
    read -erp "Enter..." dummy
    return 0
}

# --- –§—É–Ω–∫—Ü–∏—è: –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ CSV ---
migrate_settings_export_csv() {
    if [[ -z "$MIGRATION_SOURCE_ENV_FILE" || ! -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
        print_message "ERROR" "–ü—É—Ç—å –∫ –∏—Å—Ç–æ—á–Ω–∏–∫—É –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        read -erp "Enter..." dummy
        return 1
    fi
    
    declare -A source_settings
    read_env_file "$MIGRATION_SOURCE_ENV_FILE" source_settings
    
    local work_dir="${BACKUP_DIR}/settings_export_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$work_dir"
    
    local csv_file="$work_dir/bedolaga_settings.csv"
    
    echo "key,value,maps_to_env,maps_to_db,migration_status" > "$csv_file"
    
    for key in "${!source_settings[@]}"; do
        local value="${source_settings[$key]}"
        local env_target="${SETTINGS_ENV_TO_ENV[$key]:-}"
        local db_target="${SETTINGS_ENV_TO_DB[$key]:-}"
        local status="no_mapping"
        
        [[ -n "$env_target" ]] && status="env"
        [[ -n "$db_target" ]] && status="db"
        
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–ª—è CSV
        value="${value//\"/\"\"}"
        
        echo "\"$key\",\"$value\",\"$env_target\",\"$db_target\",\"$status\"" >> "$csv_file"
    done
    
    print_message "SUCCESS" "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: $csv_file"
    echo ""
    echo "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
    echo " ‚Ä¢ –í—Å–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${#source_settings[@]}"
    echo " ‚Ä¢ –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ .env: $(grep -c ',env$' "$csv_file")"
    echo " ‚Ä¢ –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ DB: $(grep -c ',db$' "$csv_file")"
    echo " ‚Ä¢ –ë–µ–∑ –º–∞–ø–ø–∏–Ω–≥–∞: $(grep -c ',no_mapping$' "$csv_file")"
    
    read -erp "Enter..." dummy
}

# --- –ú–µ–Ω—é –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ---
menu_migrate_settings() {
    while true; do
        clear_screen
        echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
        echo -e "${CYAN}${BOLD}            üîß –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö BEDOLAGA ‚Üí RWP-SHOP          ${RESET}"
        echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
        echo ""
        
        # –°—Ç–∞—Ç—É—Å –ø—É—Ç–µ–π
        echo -e "${YELLOW}=== –¢–ï–ö–£–©–ò–ï –ü–£–¢–ò ===${RESET}"
        if [[ -n "$MIGRATION_SOURCE_ENV_FILE" && -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
            echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫ .env: ${GREEN}$MIGRATION_SOURCE_ENV_FILE${RESET}"
        else
            echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫ .env: ${RED}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${RESET}"
        fi
        
        if [[ -n "$MIGRATION_TARGET_ENV_FILE" ]]; then
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ .env: ${GREEN}$MIGRATION_TARGET_ENV_FILE${RESET}"
        else
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ .env: ${RED}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${RESET}"
        fi
        
        if [[ -n "$MIGRATION_TARGET_CONTAINER" ]]; then
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ –ë–î: ${GREEN}$MIGRATION_TARGET_CONTAINER${RESET}"
        else
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫ –ë–î: ${RED}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${RESET}"
        fi
        echo ""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ—Å–ª–∏ –ø—É—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
        if [[ -n "$MIGRATION_SOURCE_ENV_FILE" && -f "$MIGRATION_SOURCE_ENV_FILE" ]]; then
            migrate_settings_analyze 2>/dev/null
        fi
        
        echo ""
        echo " [1] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç–∏ (.env —Ñ–∞–π–ª—ã)"
        echo " [2] –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞–ø–ø–∏–Ω–≥ .env ‚Üí .env"
        echo " [3] –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞–ø–ø–∏–Ω–≥ .env ‚Üí settings DB"
        echo " [4] –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ –∞–Ω–∞–ª–æ–≥–∞"
        echo -e " ${GREEN}[5] ‚ñ∂ –í–´–ü–û–õ–ù–ò–¢–¨ –ú–ò–ì–†–ê–¶–ò–Æ –ù–ê–°–¢–†–û–ï–ö${RESET}"
        echo " [6] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ CSV"
        echo ""
        echo " [0] ‚Üê –ù–∞–∑–∞–¥"
        echo ""
        read -erp "–í—ã–±–æ—Ä: " opt
        
        case "$opt" in
            1) migrate_settings_configure_paths ;;
            2) migrate_settings_show_env_mapping ;;
            3) migrate_settings_show_db_mapping ;;
            4) migrate_settings_show_no_mapping ;;
            5) migrate_settings_execute ;;
            6) migrate_settings_export_csv ;;
            0) return ;;
        esac
    done
}

# --- –§—É–Ω–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ ---
migrate_configure_source() {
    clear_screen
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ù–ê–°–¢–†–û–ô–ö–ê –ò–°–¢–û–ß–ù–ò–ö–ê (Bedolaga) ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    echo "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î Bedolaga:"
    echo " 1. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ)"
    echo " 2. –í–Ω–µ—à–Ω–∏–π PostgreSQL —Å–µ—Ä–≤–µ—Ä"
    echo " 0. –ù–∞–∑–∞–¥"
    echo ""
    read -erp "–í—ã–±–æ—Ä: " source_type
    
    case "$source_type" in
        1)
            echo ""
            echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            docker ps --format '{{.Names}}' | grep -iE 'postgres|db|bedolaga' | while read -r name; do
                echo "  - $name"
            done
            echo ""
            read -erp "–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î Bedolaga: " MIGRATION_SOURCE_CONTAINER
            read -erp "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [shop_bot]: " MIGRATION_SOURCE_DB
            MIGRATION_SOURCE_DB="${MIGRATION_SOURCE_DB:-shop_bot}"
            read -erp "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î [postgres]: " MIGRATION_SOURCE_USER
            MIGRATION_SOURCE_USER="${MIGRATION_SOURCE_USER:-postgres}"
            MIGRATION_SOURCE_HOST=""
            MIGRATION_SOURCE_PASS=""
            ;;
        2)
            echo ""
            read -erp "–•–æ—Å—Ç PostgreSQL: " MIGRATION_SOURCE_HOST
            read -erp "–ü–æ—Ä—Ç [5432]: " MIGRATION_SOURCE_PORT
            MIGRATION_SOURCE_PORT="${MIGRATION_SOURCE_PORT:-5432}"
            read -erp "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: " MIGRATION_SOURCE_DB
            read -erp "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " MIGRATION_SOURCE_USER
            read -serp "–ü–∞—Ä–æ–ª—å: " MIGRATION_SOURCE_PASS
            echo ""
            MIGRATION_SOURCE_CONTAINER=""
            ;;
        0) return ;;
    esac
    
    print_message "SUCCESS" "–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

# --- –§—É–Ω–∫—Ü–∏—è: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏—ë–º–Ω–∏–∫–∞ ---
migrate_configure_target() {
    clear_screen
    echo -e "${CYAN}${BOLD}‚ïê‚ïê‚ïê –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–Å–ú–ù–ò–ö–ê (RWP-Shop) ‚ïê‚ïê‚ïê${RESET}"
    echo ""
    
    # –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î Remnawave
    local detected_container=""
    for pattern in "rwp_shop_db" "telegram-shop-db" "remnawave.*db"; do
        detected_container=$(docker ps --format '{{.Names}}' | grep -iE "^$pattern$" | head -1)
        [[ -n "$detected_container" ]] && break
    done
    
    if [[ -n "$detected_container" ]]; then
        echo -e "–û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${GREEN}$detected_container${RESET}"
        read -erp "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ? (Y/n): " use_detected
        if [[ ! "$use_detected" =~ ^[Nn]$ ]]; then
            MIGRATION_TARGET_CONTAINER="$detected_container"
        fi
    fi
    
    if [[ -z "$MIGRATION_TARGET_CONTAINER" ]]; then
        echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
        docker ps --format '{{.Names}}' | while read -r name; do
            echo "  - $name"
        done
        echo ""
        read -erp "–ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ë–î Remnawave: " MIGRATION_TARGET_CONTAINER
    fi
    
    read -erp "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö [postgres]: " MIGRATION_TARGET_DB
    MIGRATION_TARGET_DB="${MIGRATION_TARGET_DB:-postgres}"
    read -erp "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î [postgres]: " MIGRATION_TARGET_USER
    MIGRATION_TARGET_USER="${MIGRATION_TARGET_USER:-postgres}"
    
    print_message "SUCCESS" "–ü—Ä–∏—ë–º–Ω–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
}

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–∏–≥—Ä–∞—Ü–∏–∏ ---
menu_migration() {
    MIGRATION_WORK_DIR="${BACKUP_DIR}/migration_$(date +%Y%m%d_%H%M%S)"
    
    while true; do
        clear_screen
        echo -e "${MAGENTA}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
        echo -e "${MAGENTA}${BOLD}  –ú–ò–ì–†–ê–¶–ò–Ø: Bedolaga ‚Üí RWP-Shop (Private)   ${RESET}"
        echo -e "${MAGENTA}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
        echo ""
        echo -e "${YELLOW}–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏!${RESET}"
        echo -e "${YELLOW}–ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –æ–±–µ–∏—Ö –ë–î!${RESET}"
        echo ""
        
        # –°—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        echo -e "${CYAN}=== –¢–ï–ö–£–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò ===${RESET}"
        if [[ -n "$MIGRATION_SOURCE_CONTAINER" ]]; then
            echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫: ${GREEN}Docker: $MIGRATION_SOURCE_CONTAINER${RESET} (DB: $MIGRATION_SOURCE_DB)"
        elif [[ -n "$MIGRATION_SOURCE_HOST" ]]; then
            echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫: ${GREEN}$MIGRATION_SOURCE_HOST:$MIGRATION_SOURCE_PORT${RESET} (DB: $MIGRATION_SOURCE_DB)"
        else
            echo -e "–ò—Å—Ç–æ—á–Ω–∏–∫: ${RED}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${RESET}"
        fi
        
        if [[ -n "$MIGRATION_TARGET_CONTAINER" ]]; then
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫: ${GREEN}Docker: $MIGRATION_TARGET_CONTAINER${RESET} (DB: $MIGRATION_TARGET_DB)"
        else
            echo -e "–ü—Ä–∏—ë–º–Ω–∏–∫: ${RED}–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${RESET}"
        fi
        echo ""
        
        echo " --- –ù–ê–°–¢–†–û–ô–ö–ê ---"
        echo " 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ (Bedolaga)"
        echo " 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏—ë–º–Ω–∏–∫ (RWP-Shop)"
        echo ""
        echo " --- –î–ï–ô–°–¢–í–ò–Ø ---"
        echo " 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        echo " 4. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏—Å—Ç–æ—á–Ω–∏–∫–∞"
        echo ""
        echo " --- –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---"
        echo -e " ${GREEN}5. üöÄ –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–û–õ–ù–£–Æ –ú–ò–ì–†–ê–¶–ò–Æ –î–ê–ù–ù–´–•${RESET}"
        echo ""
        echo " --- –†–£–ß–ù–´–ï –≠–¢–ê–ü–´ ---"
        echo " 6. –¢–æ–ª—å–∫–æ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
        echo " 7. –¢–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è"
        echo " 8. –¢–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç"
        echo -e " 9. ${YELLOW}–ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π${RESET}"
        echo ""
        echo " --- –ù–ê–°–¢–†–û–ô–ö–ò ---"
        echo -e " ${CYAN}10. üîß –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö (.env ‚Üí .env + DB)${RESET}"
        echo ""
        echo " 0. –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
        echo ""
        read -erp "–í—ã–±–æ—Ä: " opt
        
        case "$opt" in
            1) migrate_configure_source ;;
            2) migrate_configure_target ;;
            3)
                echo ""
                if [[ -n "$MIGRATION_SOURCE_CONTAINER" || -n "$MIGRATION_SOURCE_HOST" ]]; then
                    migrate_analyze_source && print_message "SUCCESS" "–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω"
                else
                    print_message "ERROR" "–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
                fi
                
                if [[ -n "$MIGRATION_TARGET_CONTAINER" ]]; then
                    if docker ps --format '{{.Names}}' | grep -q "^${MIGRATION_TARGET_CONTAINER}$"; then
                        print_message "SUCCESS" "–ü—Ä–∏—ë–º–Ω–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω"
                    else
                        print_message "ERROR" "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏—ë–º–Ω–∏–∫–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω"
                    fi
                else
                    print_message "ERROR" "–ü—Ä–∏—ë–º–Ω–∏–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
                fi
                read -erp "Enter..." dummy
                ;;
            4)
                migrate_check_compatibility
                read -erp "Enter..." dummy
                ;;
            5)
                # –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
                echo ""
                echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
                echo -e "${RED}${BOLD}  ‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –ü–û–õ–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–•!           ${RESET}"
                echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
                echo ""
                echo "–ë—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã:"
                echo " ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (users ‚Üí customer)"
                echo " ‚Ä¢ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (transactions ‚Üí purchase)"
                echo " ‚Ä¢ –ü—Ä–æ–º–æ–∫–æ–¥—ã (promocodes ‚Üí promo)"
                echo ""
                echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–¥–µ–ª–∞–ª–∏ –±—ç–∫–∞–ø –æ–±–µ–∏—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö!${RESET}"
                echo ""
                read -erp "–í–≤–µ–¥–∏—Ç–µ 'MIGRATE' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirm
                
                if [[ "$confirm" == "MIGRATE" ]]; then
                    mkdir -p "$MIGRATION_WORK_DIR"
                    echo ""
                    
                    # –≠—Ç–∞–ø 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    print_message "INFO" "[1/7] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏..."
                    if ! migrate_check_compatibility; then
                        print_message "ERROR" "–ò—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–æ–≤
                    print_message "INFO" "[2/7] –ê–Ω–∞–ª–∏–∑ –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                    if ! migrate_handle_balances; then
                        print_message "ERROR" "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –±–∞–ª–∞–Ω—Å–æ–≤!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 3: –≠–∫—Å–ø–æ—Ä—Ç
                    print_message "INFO" "[3/7] –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö..."
                    if ! migrate_export_data; then
                        print_message "ERROR" "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 4: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è
                    print_message "INFO" "[4/7] –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö..."
                    if ! migrate_transform_data; then
                        print_message "ERROR" "–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 5: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤
                    print_message "INFO" "[5/7] –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–ª–∞–Ω—Å–æ–≤..."
                    if ! migrate_apply_balance_handling; then
                        print_message "ERROR" "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–∞–ª–∞–Ω—Å–æ–≤!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 6: –ò–º–ø–æ—Ä—Ç
                    print_message "INFO" "[6/7] –ò–º–ø–æ—Ä—Ç –≤ RWP-Shop..."
                    if ! migrate_import_data; then
                        print_message "ERROR" "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞!"
                        read -erp "Enter..." dummy
                        continue
                    fi
                    
                    # –≠—Ç–∞–ø 7: –û—Ç—á—ë—Ç
                    print_message "INFO" "[7/7] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞..."
                    migrate_generate_report
                    
                    echo ""
                    print_message "SUCCESS" "‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
                    echo ""
                    log_message "SUCCESS" "Migration completed: Bedolaga ‚Üí RWP-Shop"
                else
                    print_message "INFO" "–ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
                fi
                read -erp "Enter..." dummy
                ;;
            6)
                mkdir -p "$MIGRATION_WORK_DIR"
                migrate_export_data
                read -erp "Enter..." dummy
                ;;
            7)
                migrate_transform_data
                read -erp "Enter..." dummy
                ;;
            8)
                migrate_import_data
                read -erp "Enter..." dummy
                ;;
            9)
                mkdir -p "$MIGRATION_WORK_DIR"
                if [[ -z "$MIGRATION_SOURCE_CONTAINER" && -z "$MIGRATION_SOURCE_HOST" ]]; then
                    print_message "ERROR" "–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ (–ø—É–Ω–∫—Ç 1)"
                else
                    migrate_handle_balances
                    [[ -n "$BALANCE_HANDLING_MODE" && "$BALANCE_HANDLING_MODE" != "none" ]] && migrate_apply_balance_handling
                fi
                read -erp "Enter..." dummy
                ;;
            10) menu_migrate_settings ;;
            0) return ;;
        esac
    done
}

cleanup_old_backups() {
    clear_screen; echo -e "${RED}–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤${RESET}"
    
    local del_full=0; local del_db=0; local del_files=0
    local size_exceeded=false

    echo -e "–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –æ—á–∏—Å—Ç–∫–∏: ${YELLOW}$DELETE_MODE${RESET}"
    if [[ "$DELETE_MODE" == "count" ]]; then
        echo "–õ–∏–º–∏—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è: $MAX_BACKUPS_COUNT —à—Ç."
    else
        echo -e "–°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: ${YELLOW}$RETENTION_DAYS –¥–Ω–µ–π${RESET}"
    fi
    echo -e "–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞: ${YELLOW}$(format_size_mb "$MAX_BACKUP_SIZE_MB")${RESET}"
    echo ""
    
    if [[ "$DELETE_MODE" == "count" ]]; then
        del_full=$(rotate_backups_by_count "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã" "false" | tail -n1)
        del_db=$(rotate_backups_by_count "lazarus_db" "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" "false" | tail -n1)
        del_files=$(rotate_backups_by_count "lazarus_files" "–ê—Ä—Ö–∏–≤—ã —Ñ–∞–π–ª–æ–≤" "false" | tail -n1)
    else
        # time-based
        del_full=$(rotate_backups_by_age "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã" "$RETENTION_DAYS" "false" | tail -n1)
        del_db=$(rotate_backups_by_age "lazarus_db" "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" "$RETENTION_DAYS" "false" | tail -n1)
        del_files=$(rotate_backups_by_age "lazarus_files" "–ê—Ä—Ö–∏–≤—ã —Ñ–∞–π–ª–æ–≤" "$RETENTION_DAYS" "false" | tail -n1)
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å)
    if [[ -n "$MAX_BACKUP_SIZE_MB" && "$MAX_BACKUP_SIZE_MB" != "0" ]]; then
        local current_size_bytes=$(du -sb "$BACKUP_DIR" 2>/dev/null | awk '{print $1}')
        local limit_bytes=$((MAX_BACKUP_SIZE_MB * 1024 * 1024))
        if [[ $current_size_bytes -gt $limit_bytes ]]; then
            size_exceeded=true
            rotate_backups_by_size "false"  # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è
        else
            rotate_backups_by_size "false"  # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞
        fi
    fi

    echo ""
    # normalize empty to 0
    del_full=${del_full:-0}; del_db=${del_db:-0}; del_files=${del_files:-0}
    local total_del=$((del_full + del_db + del_files))

    if [[ "$total_del" -eq 0 && "$size_exceeded" != "true" ]]; then
        print_message "SUCCESS" "–ß–∏—Å—Ç–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –í—Å–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞."
        read -erp "Enter..." dummy
        return
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
        print_message "WARN" "[DRY-RUN] –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ: $total_del"
    else
        if [[ "$size_exceeded" == "true" ]]; then
            print_message "WARN" "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞! –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
        fi
        if [[ "$total_del" -gt 0 ]]; then
            print_message "WARN" "–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤: $total_del"
        fi
    fi
    # support non-interactive auto-confirm
    if [[ "$AUTO_CONFIRM" == "true" ]]; then
        confirm="y"
    else
        read -erp "–£–¥–∞–ª–∏—Ç—å —ç—Ç–∏ —Ñ–∞–π–ª—ã? (y/N): " confirm
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
        # In dry-run we never delete
        log_message "INFO" "[DRY_RUN] Cleanup preview (mode=$DELETE_MODE, retention_days=$RETENTION_DAYS, max_count=$MAX_BACKUPS_COUNT, candidates=$total_del)"
        if [[ "$REPORT_TO_TG" == "true" && "$SEND_TO_TELEGRAM" == "true" ]]; then
            send_telegram_text "$(escape_markdown_v2 "üßπ DRY-RUN –æ—á–∏—Å—Ç–∫–∞: –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤=$total_del, mode=$DELETE_MODE")"
        fi
        read -erp "Enter..." dummy
        return
    fi

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo ""
        if [[ "$DELETE_MODE" == "count" ]]; then
            rotate_backups_by_count "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã" "true" > "$SILENT_LOG"
            rotate_backups_by_count "lazarus_db" "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" "true" > "$SILENT_LOG"
            rotate_backups_by_count "lazarus_files" "–ê—Ä—Ö–∏–≤—ã —Ñ–∞–π–ª–æ–≤" "true" > "$SILENT_LOG"
        else
            rotate_backups_by_age "lazarus_full" "–ü–æ–ª–Ω—ã–µ –±—ç–∫–∞–ø—ã" "$RETENTION_DAYS" "true" > "$SILENT_LOG"
            rotate_backups_by_age "lazarus_db" "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö" "$RETENTION_DAYS" "true" > "$SILENT_LOG"
            rotate_backups_by_age "lazarus_files" "–ê—Ä—Ö–∏–≤—ã —Ñ–∞–π–ª–æ–≤" "$RETENTION_DAYS" "true" > "$SILENT_LOG"
        fi
        # –¢–∞–∫–∂–µ –æ—á–∏—Å—Ç–∫–∞ –ø–æ –ª–∏–º–∏—Ç—É —Ä–∞–∑–º–µ—Ä–∞
        if [[ "$size_exceeded" == "true" ]]; then
            rotate_backups_by_size "true"
        fi
        echo ""; print_message "SUCCESS" "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
        log_message "INFO" "Cleanup completed (mode=$DELETE_MODE, retention_days=$RETENTION_DAYS, max_count=$MAX_BACKUPS_COUNT, deleted=$total_del)"
        if [[ "$REPORT_TO_TG" == "true" && "$SEND_TO_TELEGRAM" == "true" ]]; then
            send_telegram_text "$(escape_markdown_v2 "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: —É–¥–∞–ª–µ–Ω–æ=$total_del, mode=$DELETE_MODE")"
        fi
    else
        echo ""; print_message "INFO" "–û—Ç–º–µ–Ω–µ–Ω–æ."
    fi
    read -erp "Enter..." dummy
}

# --- MAIN LOOP ---
rotate_internal_log
check_dependencies
install_script
load_or_create_config
check_config_mismatch # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
# --- Global CLI flags parsing ---
# Support calling like: lazarus --yes --dry-run cleanup
DRY_RUN="false"
REPORT_TO_TG="false"

# Build new argv stripping known global flags
_NEWARGS=()
for _a in "$@"; do
    case "$_a" in
        --yes|-y) AUTO_CONFIRM="true" ;;
        --dry-run|-n) DRY_RUN="true" ;;
        --report-tg) REPORT_TO_TG="true" ;;
        --debug|-d) DEBUG_MODE=true ;;
        *) _NEWARGS+=("$_a") ;;
    esac
done
set -- "${_NEWARGS[@]}"

# Debug mode banner
if [[ "$DEBUG_MODE" == true ]]; then
    SILENT_LOG="/dev/stderr"
    CURL_SILENT="-v"
    WGET_SILENT=""
    echo -e "${MAGENTA}${BOLD}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${RESET}"
    echo -e "${MAGENTA}${BOLD}‚ïë                    DEBUG MODE ENABLED                          ‚ïë${RESET}"
    echo -e "${MAGENTA}${BOLD}‚ïë  All operations will be logged in detail to console           ‚ïë${RESET}"
    echo -e "${MAGENTA}${BOLD}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${RESET}"
    echo ""
    echo -e "${CYAN}=== SYSTEM INFO ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} LAZARUS Version: $VERSION"
    echo -e "${MAGENTA}[DEBUG]${RESET} Bash Version: $BASH_VERSION"
    echo -e "${MAGENTA}[DEBUG]${RESET} User: $(whoami) (UID: $EUID)"
    echo -e "${MAGENTA}[DEBUG]${RESET} Hostname: $(hostname)"
    echo -e "${MAGENTA}[DEBUG]${RESET} Date: $(date '+%Y-%m-%d %H:%M:%S %Z')"
    echo ""
    echo -e "${CYAN}=== CONFIG ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Config file: $CONFIG_FILE"
    echo -e "${MAGENTA}[DEBUG]${RESET} Install dir: $INSTALL_DIR"
    echo -e "${MAGENTA}[DEBUG]${RESET} Backup dir: $BACKUP_DIR"
    echo -e "${MAGENTA}[DEBUG]${RESET} Log file: $LOG_FILE"
    echo ""
    echo -e "${CYAN}=== BOT CONFIG ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Bot path: ${BOT_PATH:-<not set>}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Bot container: ${BOT_CONTAINER_NAME:-<not set>}"
    echo -e "${MAGENTA}[DEBUG]${RESET} DB container: ${DB_CONTAINER_NAME:-<not set>}"
    echo -e "${MAGENTA}[DEBUG]${RESET} DB user: ${DB_USER:-postgres}"
    echo ""
    echo -e "${CYAN}=== TELEGRAM ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Notifications: $SEND_TO_TELEGRAM"
    echo -e "${MAGENTA}[DEBUG]${RESET} Send file: $TG_SEND_FILE"
    # –ú–∞—Å–∫–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–∏–º–≤–æ–ª–∞
    _masked_token="<not set>"
    if [[ -n "$BOT_TOKEN" ]]; then
        if [[ ${#BOT_TOKEN} -gt 10 ]]; then
            _masked_token="${BOT_TOKEN:0:4}****${BOT_TOKEN: -4}"
        else
            _masked_token="<set>"
        fi
    fi
    echo -e "${MAGENTA}[DEBUG]${RESET} Bot token: $_masked_token"
    # –ú–∞—Å–∫–∏—Ä—É–µ–º Chat ID: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 4 –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–∏–º–≤–æ–ª–∞
    _masked_chat="<not set>"
    if [[ -n "$CHAT_ID" ]]; then
        if [[ ${#CHAT_ID} -gt 8 ]]; then
            _masked_chat="${CHAT_ID:0:4}***${CHAT_ID: -3}"
        else
            _masked_chat="<set>"
        fi
    fi
    echo -e "${MAGENTA}[DEBUG]${RESET} Chat ID: $_masked_chat"
    echo -e "${MAGENTA}[DEBUG]${RESET} Thread ID: ${TG_MESSAGE_THREAD_ID:-<not set>}"
    echo ""
    echo -e "${CYAN}=== REMOTE STORAGE ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Type: $REMOTE_STORAGE_TYPE"
    echo -e "${MAGENTA}[DEBUG]${RESET} Enabled: $SEND_TO_REMOTE"
    # –ú–∞—Å–∫–∏—Ä—É–µ–º URL: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –¥–æ–º–µ–Ω
    _masked_url="<not set>"
    if [[ -n "$REMOTE_STORAGE_URL" ]]; then
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Ö–æ—Å—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –ø—É—Ç—å –∏ –∫—Ä–µ–¥—ã
        _url_proto=$(echo "$REMOTE_STORAGE_URL" | grep -oP '^[a-z]+://' || echo "")
        _url_host=$(echo "$REMOTE_STORAGE_URL" | sed -E 's|^[a-z]+://([^@]*@)?([^/]+).*|\2|')
        if [[ -n "$_url_host" ]]; then
            _masked_url="${_url_proto}${_url_host}/***"
        else
            _masked_url="<set>"
        fi
    fi
    echo -e "${MAGENTA}[DEBUG]${RESET} URL: $_masked_url"
    echo ""
    echo -e "${CYAN}=== ROTATION ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Delete mode: $DELETE_MODE"
    echo -e "${MAGENTA}[DEBUG]${RESET} Retention days: $RETENTION_DAYS"
    echo -e "${MAGENTA}[DEBUG]${RESET} Max backups: $MAX_BACKUPS_COUNT"
    echo ""
    echo -e "${CYAN}=== ENCRYPTION ===${RESET}"
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–∞—Ä–æ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±–µ–∑ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
    _masked_pass="<not set>"
    [[ -n "$BACKUP_PASSWORD" ]] && _masked_pass="<set> (${#BACKUP_PASSWORD} chars)"
    echo -e "${MAGENTA}[DEBUG]${RESET} Password: $_masked_pass"
    echo ""
    echo -e "${CYAN}=== EXCLUSIONS ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Exclude dirs: ${EXCLUDE_DIRS:-<none>}"
    echo -e "${MAGENTA}[DEBUG]${RESET} Max file size: ${MAX_FILE_SIZE_MB} MB"
    echo ""
    echo -e "${CYAN}=== DEBUG OUTPUT SETTINGS ===${RESET}"
    echo -e "${MAGENTA}[DEBUG]${RESET} SILENT_LOG: $SILENT_LOG"
    echo -e "${MAGENTA}[DEBUG]${RESET} CURL_SILENT: $CURL_SILENT"
    echo -e "${MAGENTA}[DEBUG]${RESET} IS_INTERACTIVE: $IS_INTERACTIVE"
    echo ""
    echo -e "${MAGENTA}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
    echo ""
fi

case "$1" in
    backup_full) create_backup "full" ;;
    backup_db)   create_backup "db_only" ;;
    backup_files) create_backup "files_only" ;;
    cleanup|cleanup_old_backups)
        cleanup_old_backups ;;
    restore) menu_restore ;;
    check_update) check_for_updates ;;
    *)
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è cron –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        check_cron_mismatch
        
        while true; do
            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–∑ cron
            CRON_STATUS_FULL=$(get_cron_status "full")
            CRON_STATUS_DB=$(get_cron_status "db")
            CRON_STATUS_FILES=$(get_cron_status "files")
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±—ç–∫–∞–ø–æ–≤
            get_backup_stats
            
            # –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ cron
            # Full –∏ DB ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–∫—Ä–∞—Å–Ω—ã–µ –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã –æ–±–∞), Files ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π (—Å–µ—Ä—ã–π –µ—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω)
            NO_CRITICAL_BACKUP=false
            [[ "$CRON_STATUS_FULL" == "–í—ã–∫–ª" && "$CRON_STATUS_DB" == "–í—ã–∫–ª" ]] && NO_CRITICAL_BACKUP=true
            
            COLOR_FULL="$GRAY"; [[ "$CRON_STATUS_FULL" != "–í—ã–∫–ª" ]] && COLOR_FULL="$YELLOW"
            COLOR_DB="$GRAY"; [[ "$CRON_STATUS_DB" != "–í—ã–∫–ª" ]] && COLOR_DB="$YELLOW"
            COLOR_FILES="$GRAY"; [[ "$CRON_STATUS_FILES" != "–í—ã–∫–ª" ]] && COLOR_FILES="$YELLOW"
            
            BOT_VERSION=$(get_bot_version_display)
            CONTAINER_STATUS=$(get_container_status)
            
            # –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            STATUS_COLOR="$GREEN"
            [[ "$CONTAINER_STATUS" != "Online" ]] && STATUS_COLOR="$RED"
            
            clear_screen
            echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
            echo -e "${GREEN}${BOLD}  LAZARUS Backup Manager v${VERSION}${RESET}"
            echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${RESET}"
            echo -e "–ë–æ—Ç: ${CYAN}${BOT_VERSION}${RESET} | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${STATUS_COLOR}${CONTAINER_STATUS}${RESET}"
            echo ""
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ç–∫–∞–ø–æ–≤
            echo -e "–ë—ç–∫–∞–ø—ã: ${STATS_FULL} Full | ${STATS_DB} DB | ${STATS_FILES} Files | ${BOLD}${STATS_SIZE}${RESET} –≤—Å–µ–≥–æ"
            if [[ -n "$STATS_LAST" ]]; then
                echo -e "–ü–æ—Å–ª–µ–¥–Ω–∏–π: ${STATS_LAST} (${STATS_LAST_AGO})"
            fi
            echo ""
            
            # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–≤—Ç–æ-–±—ç–∫–∞–ø–æ–≤
            if [[ "$NO_CRITICAL_BACKUP" == true ]]; then
                echo -e "${RED}${BOLD}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ê–≤—Ç–æ-–±—ç–∫–∞–ø –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!${RESET}"
                echo -e "${RED}   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å Full –∏–ª–∏ DB –±—ç–∫–∞–ø${RESET}"
                echo ""
            fi
            
            echo -e "–ê–≤—Ç–æ-–±—ç–∫–∞–ø (cron):"
            echo -e " ‚Ä¢ Full:  ${COLOR_FULL}${CRON_STATUS_FULL}${RESET}"
            echo -e " ‚Ä¢ DB:    ${COLOR_DB}${CRON_STATUS_DB}${RESET}"
            echo -e " ‚Ä¢ Files: ${COLOR_FILES}${CRON_STATUS_FILES}${RESET}"
            echo ""
            echo " --- –î–ï–ô–°–¢–í–ò–Ø ---"
            echo " 1. –†—É—á–Ω–æ–π –±–µ–∫–∞–ø (Full / DB / Files)"
            echo " 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ-–±–µ–∫–∞–ø"
            echo " 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞"
            echo " 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ü—É—Ç–∏ / –¢–æ–∫–µ–Ω—ã / –†–æ—Ç–∞—Ü–∏—è)"
            
            CLEANUP_LABEL=""
            if [[ "$DELETE_MODE" == "time" ]]; then
                CLEANUP_LABEL="(>$RETENTION_DAYS –¥–Ω–µ–π)"
            else
                CLEANUP_LABEL="(>$MAX_BACKUPS_COUNT —à—Ç.)"
            fi
            echo " 5. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã $CLEANUP_LABEL"
            echo -e " 6. ${CYAN}–û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞${RESET}"
            echo -e " 7. ${MAGENTA}–ú–∏–≥—Ä–∞—Ü–∏—è –º–µ–∂–¥—É –±–æ—Ç–∞–º–∏${RESET}"
            echo ""
            echo -e " 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞"
            echo -e "${RED} 666. –£–¥–∞–ª–∏—Ç—å —Å–∫—Ä–∏–ø—Ç (Uninstall)${RESET}"
            echo " 0. –í—ã—Ö–æ–¥"
            echo ""
            read -erp "–í—ã–±–æ—Ä (Enter - –≤—ã—Ö–æ–¥): " opt; [[ -z "$opt" ]] && exit 0
            case $opt in
                1) menu_manual_backup ;; 2) menu_automation ;; 3) menu_restore ;; 
                4) menu_settings ;; 5) cleanup_old_backups ;; 6) update_bot ;; 
                7) menu_migration ;; 8) check_for_updates ;; 666) uninstall_script ;; 0) exit 0 ;;
            esac
        done
        ;;
esac
